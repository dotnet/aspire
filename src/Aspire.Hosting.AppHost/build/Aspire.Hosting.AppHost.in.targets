<Project>

  <PropertyGroup>
    <!-- Similar to ASP.NET Core and Worker apps, set the default CWD of orchestrator projects to be the project directory. -->
    <RunWorkingDirectory Condition=" '$(RunWorkingDirectory)' == '' and '$(EnableDefaultRunWorkingDirectory)' != 'false' ">$(MSBuildProjectDirectory)</RunWorkingDirectory>
    <AspireGeneratedClassesVisibility Condition="'$(AspireGeneratedClassesVisibility)' == ''">public</AspireGeneratedClassesVisibility>
    <_AspireIntermediatePath>$(IntermediateOutputPath)Aspire\</_AspireIntermediatePath>
    <_GeneratedClassNameFixupRegex>(((?&lt;=\.)|^)(?=\d)|\W)</_GeneratedClassNameFixupRegex>
  </PropertyGroup>

  <ItemGroup>
    <ProjectCapability Include="Aspire" Condition=" '$(IsAspireHost)' == 'true' " />
    <ProjectCapability Include="Aspire_@VERSION@" Condition=" '$(IsAspireHost)' == 'true' " />
  </ItemGroup>

  <ItemGroup>
    <JsonSchemaSegment Include="$(MSBuildThisFileDirectory)..\AspireAppHostConfiguration.json"
                       FilePathPattern="appsettings\..*json" />
  </ItemGroup>

  <Target Name="_CreateAspireProjectResources">

    <ItemGroup>
      <_AspireProjectResource Include="@(ProjectReference->WithMetadataValue('IsAspireProjectResource', 'true'))" />
    </ItemGroup>

  </Target>

  <!-- Generate the data structures for doing the codegen for project resources -->
  <Target Name="CreateAspireProjectMetadataSources"
          DependsOnTargets="_CreateAspireProjectResources">
    <ItemGroup>
      <AspireProjectMetadataSource Include="@(_AspireProjectResource)" Condition="'@(_AspireProjectResource)' != ''">
        <ClassName Condition="%(_AspireProjectResource.AspireProjectMetadataTypeName) == ''">$([System.Text.RegularExpressions.Regex]::Replace($([System.IO.Path]::GetFileNameWithoutExtension(%(_AspireProjectResource.Identity))), $(_GeneratedClassNameFixupRegex), '_'))</ClassName>
        <ClassName Condition="%(_AspireProjectResource.AspireProjectMetadataTypeName) != ''">$([System.Text.RegularExpressions.Regex]::Replace(%(_AspireProjectResource.AspireProjectMetadataTypeName), $(_GeneratedClassNameFixupRegex), '_'))</ClassName>
        <ProjectPath>$([System.IO.Path]::GetFullPath(%(_AspireProjectResource.Identity)))</ProjectPath>
      </AspireProjectMetadataSource>
		</ItemGroup>
  </Target>

  <Target Name="_CSharpWriteProjectMetadataSources" DependsOnTargets="CreateAspireProjectMetadataSources" Condition="'$(Language)' == 'C#'">
    <ItemGroup>
      <AspireProjectMetadataSource Update="@(AspireProjectMetadataSource)">
        <Source>
        <![CDATA[// <auto-generated/>

namespace Projects%3B

[global::System.CodeDom.Compiler.GeneratedCode("Aspire.Hosting", null)]
[global::System.Diagnostics.CodeAnalysis.ExcludeFromCodeCoverage(Justification = "Generated code.")]
[global::System.Diagnostics.DebuggerDisplay("Type = {GetType().Name,nq}, ProjectPath = {ProjectPath}")]
]]>$(AspireGeneratedClassesVisibility)<![CDATA[ class ]]>%(ClassName)<![CDATA[ : global::Aspire.Hosting.IProjectMetadata
{
    public string ProjectPath => """]]>%(ProjectPath)<![CDATA["""%3B
}]]>
        </Source>
      </AspireProjectMetadataSource>
    </ItemGroup>

    <WriteLinesToFile File="$(_AspireIntermediatePath)references\%(AspireProjectMetadataSource.ClassName).ProjectMetadata.g.cs"
                      Overwrite="true"
                      Lines="%(AspireProjectMetadataSource.Source)"
                      Condition="%(AspireProjectMetadataSource.ClassName) != ''"
                      WriteOnlyWhenDifferent="true" />
    <ItemGroup>
      <FileWrites Include="$(_AspireIntermediatePath)references\%(AspireProjectMetadataSource.ClassName).ProjectMetadata.g.cs" />
      <Compile Include="$(_AspireIntermediatePath)references\%(AspireProjectMetadataSource.ClassName).ProjectMetadata.g.cs"
               Condition="%(AspireProjectMetadataSource.ClassName) != ''" />
    </ItemGroup>
  </Target>

  <Target Name="CreateAspireHostProjectMetadataSources">
    <ItemGroup>
      <AspireHostProjectMetadataSource Include="$(MSBuildProjectDirectory)">
        <ClassName>$([System.Text.RegularExpressions.Regex]::Replace($([System.IO.Path]::GetFileNameWithoutExtension($(MSBuildProjectFile))), $(_GeneratedClassNameFixupRegex), '_'))</ClassName>
        <ProjectPath>$(MSBuildProjectDirectory)</ProjectPath>
      </AspireHostProjectMetadataSource>
    </ItemGroup>
  </Target>

  <Target Name="_CSharpWriteHostProjectMetadataSources" DependsOnTargets="CreateAspireHostProjectMetadataSources" Condition="'$(Language)' == 'C#'">
    <ItemGroup>
      <AspireHostProjectMetadataSource Update="@(AspireHostProjectMetadataSource)">
        <Source>
          <![CDATA[// <auto-generated/>

namespace Projects%3B

[global::System.CodeDom.Compiler.GeneratedCode("Aspire.Hosting", null)]
[global::System.Diagnostics.CodeAnalysis.ExcludeFromCodeCoverage(Justification = "Generated code.")]
[global::System.Diagnostics.DebuggerDisplay("Type = {GetType().Name,nq}, ProjectPath = {ProjectPath}")]
]]>$(AspireGeneratedClassesVisibility)<![CDATA[ class ]]>%(ClassName)<![CDATA[
{
    private ]]>%(ClassName)<![CDATA[() { }
    public static string ProjectPath => """]]>%(ProjectPath)<![CDATA["""%3B
}]]>
        </Source>
      </AspireHostProjectMetadataSource>
    </ItemGroup>

    <WriteLinesToFile File="$(_AspireIntermediatePath)references\_AppHost.ProjectMetadata.g.cs"
                      Overwrite="true"
                      Lines="%(AspireHostProjectMetadataSource.Source)"
                      WriteOnlyWhenDifferent="true" />
    <ItemGroup>
      <FileWrites Include="$(_AspireIntermediatePath)references\_AppHost.ProjectMetadata.g.cs" />
      <Compile Include="$(_AspireIntermediatePath)references\_AppHost.ProjectMetadata.g.cs" />
    </ItemGroup>
  </Target>

  <Target Name="_WarnOnUnsupportedLanguage" Condition="'$(Language)' != 'C#'">
    <Warning Code="ASPIRE001" Text="The '$(Language)' language isn't fully supported by Aspire - some code generation targets will not run, so will require manual authoring." HelpLink="https://aka.ms/aspire/diagnostic/aspire001" />
  </Target>

  <!--
  Gets the references in 'AppProjectTargetFramework' that aren't executable projects.
  -->
  <UsingTask TaskName="GetNonExecutableReferences"
             TaskFactory="RoslynCodeTaskFactory"
             AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll">
    <ParameterGroup>
      <AppProjectTargetFramework ParameterType="Microsoft.Build.Framework.ITaskItem[]" Required="true" />
      <NonExecutableReferences ParameterType="Microsoft.Build.Framework.ITaskItem[]" Output="true" />
    </ParameterGroup>
    <Task>
      <Using Namespace="System.Xml.Linq" />
      <Code Type="Fragment" Language="cs">
        <![CDATA[
          HashSet<ITaskItem> nonExecutableReferences = new HashSet<ITaskItem>();

          foreach (var appProject in AppProjectTargetFramework)
          {
            var additionalProperties = appProject.GetMetadata("AdditionalPropertiesFromProject");
            if (string.IsNullOrEmpty(additionalProperties))
            {
              // Skip any projects that don't contain the right metadata
              continue;
            }

            var additionalPropertiesXml = XElement.Parse(additionalProperties);
            foreach (var targetFrameworkElement in additionalPropertiesXml.Elements())
            {
              var isExe = targetFrameworkElement.Element("_IsExecutable");
              if (isExe != null && !string.Equals(isExe.Value, "true", StringComparison.OrdinalIgnoreCase))
              {
                nonExecutableReferences.Add(appProject);
              }
            }
          }

          NonExecutableReferences = nonExecutableReferences.ToArray();
        ]]>
      </Code>
    </Task>
  </UsingTask>

  <!--
  Validates that all the ProjectReferences of an Aspire AppHost project are executables and
  informs the developer to set 'IsAspireProjectResource=false' if they really intended on ProjectReferencing a library.
  -->
  <Target Name="_ValidateAspireHostProjectResources"
          DependsOnTargets="_CreateAspireProjectResources"
          Condition="'$(IsAspireHost)' == 'true' and '$(SkipValidateAspireHostProjectResources)' != 'true'">

    <MSBuild Projects="@(_AspireProjectResource)"
             Targets="GetTargetFrameworks"
             BuildInParallel="$(BuildInParallel)"
             Properties="%(_AspireProjectResource.SetConfiguration); %(_AspireProjectResource.SetPlatform)"
             ContinueOnError="!$(BuildingProject)"
             RemoveProperties="%(_AspireProjectResource.GlobalPropertiesToRemove);TargetFramework;RuntimeIdentifier;SelfContained;$(_GlobalPropertiesToRemoveFromProjectReferences)"
             SkipNonexistentTargets="true">
      <Output TaskParameter="TargetOutputs" ItemName="_AspireProjectResourceTargetFramework" />
    </MSBuild>

    <GetNonExecutableReferences AppProjectTargetFramework="@(_AspireProjectResourceTargetFramework)">
      <Output TaskParameter="NonExecutableReferences" ItemName="_AspireNonExecutableProjectResource" />
    </GetNonExecutableReferences>

    <Warning Code="ASPIRE004"
             Condition="'@(_AspireNonExecutableProjectResource)' != ''"
             Text="'%(_AspireNonExecutableProjectResource.OriginalItemSpec)' is referenced by an Aspire Host project, but it is not an executable. Did you mean to set IsAspireProjectResource=&quot;false&quot;?"
             HelpLink="https://aka.ms/aspire/diagnostic/aspire004" />
  </Target>

  <PropertyGroup>
    <!-- Easy extension point for adding new languages' write support. -->
    <WriteAspireProjectMetadataSourcesDependsOn>_CSharpWriteProjectMetadataSources;_CSharpWriteHostProjectMetadataSources;_WarnOnUnsupportedLanguage;_ValidateAspireHostProjectResources</WriteAspireProjectMetadataSourcesDependsOn>
  </PropertyGroup>

  <!-- The purpose of this target is to take all of the generated project metadata and write them to the intermediate build directory
     and reference them for compilation. There will be a ClassName.ProjectMetadata.g.cs file for each referenced project. -->
  <Target Name="WriteAspireProjectMetadataSources" DependsOnTargets="$(WriteAspireProjectMetadataSourcesDependsOn)" BeforeTargets="CoreCompile" />

  <!-- This target registers the location of the Aspire orchestration dependencies -->
  <Target Name="SetOrchestrationDiscoveryAttributes" BeforeTargets="GetAssemblyAttributes" Condition=" '$(DcpDir)' != '' ">
    <PropertyGroup>
      <DcpDir>$([MSBuild]::EnsureTrailingSlash('$(DcpDir)'))</DcpDir>
      <DcpExtensionsDir Condition=" '$(DcpExtensionsDir)' == '' ">$([MSBuild]::NormalizePath($(DcpDir), 'ext'))</DcpExtensionsDir>
      <DcpExtensionsDir>$([MSBuild]::EnsureTrailingSlash('$(DcpExtensionsDir)'))</DcpExtensionsDir>
      <DcpBinDir Condition=" '$(DcpBinDir)' == '' ">$([MSBuild]::NormalizePath($(DcpExtensionsDir), 'bin'))</DcpBinDir>
      <DcpBinDir>$([MSBuild]::EnsureTrailingSlash('$(DcpBinDir)'))</DcpBinDir>
      <DcpCliPath Condition=" '$(DcpCliPath)'  == '' ">$([MSBuild]::NormalizePath($(DcpDir), 'dcp'))</DcpCliPath>
      <DcpCliPath Condition=" '$(OS)' == 'Windows_NT' and !$(DcpCliPath.EndsWith('.exe')) ">$(DcpCliPath).exe</DcpCliPath>
    </PropertyGroup>

    <ItemGroup>
      <AssemblyAttribute Include="System.Reflection.AssemblyMetadata">
        <_Parameter1>dcpclipath</_Parameter1>
        <_Parameter2>$(DcpCliPath)</_Parameter2>
      </AssemblyAttribute>
      <AssemblyAttribute Include="System.Reflection.AssemblyMetadata">
        <_Parameter1>dcpextensionpaths</_Parameter1>
        <_Parameter2>$(DcpExtensionsDir)</_Parameter2>
      </AssemblyAttribute>
      <AssemblyAttribute Include="System.Reflection.AssemblyMetadata">
        <_Parameter1>dcpbinpath</_Parameter1>
        <_Parameter2>$(DcpBinDir)</_Parameter2>
      </AssemblyAttribute>
      <AssemblyAttribute Include="System.Reflection.AssemblyMetadata">
        <_Parameter1>apphostprojectpath</_Parameter1>
        <_Parameter2>$(MSBuildProjectDirectory)</_Parameter2>
      </AssemblyAttribute>
      <AssemblyAttribute Include="System.Reflection.AssemblyMetadata">
        <_Parameter1>apphostprojectname</_Parameter1>
        <_Parameter2>$(MSBuildProjectFile)</_Parameter2>
      </AssemblyAttribute>
    </ItemGroup>
  </Target>

  <Target Name="SetDashboardDiscoveryAttributes" BeforeTargets="GetAssemblyAttributes" Condition=" '$(AspireDashboardDir)' != '' ">
    <PropertyGroup>
      <AspireDashboardDir>$([MSBuild]::EnsureTrailingSlash('$(AspireDashboardDir)'))</AspireDashboardDir>
      <AspireDashboardPath Condition=" '$(AspireDashboardPath)' == '' ">$([MSBuild]::NormalizePath($(AspireDashboardDir), 'Aspire.Dashboard'))</AspireDashboardPath>
      <AspireDashboardPath Condition=" '$(OS)' == 'Windows_NT' and !$(AspireDashboardPath.EndsWith('.exe')) ">$(AspireDashboardPath).exe</AspireDashboardPath>
      <AspireDashboardPath Condition="$([MSBuild]::IsOsPlatform('OSX')) and !$(AspireDashboardPath.EndsWith('.dll'))">$(AspireDashboardPath).dll</AspireDashboardPath>
    </PropertyGroup>

    <ItemGroup>
      <AssemblyAttribute Include="System.Reflection.AssemblyMetadata">
        <_Parameter1>aspiredashboardpath</_Parameter1>
        <_Parameter2>$(AspireDashboardPath)</_Parameter2>
      </AssemblyAttribute>
    </ItemGroup>
  </Target>

  <Target Name="EmbedAppHostIntermediateOutputPath" BeforeTargets="GetAssemblyAttributes" Condition=" '$(IsAspireHost)' == 'true' ">
    <ItemGroup>
      <AssemblyAttribute Include="System.Reflection.AssemblyMetadataAttribute">
        <_Parameter1>apphostprojectbaseintermediateoutputpath</_Parameter1>
        <_Parameter2>$(BaseIntermediateOutputPath)</_Parameter2>
        <_Parameter2 Condition="'$([System.IO.Path]::IsPathRooted($(BaseIntermediateOutputPath)))' == 'false'">$([System.IO.Path]::Combine('$(MSBuildProjectDirectory)', '$(BaseIntermediateOutputPath)'))</_Parameter2>
      </AssemblyAttribute>
    </ItemGroup>
  </Target>

  <PropertyGroup>
    <AspirePublisher Condition="'$(AspirePublisher)' == ''">manifest</AspirePublisher>
    <AspireManifestPublishOutputPath Condition="'$(AspireManifestPublishOutputPath)' == ''">$(_AspireIntermediatePath)</AspireManifestPublishOutputPath>
  </PropertyGroup>

  <Target Name="_EnsureAspireManifestPublishOutputPathExists">
    <PropertyGroup>
      <AspireManifestPublishOutputPath>$([MSBuild]::NormalizeDirectory($(AspireManifestPublishOutputPath)))</AspireManifestPublishOutputPath>
      <_AspireManifestPublishOutputFile>$([MSBuild]::NormalizePath('$(AspireManifestPublishOutputPath)', 'manifest.json'))</_AspireManifestPublishOutputFile>
    </PropertyGroup>

    <MakeDir Directories="$(AspireManifestPublishOutputPath)" />
  </Target>

  <Target Name="__ErrorOnMininumSdkVersionMissing" BeforeTargets="PrepareForBuild"
  Condition="'$(IsAspireHost)' == 'true' and ('$(AspireHostingSDKVersion)' == '' or $([MSBuild]::VersionLessThan('$(AspireHostingSDKVersion)', '9.0.0')))">
    <Error Code="ASPIRE007"
      Text="$(MSBuildProjectName) project requires a reference to &quot;Aspire.AppHost.Sdk&quot; with version &quot;9.0.0&quot; or greater to work correctly. Please add the following line after the Project declaration `&lt;Sdk Name=&quot;Aspire.AppHost.Sdk&quot; Version=&quot;9.0.0&quot; /&gt;`."
      File="$(MSBuildProjectFullPath)"
      HelpLink="https://aka.ms/aspire/diagnostic/aspire007" />
  </Target>

  <!-- Entrypoint to allow for generation of an aspire manifest to a given location -->
  <Target Name="GenerateAspireManifest" DependsOnTargets="Build;_EnsureAspireManifestPublishOutputPathExists" Inputs="$(TargetFileName)" Outputs="$(_AspireManifestPublishOutputFile)">
    <ItemGroup>
      <_AspireManifestPublishArg Include="%22$(DOTNET_HOST_PATH)%22; %22$(TargetPath)%22;"/>
      <_AspireManifestPublishArg Include="--publisher; $(AspirePublisher);" />
      <_AspireManifestPublishArg Include="--output-path; %22$(_AspireManifestPublishOutputFile)%22" />
    </ItemGroup>

    <Exec Command="@(_AspireManifestPublishArg, ' ')"
          ConsoleToMsBuild="true"
          IgnoreStandardErrorWarningFormat="true"
          EchoOff="true"
          StandardOutputImportance="low"
          StandardErrorImportance="low" />
  </Target>
</Project>
