<Project Sdk="Microsoft.NET.Sdk" InitialTargets="AddTemplatesToPackageAsContent">

  <PropertyGroup>
    <TargetFramework>$(DefaultTargetFramework)</TargetFramework>
    <OutputType>Library</OutputType>
    <IsPackable>true</IsPackable>
    <IncludeContentInPack>true</IncludeContentInPack>
    <IncludeBuildOutput>false</IncludeBuildOutput>
    <ContentTargetFolders>content</ContentTargetFolders>
    <PackageType>Template</PackageType>
    <NoWarn>$(NoWarn);NU5128</NoWarn>
    <EnableDefaultItems>false</EnableDefaultItems>
    <Description>Aspire Template Pack for Microsoft Template Engine</Description>
    <UsingToolTemplateLocalizer>true</UsingToolTemplateLocalizer>
    <NoDefaultExcludes>true</NoDefaultExcludes>
  </PropertyGroup>

  <PropertyGroup>
    <UsePublicApiAnalyzers>false</UsePublicApiAnalyzers>
  </PropertyGroup>

  <ItemGroup>
    <!-- see https://github.com/dotnet/aspire/pull/1225 -->
    <None Include="templates\**\*" />
  </ItemGroup>

  <ItemGroup>
    <!-- Template project files: *.csproj -->
    <TemplateProjectFiles Include="$(MSBuildThisFileDirectory)templates\**\*.csproj">
      <PackagePath>content/templates/%(RecursiveDir)</PackagePath>
      <DestinationFile>$(IntermediateOutputPath)content\templates\%(RecursiveDir)%(Filename)%(Extension)</DestinationFile>
    </TemplateProjectFiles>

    <!-- Template project files: apphost.cs (singlefile only) -->
    <TemplateProjectFiles Include="$(MSBuildThisFileDirectory)templates\aspire-apphost-singlefile\**\apphost.cs">
      <PackagePath>content/templates/aspire-apphost-singlefile/%(RecursiveDir)</PackagePath>
      <DestinationFile>$(IntermediateOutputPath)content\templates\aspire-apphost-singlefile\%(RecursiveDir)%(Filename)%(Extension)</DestinationFile>
    </TemplateProjectFiles>

    <!-- Template project files: apphost.cs (aspire-py-starter) -->
    <TemplateProjectFiles Include="$(MSBuildThisFileDirectory)templates\aspire-py-starter\**\apphost.cs">
      <PackagePath>content/templates/aspire-py-starter/%(RecursiveDir)</PackagePath>
      <DestinationFile>$(IntermediateOutputPath)content\templates\aspire-py-starter\%(RecursiveDir)%(Filename)%(Extension)</DestinationFile>
    </TemplateProjectFiles>

    <TemplateProjectFilesObj Include="@(TemplateProjectFiles->'%(DestinationFile)')" />

    <TemplateFiles Include="$(MSBuildThisFileDirectory)templates\**\*"
                   Exclude="$(MSBuildThisFileDirectory)templates\**\bin\**;$(MSBuildThisFileDirectory)templates\**\obj\**;$(MSBuildThisFileDirectory)templates\**\*.csproj;$(MSBuildThisFileDirectory)templates\aspire-apphost-singlefile\**\apphost.cs;$(MSBuildThisFileDirectory)templates\aspire-py-starter\**\apphost.cs">
      <PackagePath>content/templates/%(RecursiveDir)</PackagePath>
    </TemplateFiles>
    <TemplateFilesObj Include="@(TemplateFiles->'$(IntermediateOutputPath)content\templates\%(RecursiveDir)%(Filename)%(Extension)')" />
  </ItemGroup>

  <!-- When building a package, this target will run to copy all the templates into the intermediate directory,
       replaces the package versions, and adds them to the package.-->
  <Target Name="AddTemplatesToPackageAsContent"
          DependsOnTargets="ReplacePackageVersionOnTemplates">
    <ItemGroup>
      <Content Include="@(TemplateFilesObj);@(TemplateProjectFilesObj)" />
    </ItemGroup>
  </Target>

  <!-- Replaces the versions referenced by the templates projects to use the version of the packages being live-built -->
  <Target Name="ReplacePackageVersionOnTemplates"
          DependsOnTargets="CopyTemplatesToIntermediateOutputPath"
          Inputs="@(TemplateProjectFiles)"
          Outputs="@(TemplateProjectFilesObj)">

    <WriteLinesToFile File="%(TemplateProjectFiles.DestinationFile)"
                      Lines="$([System.IO.File]::ReadAllText('%(TemplateProjectFiles.FullPath)')
                                                 .Replace('!!REPLACE_WITH_LATEST_VERSION!!', '$(PackageVersion)')
                                                 .Replace('!!REPLACE_WITH_ASPNETCORE_OPENAPI_9_VERSION!!', '$(MicrosoftAspNetCoreOpenApiVersion)')
                                                 .Replace('!!REPLACE_WITH_ASPNETCORE_OPENAPI_10_VERSION!!', '$(MicrosoftAspNetCoreOpenApiPreviewVersion)')
                                                 .Replace('!!REPLACE_WITH_DOTNET_EXTENSIONS_VERSION!!', '$(MicrosoftExtensionsHttpResilienceVersion)')
                                                 .Replace('!!REPLACE_WITH_SERVICE_DISCOVERY_VERSION!!', '$(MicrosoftExtensionsServiceDiscoveryVersion)')
                                                 .Replace('!!REPLACE_WITH_OTEL_NET8_VERSION!!', '$(OpenTelemetryNet8Version)')
                                                 .Replace('!!REPLACE_WITH_OTEL_EXPORTER_VERSION!!', '$(OpenTelemetryExporterOpenTelemetryProtocolVersion)')
                                                 .Replace('!!REPLACE_WITH_OTEL_HOSTING_VERSION!!', '$(OpenTelemetryInstrumentationExtensionsHostingVersion)')
                                                 .Replace('!!REPLACE_WITH_OTEL_ASPNETCORE_VERSION!!', '$(OpenTelemetryInstrumentationAspNetCoreVersion)')
                                                 .Replace('!!REPLACE_WITH_OTEL_HTTP_VERSION!!', '$(OpenTelemetryInstrumentationHttpVersion)')
                                                 .Replace('!!REPLACE_WITH_OTEL_RUNTIME_VERSION!!', '$(OpenTelemetryInstrumentationRuntimeVersion)') )"
                      WriteOnlyWhenDifferent="True"
                      Overwrite="true" />
  </Target>

  <!-- Grabs the contents of the templates folder and copies them to IntermediateOutputPath directory -->
  <Target Name="CopyTemplatesToIntermediateOutputPath"
          Inputs="@(TemplateFiles)"
          Outputs="@(TemplateFilesObj)">

    <Copy SourceFiles="@(TemplateFiles)"
          DestinationFiles="@(TemplateFilesObj)"
          SkipUnchangedFiles="true" />
  </Target>

  <!-- Check for modified templatestrings files after build -->
  <Target Name="CheckTemplateStringsNotModified" AfterTargets="Build">
    <PropertyGroup>
      <_TemplateStringsPattern>$(MSBuildThisFileDirectory)templates\**\*templatestrings.*.json</_TemplateStringsPattern>
      <_CheckScriptPath>$(IntermediateOutputPath)check-templatestrings.ps1</_CheckScriptPath>
    </PropertyGroup>
    
    <!-- Create PowerShell script to check for modified files -->
    <PropertyGroup>
      <_CheckScript>
<![CDATA[
$ErrorActionPreference = 'Stop'

# Check if git is available
if (-not (Get-Command git -ErrorAction SilentlyContinue)) {
    Write-Host "Git is not available, skipping templatestrings check"
    exit 0
}

# Check if we're in a git repository
$gitDir = git rev-parse --git-dir 2>$null
if ($LASTEXITCODE -ne 0) {
    Write-Host "Not in a git repository, skipping templatestrings check"
    exit 0
}

# Get list of modified templatestrings files
$pattern = "src/Aspire.ProjectTemplates/templates/*templatestrings.*.json"
$modifiedFiles = @(git diff --name-only -- $pattern 2>$null)

if ($modifiedFiles.Count -eq 0) {
    Write-Host "No modified templatestrings files found - check passed"
    exit 0
}

# Build failed - there are modified files
Write-Host ""
Write-Host "================================================================================" -ForegroundColor Red
Write-Host "BUILD FAILED: Templatestrings files have been modified by the build process" -ForegroundColor Red
Write-Host "================================================================================" -ForegroundColor Red
Write-Host ""
Write-Host "The following templatestrings JSON files were modified during the build:" -ForegroundColor Red
Write-Host ""
foreach ($file in $modifiedFiles) {
    Write-Host "  - $file" -ForegroundColor Yellow
}
Write-Host ""
Write-Host "These files are localization files and should not be modified by the build." -ForegroundColor Red
Write-Host "The modifications need to be committed to source control before proceeding." -ForegroundColor Red
Write-Host ""
Write-Host "To fix this issue:" -ForegroundColor Cyan
Write-Host "  1. Review the changes: git diff $pattern" -ForegroundColor Cyan
Write-Host "  2. If the changes are correct, commit them: git add $pattern && git commit" -ForegroundColor Cyan
Write-Host "  3. If the changes are incorrect, revert them: git checkout -- $pattern" -ForegroundColor Cyan
Write-Host ""
Write-Host "================================================================================" -ForegroundColor Red
Write-Host ""
Write-Error "Templatestrings files were modified by the build. See messages above for details."
exit 1
]]>
      </_CheckScript>
    </PropertyGroup>

    <!-- Write the script to a file -->
    <WriteLinesToFile File="$(_CheckScriptPath)"
                      Lines="$(_CheckScript)"
                      Overwrite="true"
                      Encoding="UTF-8" />

    <!-- Execute the check -->
    <Exec Command="pwsh -NoProfile -ExecutionPolicy Bypass -File &quot;$(_CheckScriptPath)&quot;"
          ContinueOnError="false"
          WorkingDirectory="$(RepoRoot)" />
  </Target>

</Project>
