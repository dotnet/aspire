<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>$(DefaultTargetFramework)</TargetFramework>
    <OutputType>Library</OutputType>
    <IsPackable>true</IsPackable>
    <IncludeContentInPack>true</IncludeContentInPack>
    <IncludeBuildOutput>false</IncludeBuildOutput>
    <ContentTargetFolders>content</ContentTargetFolders>
    <PackageType>Template</PackageType>
    <NoWarn>$(NoWarn);NU5128</NoWarn>
    <EnableDefaultItems>false</EnableDefaultItems>
    <Description>Aspire Template Pack for Microsoft Template Engine</Description>
    <UsingToolTemplateLocalizer>true</UsingToolTemplateLocalizer>
    <NoDefaultExcludes>true</NoDefaultExcludes>
  </PropertyGroup>

  <PropertyGroup>
    <UsePublicApiAnalyzers>false</UsePublicApiAnalyzers>
  </PropertyGroup>

  <ItemGroup>
    <!-- see https://github.com/dotnet/aspire/pull/1225 -->
    <None Include="templates\**\*" />
  </ItemGroup>

  <ItemGroup>
    <!-- Template config files: .template.config\*.json -->
    <TemplateConfigFiles Include="$(MSBuildThisFileDirectory)templates\**\.template.config\*.json">
      <PackagePath>content/templates/%(RecursiveDir)</PackagePath>
      <DestinationFile>$(IntermediateOutputPath)content\templates\%(RecursiveDir)%(Filename)%(Extension)</DestinationFile>
    </TemplateConfigFiles>

    <TemplateConfigFilesObj Include="@(TemplateConfigFiles->'%(DestinationFile)')" />

    <!-- Template project files: *.csproj -->
    <TemplateProjectFiles Include="$(MSBuildThisFileDirectory)templates\**\*.csproj">
      <PackagePath>content/templates/%(RecursiveDir)</PackagePath>
      <DestinationFile>$(IntermediateOutputPath)content\templates\%(RecursiveDir)%(Filename)%(Extension)</DestinationFile>
    </TemplateProjectFiles>

    <!-- Template project files: apphost.cs (singlefile only) -->
    <TemplateProjectFiles Include="$(MSBuildThisFileDirectory)templates\aspire-apphost-singlefile\**\apphost.cs">
      <PackagePath>content/templates/aspire-apphost-singlefile/%(RecursiveDir)</PackagePath>
      <DestinationFile>$(IntermediateOutputPath)content\templates\aspire-apphost-singlefile\%(RecursiveDir)%(Filename)%(Extension)</DestinationFile>
    </TemplateProjectFiles>

    <!-- Template project files: apphost.cs (aspire-py-starter) -->
    <TemplateProjectFiles Include="$(MSBuildThisFileDirectory)templates\aspire-py-starter\**\apphost.cs">
      <PackagePath>content/templates/aspire-py-starter/%(RecursiveDir)</PackagePath>
      <DestinationFile>$(IntermediateOutputPath)content\templates\aspire-py-starter\%(RecursiveDir)%(Filename)%(Extension)</DestinationFile>
    </TemplateProjectFiles>

    <TemplateProjectFilesObj Include="@(TemplateProjectFiles->'%(DestinationFile)')" />

    <TemplateFiles Include="$(MSBuildThisFileDirectory)templates\**\*"
                   Exclude="$(MSBuildThisFileDirectory)templates\**\bin\**;$(MSBuildThisFileDirectory)templates\**\obj\**;$(MSBuildThisFileDirectory)templates\**\*.csproj;$(MSBuildThisFileDirectory)templates\aspire-apphost-singlefile\**\apphost.cs;$(MSBuildThisFileDirectory)templates\aspire-py-starter\**\apphost.cs">
      <PackagePath>content/templates/%(RecursiveDir)</PackagePath>
    </TemplateFiles>

    <TemplateFilesObj Include="@(TemplateFiles->'$(IntermediateOutputPath)content\templates\%(RecursiveDir)%(Filename)%(Extension)')" />
  </ItemGroup>

  <!-- When building a package, this target will run to copy all the templates into the intermediate directory,
       replaces the package versions, and adds them to the package.-->
  <Target Name="AddTemplatesToPackageAsContent"
          AfterTargets="Build"
          DependsOnTargets="ReplacePackageVersionOnTemplates">
    <ItemGroup>
      <Content Include="@(TemplateFilesObj);@(TemplateProjectFilesObj)" />
    </ItemGroup>
  </Target>

  <!-- Replaces the versions referenced by the templates projects to use the version of the packages being live-built -->
  <Target Name="ReplacePackageVersionOnTemplates"
          DependsOnTargets="CopyTemplatesToIntermediateOutputPath">

    <PropertyGroup>
      <!-- Extract purely numeric portions before any '-' prerelease tag -->
      <_VersionBase>$(PackageVersion.Split('-')[0])</_VersionBase>
      <!-- Build major.minor version -->
      <VersionMajor>$(_VersionBase.Split('.')[0])</VersionMajor>
      <VersionMinor>$(_VersionBase.Split('.')[1])</VersionMinor>
      <VersionMajorMinor>$(VersionMajor).$(VersionMinor)</VersionMajorMinor>
    </PropertyGroup>

    <ItemGroup>
      <!-- This is defined here as these files aren't guaranteed to exist until the build has run -->
      <TemplateLocalizedStringsFiles Include="$(MSBuildThisFileDirectory)templates\**\.template.config\localize\templatestrings.*.json" />
      <TemplateLocalizedStringsFilesDest Include="@(TemplateLocalizedStringsFiles)"
                                         DestinationFile="$(IntermediateOutputPath)content\templates\%(RecursiveDir)%(Filename)%(Extension)" />
      <TemplateLocalizedStringsFilesObj Include="@(TemplateLocalizedStringsFilesDest->'%(DestinationFile)')" />
    </ItemGroup>

    <ItemGroup>
      <SourceFiles Include="@(TemplateConfigFilesObj)" />
      <SourceFiles Include="@(TemplateProjectFilesObj)" />
      <SourceFiles Include="@(TemplateLocalizedStringsFilesObj)" />
      <!-- NOTE: These must be added in pairs, with text to replace first, then replacement text second -->
      <Replacements Include="!!REPLACE_WITH_LATEST_VERSION!!" />
      <Replacements Include="$(PackageVersion)" />
      <Replacements Include="!!REPLACE_WITH_LATEST_MAJOR_MINOR_VERSION!!" />
      <Replacements Include="$(VersionMajorMinor)" />
      <Replacements Include="!!REPLACE_WITH_ASPNETCORE_OPENAPI_9_VERSION!!" />
      <Replacements Include="$(MicrosoftAspNetCoreOpenApiVersion)" />
      <Replacements Include="!!REPLACE_WITH_ASPNETCORE_OPENAPI_10_VERSION!!" />
      <Replacements Include="$(MicrosoftAspNetCoreOpenApiPreviewVersion)" />
      <Replacements Include="!!REPLACE_WITH_DOTNET_EXTENSIONS_VERSION!!" />
      <Replacements Include="$(MicrosoftExtensionsHttpResilienceVersion)" />
      <Replacements Include="!!REPLACE_WITH_SERVICE_DISCOVERY_VERSION!!" />
      <Replacements Include="$(MicrosoftExtensionsServiceDiscoveryVersion)" />
      <Replacements Include="!!REPLACE_WITH_OTEL_EXPORTER_VERSION!!" />
      <Replacements Include="$(OpenTelemetryExporterOpenTelemetryProtocolVersion)" />
      <Replacements Include="!!REPLACE_WITH_OTEL_HOSTING_VERSION!!" />
      <Replacements Include="$(OpenTelemetryInstrumentationExtensionsHostingVersion)" />
      <Replacements Include="!!REPLACE_WITH_OTEL_ASPNETCORE_VERSION!!" />
      <Replacements Include="$(OpenTelemetryInstrumentationAspNetCoreVersion)" />
      <Replacements Include="!!REPLACE_WITH_OTEL_HTTP_VERSION!!" />
      <Replacements Include="$(OpenTelemetryInstrumentationHttpVersion)" />
      <Replacements Include="!!REPLACE_WITH_OTEL_RUNTIME_VERSION!!" />
      <Replacements Include="$(OpenTelemetryInstrumentationRuntimeVersion)" />
    </ItemGroup>

    <PropertyGroup>
      <SourcesFilesArgs>&quot;@(SourceFiles, '&quot; &quot;')&quot;</SourcesFilesArgs>
      <ReplacementsArgs>&quot;@(Replacements, '&quot; &quot;')&quot;</ReplacementsArgs>
    </PropertyGroup>

    <ItemGroup>
      <CommandArgs Include="dotnet" />
      <CommandArgs Include="$(RepoRoot)tools/scripts/replace-text.cs" />
      <CommandArgs Include="--files" />
      <CommandArgs Include="$(SourcesFilesArgs)" />
      <!-- Replacement tokens and their values -->
      <CommandArgs Include="--replacements" />
      <CommandArgs Include="$(ReplacementsArgs)" />
    </ItemGroup>

    <Exec Command="@(CommandArgs, ' ')" WorkingDirectory="$(MSBuildThisFileDirectory)" StandardOutputImportance="Normal" StandardErrorImportance="Normal" />
  </Target>

  <!-- Grabs the contents of the templates folder and copies them to IntermediateOutputPath directory -->
  <Target Name="CopyTemplatesToIntermediateOutputPath"
          Inputs="@(TemplateFiles);@(TemplateProjectFiles)"
          Outputs="@(TemplateFilesObj);@(TemplateProjectFilesObj)">

    <Copy SourceFiles="@(TemplateFiles)"
          DestinationFiles="@(TemplateFilesObj)"
          SkipUnchangedFiles="true" />
    <Copy SourceFiles="@(TemplateProjectFiles)"
          DestinationFiles="@(TemplateProjectFilesObj)"
          SkipUnchangedFiles="true" />

  </Target>

</Project>
