@implements IDialogContentComponent

@using Aspire.Dashboard.Components.CustomIcons
@using Aspire.Dashboard.Configuration
@using Aspire.Dashboard.Mcp
@using Microsoft.AspNetCore.Components
@using Microsoft.Extensions.Options
@using System.Text.Encodings.Web
@using System.Text.Json
@inject NavigationManager Navigation
@inject IOptions<DashboardOptions> DashboardOptions

<div class="mcp-server-dialog-content">
    <p>
        <b>Endpoint:</b>
        <code>@McpEndpointUrl</code>
    </p>
    <FluentButton Appearance="Appearance.Neutral" OnClick="AddToVSCode">Add to VS Code</FluentButton>
    <FluentTextArea Rows="4" ReadOnly Value="@McpJsonConfig" Style="width:100%;margin-top:1rem;" />
</div>

@code {
    private string McpEndpointUrl => Navigation.BaseUri.TrimEnd('/') + "/mcp";

    private string McpJsonConfig => JsonSerializer.Serialize(new {
        name = "aspire-dashboard",
        type = "http",
        url = McpEndpointUrl,
    });

    private string McpJsonConfigWithApiKey => JsonSerializer.Serialize(new {
        name = "aspire-dashboard",
        type = "http",
        url = McpEndpointUrl,
        headers = new Dictionary<string, string>{
            [McpApiKeyAuthenticationHandler.ApiKeyHeaderName] = "${input:aspire-dashboard-api-key}"
        }
    });

    private void AddToVSCode()
    {        
        var url = DashboardOptions.Value.Mcp.AuthMode == McpAuthMode.ApiKey
            ? $"vscode:mcp/install?{Uri.EscapeDataString(McpJsonConfigWithApiKey)}"
            : $"vscode:mcp/install?{Uri.EscapeDataString(McpJsonConfig)}";

        Navigation.NavigateTo(url, forceLoad: true);
    }
}
