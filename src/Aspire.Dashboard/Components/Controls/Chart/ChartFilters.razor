@namespace Aspire.Dashboard.Components

@using Aspire.Dashboard.Components.Controls.Grid
@using Aspire.Dashboard.Resources
@using Aspire.Dashboard.Otlp.Model
@inject IStringLocalizer<ControlsStrings> Loc

<div class="@(IsRenderedInsideModal ? "metrics-filters-modal-container" : "metrics-filters-standalone-container")">
    @if (DimensionFilters.Count > 0)
    {
        <div class="metrics-filters-section">
            <h5>@Loc[nameof(ControlsStrings.ChartContainerFiltersHeader)]</h5>
            <GridColumnManager @ref="_manager" Columns="@_gridColumns">
                <FluentDataGrid ResizeLabel="@AspireFluentDataGridHeaderCell.GetResizeLabel(Loc)"
                                ResizeType="DataGridResizeType.Discrete"
                                Items="@Queryable.AsQueryable(DimensionFilters)"
                                GridTemplateColumns="@_manager.GetGridTemplateColumns()"
                                GenerateHeader="GenerateHeaderOption.None">
                    <ChildContent>
                        <AspirePropertyColumn ColumnManager="@_manager" ColumnId="@NameColumn" Tooltip="true" TooltipText="@(c => c.Name)" Property="@(c => c.Name)"/>
                        <AspireTemplateColumn ColumnManager="@_manager" ColumnId="@DimensionColumn" Tooltip="true" TooltipText="@(c => c.SelectedValues.Count == 0 ? Loc[nameof(ControlsStrings.None)] : string.Join(", ", c.SelectedValues.Select(v => v.Name)))">
                            <FluentOverflow Class="dimension-overflow">
                                <ChildContent>
                                    @if (context.SelectedValues.Count == 0)
                                    {
                                        <FluentBadge>@Loc[nameof(ControlsStrings.None)]</FluentBadge>
                                    }
                                    else
                                    {
                                        var i = 0;
                                        foreach (var item in context.SelectedValues.OrderBy(g => g.Name))
                                        {
                                            // Always display the first item by setting a fixed value.
                                            <FluentOverflowItem Fixed="@((i == 0) ? OverflowItemFixed.Ellipsis : OverflowItemFixed.None)">
                                                <span class="dimension-tag">@item.Name</span>
                                            </FluentOverflowItem>
                                            i++;
                                        }
                                    }
                                </ChildContent>
                                <MoreButtonTemplate Context="overflow">
                                    @* Display must be inline block so the width is correctly calculated. *@
                                    <span class="dimension-tag" style="display:inline-block;">
                                        @($"+{overflow.ItemsOverflow.Count()}")
                                    </span>
                                </MoreButtonTemplate>
                                <OverflowTemplate Context="overflow">
                                    @* Intentionally empty. Don't display an overflow template here. *@
                                </OverflowTemplate>
                            </FluentOverflow>
                        </AspireTemplateColumn>
                        <AspireTemplateColumn ColumnManager="@_manager" ColumnId="@FilterColumn">
                            @{
                                var id = $"typeFilterButton-{context.SanitizedHtmlId}-{Guid.NewGuid()}";
                            }
                            <FluentButton id="@id"
                                          IconEnd="@(new Icons.Regular.Size20.Filter())"
                                          Appearance="@(context.AreAllValuesSelected is true ? Appearance.Stealth : Appearance.Accent)"
                                          @onclick="() => context.PopupVisible = !context.PopupVisible"
                                          aria-label="@(context.AreAllValuesSelected is true ? Loc[nameof(ControlsStrings.ChartContainerAllTags)] : Loc[nameof(ControlsStrings.ChartContainerFilteredTags)])"/>
                            <FluentPopover AnchorId="@id" @bind-Open="context.PopupVisible" VerticalThreshold="200" AutoFocus="false">
                                <Header>@context.Name</Header>
                                <Body>
                                <FluentStack Orientation="Orientation.Vertical" Class="dimension-popup">
                                    <FluentCheckbox Label="@Loc[nameof(ControlsStrings.All)]"
                                                    ThreeState="true"
                                                    ShowIndeterminate="false"
                                                    ThreeStateOrderUncheckToIntermediate="true"
                                                    @bind-CheckState="context.AreAllValuesSelected"/>
                                    @foreach (var tag in context.Values)
                                    {
                                        var isChecked = context.SelectedValues.Contains(tag);
                                        <FluentCheckbox Label="@tag.Name"
                                                        title="@tag.Name"
                                                        @key=tag
                                                        @bind-Value:get="isChecked"
                                                        @bind-Value:set="c => context.OnTagSelectionChanged(tag, c)"/>
                                    }
                                </FluentStack>
                                </Body>
                            </FluentPopover>
                        </AspireTemplateColumn>
                    </ChildContent>
                </FluentDataGrid>
            </GridColumnManager>
        </div>
    }
    @if (InstrumentData.Summary.Type == OtlpInstrumentType.Histogram)
    {
        <div class="metrics-filters-section">
            <h5>@Loc[nameof(ControlsStrings.ChartContainerOptionsHeader)]</h5>
            <div>
                <FluentSwitch Class="table-switch"
                              Label="@Loc[nameof(ControlsStrings.ChartContainerShowCountLabel)]"
                              @bind-Value="@ShowCounts"
                              @bind-Value:after="ShowCountChanged"/>
            </div>
        </div>
    }
</div>
