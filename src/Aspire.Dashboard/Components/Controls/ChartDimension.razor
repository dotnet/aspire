@namespace Aspire.Dashboard.Components

@using Aspire.Dashboard.Model
@using Aspire.Dashboard.Otlp.Model
@using Aspire.Dashboard.Otlp.Model.MetricValues
@using Aspire.Dashboard.Resources
@inject IStringLocalizer<ControlsStrings> Loc

<div title="@Model.Name"><span class="dimension-name">@Model.Name</span></div>
<div title="@string.Join(", ", Model.SelectedValues.Select(v => v.Name))">
    <FluentOverflow Class="dimension-overflow">
        <ChildContent>
            @if (Model.SelectedValues.Count == 0)
            {
                <FluentBadge>(None)</FluentBadge>
            }
            else
            {
                foreach (var item in Model.SelectedValues.OrderBy(g => g.Name))
                {
                    <FluentOverflowItem @key=item>
                        <FluentBadge>@item.Name</FluentBadge>
                    </FluentOverflowItem>
                }
            }
        </ChildContent>
        <MoreButtonTemplate>
            <FluentBadge>
                @($"+{context.ItemsOverflow.Count()}")
            </FluentBadge>
        </MoreButtonTemplate>
    </FluentOverflow>
</div>
<div>
    <FluentButton id="@($"typeFilterButton-{SanitizedHtmlId}")"
                  IconEnd="@(new Icons.Regular.Size20.Filter())"
                  Appearance="@(Model.AreAllValuesSelected is true ? Appearance.Stealth : Appearance.Accent)"
                  @onclick="() => Model.PopupVisible = !Model.PopupVisible"
                  aria-label="@(Model.AreAllValuesSelected is true ? Loc[ControlsStrings.ChartDimensionAllTags] : Loc[ControlsStrings.ChartDimensionFilteredTags])" />
    <FluentPopover AnchorId="@($"typeFilterButton-{SanitizedHtmlId}")" @bind-Open="Model.PopupVisible">
        <Header>@Model.Name</Header>
        <Body>
            <FluentStack Orientation="Orientation.Vertical" Class="dimension-popup">
                <FluentCheckbox Label="All"
                                ThreeState="true"
                                ShowIndeterminate="false"
                                @bind-CheckState="Model.AreAllValuesSelected" />
                @foreach (var tag in Model.Values)
                {
                    var isChecked = Model.SelectedValues.Contains(tag);
                    <FluentCheckbox Label="@tag.Name"
                                    @key=tag
                                    @bind-Value:get="isChecked"
                                    @bind-Value:set="c => OnTagSelectionChanged(tag, c)" />
                }
            </FluentStack>
        </Body>
    </FluentPopover>
</div>
