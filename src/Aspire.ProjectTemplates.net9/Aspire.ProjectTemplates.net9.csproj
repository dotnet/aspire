<Project Sdk="Microsoft.NET.Sdk" InitialTargets="AddTemplatesToPackageAsContent">

  <PropertyGroup>
    <TargetFramework>$(DefaultTargetFramework)</TargetFramework>
    <OutputType>Library</OutputType>
    <IsPackable>true</IsPackable>
    <IncludeContentInPack>true</IncludeContentInPack>
    <IncludeBuildOutput>false</IncludeBuildOutput>
    <ContentTargetFolders>content</ContentTargetFolders>
    <PackageType>Template</PackageType>
    <NoWarn>$(NoWarn);NU5128</NoWarn>
    <EnableDefaultItems>false</EnableDefaultItems>
    <Description>.NET Aspire Template Pack for net8.0</Description>
    <UsingToolTemplateLocalizer>true</UsingToolTemplateLocalizer>

    <TemplatesNet80Dir>..\Aspire.ProjectTemplates.net8\templates\</TemplatesNet80Dir>
  </PropertyGroup>

  <PropertyGroup>
    <UsePublicApiAnalyzers>false</UsePublicApiAnalyzers>
  </PropertyGroup>

  <PropertyGroup>
    <MinCodeCoverage>100</MinCodeCoverage>
  </PropertyGroup>

  <ItemGroup>
    <None Include="$(TemplatesNet80Dir)aspire-apphost\**\*" />
    <None Include="$(TemplatesNet80Dir)aspire-empty\**\*" />
    <None Include="$(TemplatesNet80Dir)aspire-mstest\**\*" />
    <None Include="$(TemplatesNet80Dir)aspire-nunit\**\*" />
    <None Include="$(TemplatesNet80Dir)aspire-servicedefaults\**\*" />
    <None Include="$(TemplatesNet80Dir)aspire-xunit\**\*" />

    <!-- FIXME: override with 9.0 specific one -->
    <None Include="$(TemplatesNet80Dir)aspire-starter\**\*" />
  </ItemGroup>

  <!-- When building a package, this target will run to copy all the templates into the intermediate directory,
       replaces the package versions, and adds them to the package.-->
  <Target Name="AddTemplatesToPackageAsContent"
          DependsOnTargets="ReplacePackageVersionOnTemplates">

    <!-- Creating a temporary item instead of defining content items directly in order to avoid MSBuild MSB4120
    message shown when an item within a target references itself which may cuase unintended expansion. -->
    <ItemGroup>
      <_TemplatesForPackage Include="$(IntermediateOutputPath)\content\templates\**\*" />
    </ItemGroup>
    <ItemGroup>
      <Content Include="%(_TemplatesForPackage.Identity)"
              PackagePath="content/templates/%(_TemplatesForPackage.RecursiveDir)" />
    </ItemGroup>
  </Target>

  <!-- Replaces the versions referenced by the templates projects to use the version of the packages being live-built -->
  <Target Name="ReplacePackageVersionOnTemplates"
          DependsOnTargets="CopyTemplatesToIntermediateOutputPath">

    <ItemGroup>
      <TemplateProjectFiles Include="templates\**\*.csproj" />
      <TemplateProjectFiles>
        <DestinationFile>$(IntermediateOutputPath)\content\templates\%(RecursiveDir)%(Filename)%(Extension)</DestinationFile>
      </TemplateProjectFiles>
    </ItemGroup>

    <WriteLinesToFile File="%(TemplateProjectFiles.DestinationFile)"
                      Lines="$([System.IO.File]::ReadAllText('%(TemplateProjectFiles.FullPath)')
                                                 .Replace('!!REPLACE_WITH_LATEST_VERSION!!', '$(PackageVersion)')
                                                 .Replace('!!REPLACE_WITH_EXTENSIONS_VERSION!!', '$(MicrosoftExtensionsHttpResiliencePackageVersion)'))"
                      Overwrite="true" />
  </Target>

  <!-- Grabs the contents of the templates folder and copies them to IntermediateOutputPath directory -->
  <Target Name="CopyTemplatesToIntermediateOutputPath">

    <ItemGroup>
      <_ContentFilesToPackage Include="templates\**\*" Exclude="templates\**\bin\**;templates\**\obj\**;templates\**\*.csproj" />
    </ItemGroup>

    <Copy SourceFiles="@(_ContentFilesToPackage)"
          SkipUnchangedFiles="true"
          DestinationFolder="$(IntermediateOutputPath)\content\templates\%(RecursiveDir)" />
  </Target>

</Project>
