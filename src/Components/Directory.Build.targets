<Project>

  <Import Project="..\..\Directory.Build.targets" />

  <!--
  Logic for including the ConfigurationSchema.json file and corresponding
  PackageId.targets file which brings the ConfigurationSchema.json file into the Json Schema.
  -->
  <PropertyGroup>
    <ConfigurationSchemaPath>$(MSBuildProjectDirectory)\ConfigurationSchema.json</ConfigurationSchemaPath>
    <ConfigurationSchemaExists Condition="Exists('$(ConfigurationSchemaPath)')">true</ConfigurationSchemaExists>
    <Features Condition="'$(EnableConfigurationBindingGenerator)' == 'true'">$(Features);InterceptorsPreview</Features>
    <!-- AspNetCore.HealthChecks packages are unsigned, we ignore that warning on purpose  -->
    <NoWarn>$(NoWarn);CS8002</NoWarn>

    <TargetsTriggeredByCompilation Condition="'$(DesignTimeBuild)' != 'true'">$(TargetsTriggeredByCompilation);GenerateConfigurationSchema</TargetsTriggeredByCompilation>
  </PropertyGroup>

  <ItemGroup Condition="'$(ConfigurationSchemaExists)' == 'true'">
    <None Include="$(ConfigurationSchemaPath)"
          Pack="True"
          PackagePath="ConfigurationSchema.json" />
  </ItemGroup>

  <ItemGroup>
    <!-- ensure the config generator is built -->
    <ProjectReference Include="$(MSBuildThisFileDirectory)..\Tools\ConfigurationSchemaGenerator\ConfigurationSchemaGenerator.csproj"
                      SetTargetFramework="TargetFramework=$(NetCurrent)"
                      OutputItemType="_ReferencedExecutable"
                      Private="false"
                      ReferenceOutputAssembly="false" />
  </ItemGroup>

  <PropertyGroup Condition="'$(ConfigurationSchemaExists)' == 'true'">
    <TargetsForTfmSpecificContentInPackage>$(TargetsForTfmSpecificContentInPackage);AddPackageTargetsInPackage</TargetsForTfmSpecificContentInPackage>
  </PropertyGroup>

  <Target Name="AddPackageTargetsInPackage">
    <ItemGroup>
      <TfmSpecificPackageFile Include="$(MSBuildThisFileDirectory)Common\Package.targets"
                              PackagePath="buildTransitive\$(TargetFramework)\$(PackageId).targets" />
    </ItemGroup>
  </Target>

  <Target Name="GenerateConfigurationSchema">
    <PropertyGroup>
      <ConfigurationSchemaGeneratorPath>$(ArtifactsBinDir)ConfigurationSchemaGenerator\$(Configuration)\$(NetCurrent)\ConfigurationSchemaGenerator</ConfigurationSchemaGeneratorPath>

      <GeneratorCommandLine>$(ConfigurationSchemaGeneratorPath)</GeneratorCommandLine>
      <GeneratorCommandLine>$(GeneratorCommandLine) --input "@(IntermediateAssembly)"</GeneratorCommandLine>
      <GeneratorCommandLine>$(GeneratorCommandLine) --reference "@(ReferencePathWithRefAssemblies, '" "')"</GeneratorCommandLine>
      <GeneratorCommandLine>$(GeneratorCommandLine) --output "$(IntermediateOutputPath)ConfigurationSchema.json"</GeneratorCommandLine>
    </PropertyGroup>
    
    <Exec Command="$(GeneratorCommandLine)" />
  </Target>
</Project>
