# Polyglot SDK Validation Tests (Reusable)
# Validates Python, Go, Java, Rust, and TypeScript AppHost SDKs with Redis integration
# Uses Dockerfiles from .github/workflows/polyglot-validation/ for reproducible environments
# Uses locally built bundle and NuGet packages from the workflow artifacts
name: Polyglot SDK Validation

on:
  workflow_call:
    inputs:
      versionOverrideArg:
        required: false
        type: string

jobs:
  validate_python:
    name: Python SDK Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Download bundle
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: aspire-bundle-linux-x64
          path: ${{ github.workspace }}/artifacts/bundle

      - name: Download NuGet packages
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: built-nugets
          path: ${{ github.workspace }}/artifacts/nugets

      - name: Download RID-specific NuGet packages
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: built-nugets-for-linux-x64
          path: ${{ github.workspace }}/artifacts/nugets-rid

      - name: Debug - List all downloaded artifacts
        run: |
          echo "=== DEBUG: Full artifact tree ==="
          echo "Working directory: $(pwd)"
          echo "GITHUB_WORKSPACE: ${{ github.workspace }}"
          echo ""
          echo "=== Setting execute permissions on bundle executables ==="
          chmod +x ${{ github.workspace }}/artifacts/bundle/aspire || echo "aspire not found"
          chmod +x ${{ github.workspace }}/artifacts/bundle/runtime/dotnet || echo "dotnet not found"
          chmod +x ${{ github.workspace }}/artifacts/bundle/tools/aspire-nuget/aspire-nuget || echo "aspire-nuget not found"
          chmod +x ${{ github.workspace }}/artifacts/bundle/tools/dev-certs/aspire-dev-certs || echo "aspire-dev-certs not found"
          chmod +x ${{ github.workspace }}/artifacts/bundle/dashboard/aspire-dashboard || echo "Dashboard not found"
          chmod +x ${{ github.workspace }}/artifacts/bundle/aspire-server/aspire-server || echo "RemoteHost not found"
          chmod +x ${{ github.workspace }}/artifacts/bundle/dcp/dcp || echo "dcp not found"
          echo ""
          echo "=== artifacts/ directory ==="
          ls -la ${{ github.workspace }}/artifacts/ || echo "artifacts/ does not exist"
          echo ""
          echo "=== artifacts/bundle/ directory ==="
          ls -la ${{ github.workspace }}/artifacts/bundle/ || echo "artifacts/bundle/ does not exist"
          echo ""
          echo "=== artifacts/bundle/ recursive (first 3 levels) ==="
          find ${{ github.workspace }}/artifacts/bundle -maxdepth 3 -type f 2>/dev/null | head -50 || echo "No files found"
          find ${{ github.workspace }}/artifacts/bundle -maxdepth 3 -type d 2>/dev/null || echo "No directories found"
          echo ""
          echo "=== Check for aspire CLI ==="
          ls -la ${{ github.workspace }}/artifacts/bundle/aspire 2>/dev/null || echo "aspire CLI not found at expected path"
          find ${{ github.workspace }}/artifacts -name "aspire" -type f 2>/dev/null || echo "aspire CLI not found anywhere"
          echo ""
          echo "=== Check for runtime/dotnet ==="
          ls -la ${{ github.workspace }}/artifacts/bundle/runtime/dotnet 2>/dev/null || echo "runtime/dotnet not found at expected path"
          find ${{ github.workspace }}/artifacts -name "dotnet" -type f 2>/dev/null || echo "dotnet not found anywhere"
          echo ""
          echo "=== Check for key directories ==="
          for dir in runtime dashboard dcp aspire-server tools; do
            if [ -d "${{ github.workspace }}/artifacts/bundle/$dir" ]; then
              echo "✓ $dir/ exists"
              ls -la "${{ github.workspace }}/artifacts/bundle/$dir" | head -5
            else
              echo "✗ $dir/ MISSING"
            fi
          done
          echo ""
          echo "=== artifacts/nugets/ sample ==="
          find ${{ github.workspace }}/artifacts/nugets -name "*.nupkg" 2>/dev/null | head -10 || echo "No nupkg files found"
          echo ""
          echo "=== artifacts/nugets-rid/ sample ==="
          find ${{ github.workspace }}/artifacts/nugets-rid -name "*.nupkg" 2>/dev/null | head -10 || echo "No nupkg files found"

      - name: Build Python validation image
        run: |
          docker build \
            -f .github/workflows/polyglot-validation/Dockerfile.python \
            -t polyglot-python \
            .github/workflows/polyglot-validation/

      - name: Run Python SDK validation
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -v /var/run/docker.sock:/var/run/docker.sock \
            polyglot-python

  validate_go:
    name: Go SDK Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Download bundle
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: aspire-bundle-linux-x64
          path: ${{ github.workspace }}/artifacts/bundle

      - name: Download NuGet packages
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: built-nugets
          path: ${{ github.workspace }}/artifacts/nugets

      - name: Download RID-specific NuGet packages
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: built-nugets-for-linux-x64
          path: ${{ github.workspace }}/artifacts/nugets-rid

      - name: Debug - List all downloaded artifacts
        run: |
          echo "=== DEBUG: Go validation - artifact tree ==="
          echo "=== Setting execute permissions on bundle executables ==="
          chmod +x ${{ github.workspace }}/artifacts/bundle/aspire || echo "aspire not found"
          chmod +x ${{ github.workspace }}/artifacts/bundle/runtime/dotnet || echo "dotnet not found"
          chmod +x ${{ github.workspace }}/artifacts/bundle/tools/aspire-nuget/aspire-nuget || echo "aspire-nuget not found"
          chmod +x ${{ github.workspace }}/artifacts/bundle/tools/dev-certs/aspire-dev-certs || echo "aspire-dev-certs not found"
          chmod +x ${{ github.workspace }}/artifacts/bundle/dashboard/aspire-dashboard || echo "Dashboard not found"
          chmod +x ${{ github.workspace }}/artifacts/bundle/aspire-server/aspire-server || echo "RemoteHost not found"
          chmod +x ${{ github.workspace }}/artifacts/bundle/dcp/dcp || echo "dcp not found"
          echo ""
          echo "=== artifacts/bundle/ ==="
          ls -la ${{ github.workspace }}/artifacts/bundle/ || echo "bundle/ does not exist"
          echo ""
          echo "=== Bundle structure check ==="
          for dir in runtime dashboard dcp aspire-server; do
            if [ -d "${{ github.workspace }}/artifacts/bundle/$dir" ]; then
              echo "✓ $dir/"
            else
              echo "✗ $dir/ MISSING"
            fi
          done
          ls -la ${{ github.workspace }}/artifacts/bundle/aspire 2>/dev/null || echo "aspire CLI MISSING"
          ls -la ${{ github.workspace }}/artifacts/bundle/runtime/dotnet 2>/dev/null || echo "runtime/dotnet MISSING"

      - name: Build Go validation image
        run: |
          docker build \
            -f .github/workflows/polyglot-validation/Dockerfile.go \
            -t polyglot-go \
            .github/workflows/polyglot-validation/

      - name: Run Go SDK validation
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -v /var/run/docker.sock:/var/run/docker.sock \
            polyglot-go

  validate_java:
    name: Java SDK Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Download bundle
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: aspire-bundle-linux-x64
          path: ${{ github.workspace }}/artifacts/bundle

      - name: Download NuGet packages
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: built-nugets
          path: ${{ github.workspace }}/artifacts/nugets

      - name: Download RID-specific NuGet packages
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: built-nugets-for-linux-x64
          path: ${{ github.workspace }}/artifacts/nugets-rid

      - name: Debug - List all downloaded artifacts
        run: |
          echo "=== DEBUG: Java validation - artifact tree ==="
          echo "=== Setting execute permissions on bundle executables ==="
          chmod +x ${{ github.workspace }}/artifacts/bundle/aspire || echo "aspire not found"
          chmod +x ${{ github.workspace }}/artifacts/bundle/runtime/dotnet || echo "dotnet not found"
          chmod +x ${{ github.workspace }}/artifacts/bundle/tools/aspire-nuget/aspire-nuget || echo "aspire-nuget not found"
          chmod +x ${{ github.workspace }}/artifacts/bundle/tools/dev-certs/aspire-dev-certs || echo "aspire-dev-certs not found"
          chmod +x ${{ github.workspace }}/artifacts/bundle/dashboard/aspire-dashboard || echo "Dashboard not found"
          chmod +x ${{ github.workspace }}/artifacts/bundle/aspire-server/aspire-server || echo "RemoteHost not found"
          chmod +x ${{ github.workspace }}/artifacts/bundle/dcp/dcp || echo "dcp not found"
          echo ""
          echo "=== artifacts/bundle/ ==="
          ls -la ${{ github.workspace }}/artifacts/bundle/ || echo "bundle/ does not exist"
          echo ""
          echo "=== Bundle structure check ==="
          for dir in runtime dashboard dcp aspire-server; do
            if [ -d "${{ github.workspace }}/artifacts/bundle/$dir" ]; then
              echo "✓ $dir/"
            else
              echo "✗ $dir/ MISSING"
            fi
          done
          ls -la ${{ github.workspace }}/artifacts/bundle/aspire 2>/dev/null || echo "aspire CLI MISSING"
          ls -la ${{ github.workspace }}/artifacts/bundle/runtime/dotnet 2>/dev/null || echo "runtime/dotnet MISSING"

      - name: Build Java validation image
        run: |
          docker build \
            -f .github/workflows/polyglot-validation/Dockerfile.java \
            -t polyglot-java \
            .github/workflows/polyglot-validation/

      - name: Run Java SDK validation
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -v /var/run/docker.sock:/var/run/docker.sock \
            polyglot-java

  validate_rust:
    name: Rust SDK Validation
    runs-on: ubuntu-latest
    # Rust SDK has known issues - don't fail the workflow
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Download bundle
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: aspire-bundle-linux-x64
          path: ${{ github.workspace }}/artifacts/bundle

      - name: Download NuGet packages
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: built-nugets
          path: ${{ github.workspace }}/artifacts/nugets

      - name: Download RID-specific NuGet packages
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: built-nugets-for-linux-x64
          path: ${{ github.workspace }}/artifacts/nugets-rid

      - name: Debug - List all downloaded artifacts
        run: |
          echo "=== DEBUG: Rust validation - artifact tree ==="
          echo "=== Setting execute permissions on bundle executables ==="
          chmod +x ${{ github.workspace }}/artifacts/bundle/aspire || echo "aspire not found"
          chmod +x ${{ github.workspace }}/artifacts/bundle/runtime/dotnet || echo "dotnet not found"
          chmod +x ${{ github.workspace }}/artifacts/bundle/tools/aspire-nuget/aspire-nuget || echo "aspire-nuget not found"
          chmod +x ${{ github.workspace }}/artifacts/bundle/tools/dev-certs/aspire-dev-certs || echo "aspire-dev-certs not found"
          chmod +x ${{ github.workspace }}/artifacts/bundle/dashboard/aspire-dashboard || echo "Dashboard not found"
          chmod +x ${{ github.workspace }}/artifacts/bundle/aspire-server/aspire-server || echo "RemoteHost not found"
          chmod +x ${{ github.workspace }}/artifacts/bundle/dcp/dcp || echo "dcp not found"
          echo ""
          echo "=== artifacts/bundle/ ==="
          ls -la ${{ github.workspace }}/artifacts/bundle/ || echo "bundle/ does not exist"
          echo ""
          echo "=== Bundle structure check ==="
          for dir in runtime dashboard dcp aspire-server; do
            if [ -d "${{ github.workspace }}/artifacts/bundle/$dir" ]; then
              echo "✓ $dir/"
            else
              echo "✗ $dir/ MISSING"
            fi
          done
          ls -la ${{ github.workspace }}/artifacts/bundle/aspire 2>/dev/null || echo "aspire CLI MISSING"
          ls -la ${{ github.workspace }}/artifacts/bundle/runtime/dotnet 2>/dev/null || echo "runtime/dotnet MISSING"

      - name: Build Rust validation image
        run: |
          docker build \
            -f .github/workflows/polyglot-validation/Dockerfile.rust \
            -t polyglot-rust \
            .github/workflows/polyglot-validation/

      - name: Run Rust SDK validation
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -v /var/run/docker.sock:/var/run/docker.sock \
            polyglot-rust

  validate_typescript:
    name: TypeScript SDK Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Download bundle
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: aspire-bundle-linux-x64
          path: ${{ github.workspace }}/artifacts/bundle

      - name: Download NuGet packages
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: built-nugets
          path: ${{ github.workspace }}/artifacts/nugets

      - name: Download RID-specific NuGet packages
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: built-nugets-for-linux-x64
          path: ${{ github.workspace }}/artifacts/nugets-rid

      - name: Debug - List all downloaded artifacts
        run: |
          echo "=== DEBUG: TypeScript validation - artifact tree ==="
          echo "=== Setting execute permissions on bundle executables ==="
          chmod +x ${{ github.workspace }}/artifacts/bundle/aspire || echo "aspire not found"
          chmod +x ${{ github.workspace }}/artifacts/bundle/runtime/dotnet || echo "dotnet not found"
          chmod +x ${{ github.workspace }}/artifacts/bundle/tools/aspire-nuget/aspire-nuget || echo "aspire-nuget not found"
          chmod +x ${{ github.workspace }}/artifacts/bundle/tools/dev-certs/aspire-dev-certs || echo "aspire-dev-certs not found"
          chmod +x ${{ github.workspace }}/artifacts/bundle/dashboard/aspire-dashboard || echo "Dashboard not found"
          chmod +x ${{ github.workspace }}/artifacts/bundle/aspire-server/aspire-server || echo "RemoteHost not found"
          chmod +x ${{ github.workspace }}/artifacts/bundle/dcp/dcp || echo "dcp not found"
          echo ""
          echo "=== artifacts/bundle/ ==="
          ls -la ${{ github.workspace }}/artifacts/bundle/ || echo "bundle/ does not exist"
          echo ""
          echo "=== Bundle structure check ==="
          for dir in runtime dashboard dcp aspire-server; do
            if [ -d "${{ github.workspace }}/artifacts/bundle/$dir" ]; then
              echo "✓ $dir/"
            else
              echo "✗ $dir/ MISSING"
            fi
          done
          ls -la ${{ github.workspace }}/artifacts/bundle/aspire 2>/dev/null || echo "aspire CLI MISSING"
          ls -la ${{ github.workspace }}/artifacts/bundle/runtime/dotnet 2>/dev/null || echo "runtime/dotnet MISSING"

      - name: Build TypeScript validation image
        run: |
          docker build \
            -f .github/workflows/polyglot-validation/Dockerfile.typescript \
            -t polyglot-typescript \
            .github/workflows/polyglot-validation/

      - name: Run TypeScript SDK validation
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -v /var/run/docker.sock:/var/run/docker.sock \
            polyglot-typescript

  results:
    if: always()
    runs-on: ubuntu-latest
    name: Polyglot Validation Results
    needs: [validate_python, validate_go, validate_java, validate_rust, validate_typescript]
    steps:
      - name: Check validation results
        # Only fail on Python, Go, Java, TypeScript failures (Rust has continue-on-error)
        if: >-
          ${{ needs.validate_python.result == 'failure' ||
              needs.validate_go.result == 'failure' ||
              needs.validate_java.result == 'failure' ||
              needs.validate_typescript.result == 'failure' ||
              needs.validate_python.result == 'cancelled' ||
              needs.validate_go.result == 'cancelled' ||
              needs.validate_java.result == 'cancelled' ||
              needs.validate_typescript.result == 'cancelled' }}
        run: |
          echo "One or more polyglot SDK validations failed."
          echo "Python: ${{ needs.validate_python.result }}"
          echo "Go: ${{ needs.validate_go.result }}"
          echo "Java: ${{ needs.validate_java.result }}"
          echo "TypeScript: ${{ needs.validate_typescript.result }}"
          exit 1

      - name: Report Rust status
        if: always()
        run: |
          echo "Rust SDK validation: ${{ needs.validate_rust.result }}"
          if [ "${{ needs.validate_rust.result }}" == "failure" ]; then
            echo "⚠️ Rust SDK validation failed (known issues - not blocking)"
          fi
      
      - name: All validations passed
        run: echo "✅ All required polyglot SDK validations passed!"
