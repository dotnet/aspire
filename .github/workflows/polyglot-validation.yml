# Polyglot SDK Validation Tests (Reusable)
# Validates Python, Go, Java, and Rust AppHost SDKs with Redis integration
# Uses Docker containers from mcr.microsoft.com for security
name: Polyglot SDK Validation

on:
  workflow_call:
    inputs:
      versionOverrideArg:
        required: false
        type: string

jobs:
  validate_python:
    name: Python SDK Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Download built NuGets
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: built-nugets
          path: ${{ github.workspace }}/nugets

      - name: Run Python SDK validation in Docker
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            mcr.microsoft.com/devcontainers/python:3.12 \
            bash -c '
              set -e
              echo "=== Installing .NET SDK 10.0 ==="
              curl -fsSL https://dot.net/v1/dotnet-install.sh | bash -s -- --channel 10.0
              export PATH="$HOME/.dotnet:$PATH"
              export DOTNET_ROOT="$HOME/.dotnet"
              
              echo "=== Installing uv package manager ==="
              curl -LsSf https://astral.sh/uv/install.sh | sh
              export PATH="$HOME/.local/bin:$PATH"
              
              echo "=== Installing Aspire CLI from built packages ==="
              dotnet tool install --global --add-source /workspace/nugets Aspire.Cli --prerelease
              export PATH="$HOME/.dotnet/tools:$PATH"
              
              echo "=== Enabling polyglot support ==="
              aspire config set features:polyglotSupportEnabled true --global
              
              echo "=== Running validation ==="
              chmod +x /workspace/.github/workflows/polyglot-validation/test-python.sh
              /workspace/.github/workflows/polyglot-validation/test-python.sh
            '

  validate_go:
    name: Go SDK Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Download built NuGets
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: built-nugets
          path: ${{ github.workspace }}/nugets

      - name: Run Go SDK validation in Docker
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            mcr.microsoft.com/devcontainers/go:1.23 \
            bash -c '
              set -e
              echo "=== Installing .NET SDK 10.0 ==="
              curl -fsSL https://dot.net/v1/dotnet-install.sh | bash -s -- --channel 10.0
              export PATH="$HOME/.dotnet:$PATH"
              export DOTNET_ROOT="$HOME/.dotnet"
              
              echo "=== Installing Aspire CLI from built packages ==="
              dotnet tool install --global --add-source /workspace/nugets Aspire.Cli --prerelease
              export PATH="$HOME/.dotnet/tools:$PATH"
              
              echo "=== Enabling polyglot support ==="
              aspire config set features:polyglotSupportEnabled true --global
              
              echo "=== Running validation ==="
              chmod +x /workspace/.github/workflows/polyglot-validation/test-go.sh
              /workspace/.github/workflows/polyglot-validation/test-go.sh
            '

  validate_java:
    name: Java SDK Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Download built NuGets
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: built-nugets
          path: ${{ github.workspace }}/nugets

      - name: Run Java SDK validation in Docker
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            mcr.microsoft.com/devcontainers/java:17 \
            bash -c '
              set -e
              echo "=== Installing .NET SDK 10.0 ==="
              curl -fsSL https://dot.net/v1/dotnet-install.sh | bash -s -- --channel 10.0
              export PATH="$HOME/.dotnet:$PATH"
              export DOTNET_ROOT="$HOME/.dotnet"
              
              echo "=== Installing Aspire CLI from built packages ==="
              dotnet tool install --global --add-source /workspace/nugets Aspire.Cli --prerelease
              export PATH="$HOME/.dotnet/tools:$PATH"
              
              echo "=== Enabling polyglot support ==="
              aspire config set features:polyglotSupportEnabled true --global
              
              echo "=== Running validation ==="
              chmod +x /workspace/.github/workflows/polyglot-validation/test-java.sh
              /workspace/.github/workflows/polyglot-validation/test-java.sh
            '

  validate_rust:
    name: Rust SDK Validation
    runs-on: ubuntu-latest
    # Rust SDK has known issues - don't fail the workflow
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Download built NuGets
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: built-nugets
          path: ${{ github.workspace }}/nugets

      - name: Run Rust SDK validation in Docker
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            mcr.microsoft.com/devcontainers/rust:1 \
            bash -c '
              set -e
              echo "=== Installing .NET SDK 10.0 ==="
              curl -fsSL https://dot.net/v1/dotnet-install.sh | bash -s -- --channel 10.0
              export PATH="$HOME/.dotnet:$PATH"
              export DOTNET_ROOT="$HOME/.dotnet"
              
              echo "=== Installing Aspire CLI from built packages ==="
              dotnet tool install --global --add-source /workspace/nugets Aspire.Cli --prerelease
              export PATH="$HOME/.dotnet/tools:$PATH"
              
              echo "=== Enabling polyglot support ==="
              aspire config set features:polyglotSupportEnabled true --global
              
              echo "=== Running validation ==="
              chmod +x /workspace/.github/workflows/polyglot-validation/test-rust.sh
              /workspace/.github/workflows/polyglot-validation/test-rust.sh
            '

  results:
    if: always()
    runs-on: ubuntu-latest
    name: Polyglot Validation Results
    needs: [validate_python, validate_go, validate_java, validate_rust]
    steps:
      - name: Check validation results
        # Only fail on Python, Go, Java failures (Rust has continue-on-error)
        if: >-
          ${{ needs.validate_python.result == 'failure' ||
              needs.validate_go.result == 'failure' ||
              needs.validate_java.result == 'failure' ||
              needs.validate_python.result == 'cancelled' ||
              needs.validate_go.result == 'cancelled' ||
              needs.validate_java.result == 'cancelled' }}
        run: |
          echo "One or more polyglot SDK validations failed."
          echo "Python: ${{ needs.validate_python.result }}"
          echo "Go: ${{ needs.validate_go.result }}"
          echo "Java: ${{ needs.validate_java.result }}"
          exit 1

      - name: Report Rust status
        if: always()
        run: |
          echo "Rust SDK validation: ${{ needs.validate_rust.result }}"
          if [ "${{ needs.validate_rust.result }}" == "failure" ]; then
            echo "⚠️ Rust SDK validation failed (known issues - not blocking)"
          fi
      
      - name: All validations passed
        run: echo "✅ All required polyglot SDK validations passed!"
