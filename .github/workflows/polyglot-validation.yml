# Polyglot SDK Validation Tests (Reusable)
# Validates Python, Go, Java, Rust, and TypeScript AppHost SDKs with Redis integration
# Uses Dockerfiles from .github/workflows/polyglot-validation/ for reproducible environments
# Uses locally built bundle and NuGet packages from the workflow artifacts
name: Polyglot SDK Validation

on:
  workflow_call:
    inputs:
      versionOverrideArg:
        required: false
        type: string

jobs:
  validate_python:
    name: Python SDK Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Download bundle
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: aspire-bundle-linux-x64
          path: ${{ github.workspace }}/artifacts/bundle

      - name: Download NuGet packages
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: built-nugets
          path: ${{ github.workspace }}/artifacts/nugets

      - name: Download RID-specific NuGet packages
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: built-nugets-for-linux-x64
          path: ${{ github.workspace }}/artifacts/nugets-rid

      - name: Verify bundle artifact
        run: |
          echo "=== Verifying self-extracting binary ==="
          ls -la ${{ github.workspace }}/artifacts/bundle/aspire || { echo "ERROR: aspire binary not found"; exit 1; }
          chmod +x ${{ github.workspace }}/artifacts/bundle/aspire

      - name: Build Python validation image
        run: |
          docker build \
            -f .github/workflows/polyglot-validation/Dockerfile.python \
            -t polyglot-python \
            .github/workflows/polyglot-validation/

      - name: Run Python SDK validation
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -v /var/run/docker.sock:/var/run/docker.sock \
            polyglot-python

  validate_go:
    name: Go SDK Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Download bundle
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: aspire-bundle-linux-x64
          path: ${{ github.workspace }}/artifacts/bundle

      - name: Download NuGet packages
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: built-nugets
          path: ${{ github.workspace }}/artifacts/nugets

      - name: Download RID-specific NuGet packages
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: built-nugets-for-linux-x64
          path: ${{ github.workspace }}/artifacts/nugets-rid

      - name: Verify bundle artifact
        run: |
          echo "=== Verifying self-extracting binary ==="
          ls -la ${{ github.workspace }}/artifacts/bundle/aspire || { echo "ERROR: aspire binary not found"; exit 1; }
          chmod +x ${{ github.workspace }}/artifacts/bundle/aspire

      - name: Build Go validation image
        run: |
          docker build \
            -f .github/workflows/polyglot-validation/Dockerfile.go \
            -t polyglot-go \
            .github/workflows/polyglot-validation/

      - name: Run Go SDK validation
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -v /var/run/docker.sock:/var/run/docker.sock \
            polyglot-go

  validate_java:
    name: Java SDK Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Download bundle
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: aspire-bundle-linux-x64
          path: ${{ github.workspace }}/artifacts/bundle

      - name: Download NuGet packages
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: built-nugets
          path: ${{ github.workspace }}/artifacts/nugets

      - name: Download RID-specific NuGet packages
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: built-nugets-for-linux-x64
          path: ${{ github.workspace }}/artifacts/nugets-rid

      - name: Verify bundle artifact
        run: |
          echo "=== Verifying self-extracting binary ==="
          ls -la ${{ github.workspace }}/artifacts/bundle/aspire || { echo "ERROR: aspire binary not found"; exit 1; }
          chmod +x ${{ github.workspace }}/artifacts/bundle/aspire

      - name: Build Java validation image
        run: |
          docker build \
            -f .github/workflows/polyglot-validation/Dockerfile.java \
            -t polyglot-java \
            .github/workflows/polyglot-validation/

      - name: Run Java SDK validation
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -v /var/run/docker.sock:/var/run/docker.sock \
            polyglot-java

  validate_rust:
    name: Rust SDK Validation
    runs-on: ubuntu-latest
    # Rust SDK has known issues - don't fail the workflow
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Download bundle
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: aspire-bundle-linux-x64
          path: ${{ github.workspace }}/artifacts/bundle

      - name: Download NuGet packages
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: built-nugets
          path: ${{ github.workspace }}/artifacts/nugets

      - name: Download RID-specific NuGet packages
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: built-nugets-for-linux-x64
          path: ${{ github.workspace }}/artifacts/nugets-rid

      - name: Verify bundle artifact
        run: |
          echo "=== Verifying self-extracting binary ==="
          ls -la ${{ github.workspace }}/artifacts/bundle/aspire || { echo "ERROR: aspire binary not found"; exit 1; }
          chmod +x ${{ github.workspace }}/artifacts/bundle/aspire

      - name: Build Rust validation image
        run: |
          docker build \
            -f .github/workflows/polyglot-validation/Dockerfile.rust \
            -t polyglot-rust \
            .github/workflows/polyglot-validation/

      - name: Run Rust SDK validation
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -v /var/run/docker.sock:/var/run/docker.sock \
            polyglot-rust

  validate_typescript:
    name: TypeScript SDK Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Download bundle
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: aspire-bundle-linux-x64
          path: ${{ github.workspace }}/artifacts/bundle

      - name: Download NuGet packages
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: built-nugets
          path: ${{ github.workspace }}/artifacts/nugets

      - name: Download RID-specific NuGet packages
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: built-nugets-for-linux-x64
          path: ${{ github.workspace }}/artifacts/nugets-rid

      - name: Verify bundle artifact
        run: |
          echo "=== Verifying self-extracting binary ==="
          ls -la ${{ github.workspace }}/artifacts/bundle/aspire || { echo "ERROR: aspire binary not found"; exit 1; }
          chmod +x ${{ github.workspace }}/artifacts/bundle/aspire

      - name: Build TypeScript validation image
        run: |
          docker build \
            -f .github/workflows/polyglot-validation/Dockerfile.typescript \
            -t polyglot-typescript \
            .github/workflows/polyglot-validation/

      - name: Run TypeScript SDK validation
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -v /var/run/docker.sock:/var/run/docker.sock \
            polyglot-typescript

  results:
    if: always()
    runs-on: ubuntu-latest
    name: Polyglot Validation Results
    needs: [validate_python, validate_go, validate_java, validate_rust, validate_typescript]
    steps:
      - name: Check validation results
        # Only fail on Python, Go, Java, TypeScript failures (Rust has continue-on-error)
        if: >-
          ${{ needs.validate_python.result == 'failure' ||
              needs.validate_go.result == 'failure' ||
              needs.validate_java.result == 'failure' ||
              needs.validate_typescript.result == 'failure' ||
              needs.validate_python.result == 'cancelled' ||
              needs.validate_go.result == 'cancelled' ||
              needs.validate_java.result == 'cancelled' ||
              needs.validate_typescript.result == 'cancelled' }}
        run: |
          echo "One or more polyglot SDK validations failed."
          echo "Python: ${{ needs.validate_python.result }}"
          echo "Go: ${{ needs.validate_go.result }}"
          echo "Java: ${{ needs.validate_java.result }}"
          echo "TypeScript: ${{ needs.validate_typescript.result }}"
          exit 1

      - name: Report Rust status
        if: always()
        run: |
          echo "Rust SDK validation: ${{ needs.validate_rust.result }}"
          if [ "${{ needs.validate_rust.result }}" == "failure" ]; then
            echo "⚠️ Rust SDK validation failed (known issues - not blocking)"
          fi
      
      - name: All validations passed
        run: echo "✅ All required polyglot SDK validations passed!"
