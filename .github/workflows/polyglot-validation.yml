# Polyglot SDK Validation Tests (Reusable)
# Validates Python, Go, and Java AppHost SDKs with Redis integration
name: Polyglot SDK Validation

on:
  workflow_call:
    inputs:
      versionOverrideArg:
        required: false
        type: string

jobs:
  validate_python:
    name: Python SDK Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup .NET
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4.3.1
        with:
          dotnet-version: '10.0.x'

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.11'

      - name: Install uv package manager
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Download built NuGets
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: built-nugets
          path: ${{ github.workspace }}/nugets

      - name: Install Aspire CLI from built packages
        run: |
          # Find and install the CLI tool from built packages
          CLI_NUPKG=$(find ${{ github.workspace }}/nugets -name "Aspire.Cli.*.nupkg" | head -1)
          if [ -z "$CLI_NUPKG" ]; then
            echo "❌ Aspire CLI package not found"
            exit 1
          fi
          
          # Install as global tool
          dotnet tool install --global --add-source ${{ github.workspace }}/nugets Aspire.Cli --prerelease
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

      - name: Run Python SDK validation
        env:
          ASPIRE_CLI_PATH: ${{ github.workspace }}/.dotnet/tools
        run: |
          chmod +x ${{ github.workspace }}/.github/workflows/polyglot-validation/test-python.sh
          ${{ github.workspace }}/.github/workflows/polyglot-validation/test-python.sh

  validate_go:
    name: Go SDK Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup .NET
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4.3.1
        with:
          dotnet-version: '10.0.x'

      - name: Setup Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version: '1.23'

      - name: Download built NuGets
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: built-nugets
          path: ${{ github.workspace }}/nugets

      - name: Install Aspire CLI from built packages
        run: |
          dotnet tool install --global --add-source ${{ github.workspace }}/nugets Aspire.Cli --prerelease
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

      - name: Run Go SDK validation
        env:
          ASPIRE_CLI_PATH: ${{ github.workspace }}/.dotnet/tools
        run: |
          chmod +x ${{ github.workspace }}/.github/workflows/polyglot-validation/test-go.sh
          ${{ github.workspace }}/.github/workflows/polyglot-validation/test-go.sh

  validate_java:
    name: Java SDK Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup .NET
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4.3.1
        with:
          dotnet-version: '10.0.x'

      - name: Setup Java
        uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4.7.1
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Download built NuGets
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: built-nugets
          path: ${{ github.workspace }}/nugets

      - name: Install Aspire CLI from built packages
        run: |
          dotnet tool install --global --add-source ${{ github.workspace }}/nugets Aspire.Cli --prerelease
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

      - name: Run Java SDK validation
        env:
          ASPIRE_CLI_PATH: ${{ github.workspace }}/.dotnet/tools
        run: |
          chmod +x ${{ github.workspace }}/.github/workflows/polyglot-validation/test-java.sh
          ${{ github.workspace }}/.github/workflows/polyglot-validation/test-java.sh

  validate_rust:
    name: Rust SDK Validation
    runs-on: ubuntu-latest
    # Rust SDK has known issues - don't fail the workflow
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup .NET
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4.3.1
        with:
          dotnet-version: '10.0.x'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Download built NuGets
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: built-nugets
          path: ${{ github.workspace }}/nugets

      - name: Install Aspire CLI from built packages
        run: |
          dotnet tool install --global --add-source ${{ github.workspace }}/nugets Aspire.Cli --prerelease
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

      - name: Run Rust SDK validation
        env:
          ASPIRE_CLI_PATH: ${{ github.workspace }}/.dotnet/tools
        run: |
          chmod +x ${{ github.workspace }}/.github/workflows/polyglot-validation/test-rust.sh
          ${{ github.workspace }}/.github/workflows/polyglot-validation/test-rust.sh

  results:
    if: always()
    runs-on: ubuntu-latest
    name: Polyglot Validation Results
    needs: [validate_python, validate_go, validate_java, validate_rust]
    steps:
      - name: Check validation results
        # Only fail on Python, Go, Java failures (Rust has continue-on-error)
        if: >-
          ${{ needs.validate_python.result == 'failure' ||
              needs.validate_go.result == 'failure' ||
              needs.validate_java.result == 'failure' ||
              needs.validate_python.result == 'cancelled' ||
              needs.validate_go.result == 'cancelled' ||
              needs.validate_java.result == 'cancelled' }}
        run: |
          echo "One or more polyglot SDK validations failed."
          echo "Python: ${{ needs.validate_python.result }}"
          echo "Go: ${{ needs.validate_go.result }}"
          echo "Java: ${{ needs.validate_java.result }}"
          exit 1

      - name: Report Rust status
        if: always()
        run: |
          echo "Rust SDK validation: ${{ needs.validate_rust.result }}"
          if [ "${{ needs.validate_rust.result }}" == "failure" ]; then
            echo "⚠️ Rust SDK validation failed (known issues - not blocking)"
          fi
      
      - name: All validations passed
        run: echo "✅ All required polyglot SDK validations passed!"
