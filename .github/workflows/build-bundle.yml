name: Build Bundle (Reusable)

# This workflow creates the Aspire CLI bundle by:
# 1. Downloading the native CLI from the CLI archives workflow
# 2. Building/publishing managed components (Dashboard, NuGetHelper, AppHostServer)
# 3. Assembling everything into a bundle using CreateLayout

on:
  workflow_call:
    inputs:
      versionOverrideArg:
        required: false
        type: string

jobs:
  build_bundle:
    name: Build bundle (${{ matrix.targets.rid }})
    runs-on: ${{ matrix.targets.runner }}
    strategy:
      matrix:
        targets:
          - rid: linux-x64
            runner: 8-core-ubuntu-latest  # Larger runner for bundle disk space
            archive_ext: tar.gz
          - rid: win-x64
            runner: windows-latest
            archive_ext: zip
          - rid: osx-arm64
            runner: macos-latest
            archive_ext: tar.gz

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      # Download CLI archive from previous workflow - this avoids rebuilding native CLI
      - name: Download CLI archive
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806  # v4.1.9
        with:
          name: cli-native-archives-${{ matrix.targets.rid }}
          path: artifacts/packages

      # Download RID-specific NuGet packages (for DCP)
      - name: Download RID-specific NuGets
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806  # v4.1.9
        with:
          name: built-nugets-for-${{ matrix.targets.rid }}
          path: artifacts/packages/Release/Shipping

      # Extract CLI archive to expected location so CreateLayout can find it
      - name: Extract CLI archive
        shell: pwsh
        run: |
          $rid = "${{ matrix.targets.rid }}"
          $ext = if ($rid -eq "win-x64") { "zip" } else { "tar.gz" }
          $destDir = "artifacts/bin/Aspire.Cli/Release/net10.0/$rid/native"
          New-Item -ItemType Directory -Path $destDir -Force | Out-Null
          
          $archive = Get-ChildItem -Path artifacts/packages -Recurse -Filter "aspire-cli-$rid-*.$ext" | Select-Object -First 1
          if (-not $archive) {
            Write-Error "CLI archive not found for $rid"
            exit 1
          }
          Write-Host "Extracting $($archive.FullName) to $destDir"
          
          if ($ext -eq "zip") {
            Expand-Archive -Path $archive.FullName -DestinationPath $destDir -Force
          } else {
            tar -xzf $archive.FullName -C $destDir
          }
          Get-ChildItem $destDir

      # Build bundle directly via MSBuild - skips native CLI build, uses pre-extracted CLI
      - name: Build bundle
        shell: pwsh
        run: |
          $dotnetCmd = if ($IsWindows) { "./dotnet.cmd" } else { "./dotnet.sh" }
          & $dotnetCmd msbuild eng/Bundle.proj `
            /restore `
            /p:Configuration=Release `
            /p:TargetRid=${{ matrix.targets.rid }} `
            /p:SkipNativeBuild=true `
            /p:ContinuousIntegrationBuild=true `
            /bl:${{ github.workspace }}/artifacts/log/Release/Bundle.binlog `
            ${{ inputs.versionOverrideArg }}

      - name: Upload bundle
        if: success()
        uses: actions/upload-artifact@4cec3d8aa04e39d1a68397de0c4cd6fb9dce8ec1  # v4.6.1
        with:
          name: aspire-bundle-${{ matrix.targets.rid }}
          path: artifacts/bundle/${{ matrix.targets.rid }}
          retention-days: 15
          if-no-files-found: error

      - name: Upload bundle archive
        if: success()
        uses: actions/upload-artifact@4cec3d8aa04e39d1a68397de0c4cd6fb9dce8ec1  # v4.6.1
        with:
          name: aspire-bundle-archive-${{ matrix.targets.rid }}
          path: artifacts/bundle/*.${{ matrix.targets.archive_ext }}
          retention-days: 15
          if-no-files-found: warn

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@4cec3d8aa04e39d1a68397de0c4cd6fb9dce8ec1  # v4.6.1
        with:
          name: bundle-logs-${{ matrix.targets.rid }}
          path: artifacts/log/**
