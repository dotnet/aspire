name: Backmerge Release to Main

on:
  schedule:
    - cron: '0 0 * * *'  # Runs daily at 00:00 UTC (16:00 PST / 17:00 PDT)
  workflow_dispatch:      # Allow manual trigger

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  backmerge:
    runs-on: ubuntu-latest
    if: ${{ github.repository_owner == 'dotnet' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 0  # Full history needed for merge

      - name: Check for changes to backmerge
        id: check
        run: |
          git fetch origin main release/13.2
          BEHIND_COUNT=$(git rev-list --count origin/main..origin/release/13.2)
          echo "behind_count=$BEHIND_COUNT" >> $GITHUB_OUTPUT
          if [ "$BEHIND_COUNT" -gt 0 ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Found $BEHIND_COUNT commits in release/13.2 not in main"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes to backmerge - release/13.2 is up-to-date with main"
          fi

      - name: Attempt merge and create branch
        if: steps.check.outputs.changes == 'true'
        id: merge
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout origin/main
          git checkout -b backmerge/release-13.2-to-main

          # Attempt the merge
          if git merge origin/release/13.2 --no-edit; then
            echo "merge_success=true" >> $GITHUB_OUTPUT
            git push origin backmerge/release-13.2-to-main --force
            echo "Merge successful, branch pushed"
          else
            echo "merge_success=false" >> $GITHUB_OUTPUT
            git merge --abort
            echo "Merge conflicts detected"
          fi

      - name: Create Pull Request
        if: steps.check.outputs.changes == 'true' && steps.merge.outputs.merge_success == 'true'
        id: create-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          PR_BRANCH="backmerge/release-13.2-to-main"
          PR_BASE="main"
          PR_TITLE="[Automated] Backmerge release/13.2 to main"

          PR_BODY=$(cat << 'EOF'
          ## Automated Backmerge

          This PR merges changes from `release/13.2` back into `main`.

          **Commits to merge:** ${{ steps.check.outputs.behind_count }}

          This PR was created automatically to keep `main` up-to-date with release branch changes.
          Once approved, it will auto-merge.

          ---
          *This PR was generated by the [backmerge-release](${{ github.server_url }}/${{ github.repository }}/actions/workflows/backmerge-release.yml) workflow.*
          EOF
          )

          # If a PR already exists for this branch/base pair, reuse it; otherwise create a new one.
          if gh pr view "$PR_BRANCH" --base "$PR_BASE" > /dev/null 2>&1; then
            PR_NUMBER=$(gh pr view "$PR_BRANCH" --base "$PR_BASE" --json number --jq .number)
          else
            PR_NUMBER=$(gh pr create \
              --base "$PR_BASE" \
              --head "$PR_BRANCH" \
              --title "$PR_TITLE" \
              --body "$PR_BODY" \
              --assignee "joperezr,radical" \
              --label "area-engineering-systems" \
              --json number \
              --jq .number)
          fi

          echo "pull-request-number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
      - name: Enable auto-merge
        if: steps.create-pr.outputs.pull-request-number
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr merge ${{ steps.create-pr.outputs.pull-request-number }} --auto --merge

      - name: Create issue for merge conflicts
        if: steps.check.outputs.changes == 'true' && steps.merge.outputs.merge_success == 'false'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7.0.1
        with:
          script: |
            const workflowRunUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            // Check if there's already an open issue for this
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'backmerge-conflict',
              creator: 'github-actions[bot]'
            });

            if (existingIssues.data.length > 0) {
              console.log(`Existing backmerge conflict issue found: #${existingIssues.data[0].number}`);
              // Add a comment to the existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssues.data[0].number,
                body: `⚠️ Merge conflicts still exist.\n\n**Workflow run:** ${workflowRunUrl}\n\nPlease resolve the conflicts manually.`
              });
              return;
            }

            // Create a new issue
            const issueBody = [
              '## Backmerge Conflict',
              '',
              'The automated backmerge from `release/13.2` to `main` failed due to merge conflicts.',
              '',
              '### What to do',
              '',
              '1. Checkout main and attempt the merge locally:',
              '   ```bash',
              '   git checkout main',
              '   git pull origin main',
              '   git merge origin/release/13.2',
              '   ```',
              '2. Resolve the conflicts',
              '3. Push the merge commit or create a PR manually',
              '',
              '### Details',
              '',
              `**Workflow run:** ${workflowRunUrl}`,
              '**Commits to merge:** ${{ steps.check.outputs.behind_count }}',
              '',
              '---',
              `*This issue was created automatically by the [backmerge-release](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/workflows/backmerge-release.yml) workflow.*`
            ].join('\n');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '[Backmerge] Merge conflicts between release/13.2 and main',
              body: issueBody,
              assignees: ['joperezr', 'radical'],
              labels: ['area-engineering-systems', 'backmerge-conflict']
            });
