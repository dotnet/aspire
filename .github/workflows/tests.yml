# Executes all the tests on all the platforms
name: Tests

on:
  workflow_call:
    inputs:
      versionOverrideArg:
        required: false
        type: string

jobs:
  # Duplicated jobs so their dependencies are not blocked on both the
  # setup jobs

  setup_for_tests_lin:
    name: Setup for tests (Linux)
    runs-on: ubuntu-latest
    outputs:
      integrations_tests_matrix: ${{ steps.generate_tests_matrix.outputs.integrations_tests_matrix }}
      templates_tests_matrix: ${{ steps.generate_tests_matrix.outputs.templates_tests_matrix }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: ./.github/actions/enumerate-tests
        id: generate_tests_matrix
        with:
          includeIntegrations: true
          includeTemplates: true

  setup_for_tests_macos:
    name: Setup for tests (macOS)
    runs-on: macos-latest
    outputs:
      integrations_tests_matrix: ${{ steps.generate_tests_matrix.outputs.integrations_tests_matrix }}
      templates_tests_matrix: ${{ steps.generate_tests_matrix.outputs.templates_tests_matrix }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: ./.github/actions/enumerate-tests
        id: generate_tests_matrix
        with:
          includeIntegrations: true
          includeTemplates: true

  setup_for_tests_win:
    name: Setup for tests (Windows)
    runs-on: windows-latest
    outputs:
      integrations_tests_matrix: ${{ steps.generate_tests_matrix.outputs.integrations_tests_matrix }}
      templates_tests_matrix: ${{ steps.generate_tests_matrix.outputs.templates_tests_matrix }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: ./.github/actions/enumerate-tests
        id: generate_tests_matrix
        with:
          includeIntegrations: true
          includeTemplates: true

  build_packages:
    name: Build packages
    uses: ./.github/workflows/build-packages.yml
    with:
      versionOverrideArg: ${{ inputs.versionOverrideArg }}

  integrations_test_lin:
    uses: ./.github/workflows/run-tests.yml
    name: Integrations Linux
    needs: setup_for_tests_lin
    strategy:
      fail-fast: false
      matrix:
        ${{ fromJson(needs.setup_for_tests_lin.outputs.integrations_tests_matrix) }}
    with:
      testShortName: ${{ matrix.shortname }}
      os: "ubuntu-latest"
      # Docker tests are run on linux, and Hosting tests take longer to finish
      testSessionTimeout: ${{ matrix.shortname == 'Hosting' && '25m' || '15m' }}
      extraTestArgs: "--filter-not-trait \"quarantined=true\" --filter-not-trait \"outerloop=true\""
      versionOverrideArg: ${{ inputs.versionOverrideArg }}

  integrations_test_macos:
    uses: ./.github/workflows/run-tests.yml
    name: Integrations macos
    needs: setup_for_tests_macos
    strategy:
      fail-fast: false
      matrix:
        ${{ fromJson(needs.setup_for_tests_macos.outputs.integrations_tests_matrix) }}
    with:
      testShortName: ${{ matrix.shortname }}
      os: "macos-latest"
      extraTestArgs: "--filter-not-trait \"quarantined=true\" --filter-not-trait \"outerloop=true\""
      versionOverrideArg: ${{ inputs.versionOverrideArg }}

  integrations_test_win:
    uses: ./.github/workflows/run-tests.yml
    name: Integrations Windows
    needs: setup_for_tests_win
    strategy:
      fail-fast: false
      matrix:
        ${{ fromJson(needs.setup_for_tests_win.outputs.integrations_tests_matrix) }}
    with:
      testShortName: ${{ matrix.shortname }}
      os: "windows-latest"
      extraTestArgs: "--filter-not-trait \"quarantined=true\" --filter-not-trait \"outerloop=true\""
      versionOverrideArg: ${{ inputs.versionOverrideArg }}

  templates_test_lin:
    name: Templates Linux
    uses: ./.github/workflows/run-tests.yml
    needs: [setup_for_tests_lin, build_packages]
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup_for_tests_lin.outputs.templates_tests_matrix) }}
    with:
      testShortName: ${{ matrix.shortname }}
      os: "ubuntu-latest"
      testProjectPath: tests/Aspire.Templates.Tests/Aspire.Templates.Tests.csproj
      testSessionTimeout: 20m
      testHangTimeout: 12m
      extraTestArgs: "--filter-not-trait quarantined=true --filter-not-trait outerloop=true --filter-class Aspire.Templates.Tests.${{ matrix.shortname }}"
      versionOverrideArg: ${{ inputs.versionOverrideArg }}
      requiresNugets: true
      requiresTestSdk: true

  templates_test_macos:
    name: Templates macos
    uses: ./.github/workflows/run-tests.yml
    needs: [setup_for_tests_macos, build_packages]
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup_for_tests_macos.outputs.templates_tests_matrix) }}
    with:
      testShortName: ${{ matrix.shortname }}
      os: "macos-latest"
      testProjectPath: tests/Aspire.Templates.Tests/Aspire.Templates.Tests.csproj
      testSessionTimeout: 20m
      testHangTimeout: 12m
      extraTestArgs: "--filter-not-trait quarantined=true --filter-not-trait outerloop=true --filter-class Aspire.Templates.Tests.${{ matrix.shortname }}"
      versionOverrideArg: ${{ inputs.versionOverrideArg }}
      requiresNugets: true
      requiresTestSdk: true

  templates_test_win:
    name: Templates Windows
    uses: ./.github/workflows/run-tests.yml
    needs: [setup_for_tests_win, build_packages]
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup_for_tests_win.outputs.templates_tests_matrix) }}
    with:
      testShortName: ${{ matrix.shortname }}
      os: "windows-latest"
      testProjectPath: tests/Aspire.Templates.Tests/Aspire.Templates.Tests.csproj
      testSessionTimeout: 20m
      testHangTimeout: 12m
      extraTestArgs: "--filter-not-trait quarantined=true --filter-not-trait outerloop=true --filter-class Aspire.Templates.Tests.${{ matrix.shortname }}"
      versionOverrideArg: ${{ inputs.versionOverrideArg }}
      requiresNugets: true
      requiresTestSdk: true

  endtoend_tests:
    name: EndToEnd Linux
    uses: ./.github/workflows/run-tests.yml
    needs: build_packages
    with:
      testShortName: EndToEnd
      # EndToEnd is not run on Windows/macOS due to missing Docker support
      os: ubuntu-latest
      testProjectPath: tests/Aspire.EndToEnd.Tests/Aspire.EndToEnd.Tests.csproj
      requiresNugets: true
      versionOverrideArg: ${{ inputs.versionOverrideArg }}

  extension_tests_win:
    name: Run VS Code extension tests (Windows)
    runs-on: windows-latest
    defaults:
      run:
        working-directory: ./extension
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Setup Node.js environment
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node-version }}
      - name: Install dependencies
        run: yarn install
      - name: Run tests
        run: yarn test
      - name: Package VSIX
        run: npx @vscode/vsce package --yarn --pre-release -o out/aspire-extension.vsix
      - name: Upload VSIX
        uses: actions/upload-artifact@4cec3d8aa04e39d1a68397de0c4cd6fb9dce8ec1 # v4.6.1
        with:
          name: aspire-extension
          path: extension/out/aspire-extension.vsix

  check_templatestrings:
    name: Check templatestrings files not modified
    runs-on: ubuntu-latest
    needs: build_packages
    if: ${{ github.event_name == 'pull_request' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Restore
        run: ./restore.sh

      - name: Build ProjectTemplates
        run: ./dotnet.sh build ${{ github.workspace }}/src/Aspire.ProjectTemplates/Aspire.ProjectTemplates.csproj /bl:${{ github.workspace }}/artifacts/log/Debug/BuildTemplates.binlog

      - name: Check for modified templatestrings files
        id: check_files
        shell: bash
        run: |
          set -euo pipefail
          
          # Pattern for templatestrings files
          pattern="src/Aspire.ProjectTemplates/templates/*templatestrings.*.json"
          
          # Check for any modified files (staged or unstaged)
          modifiedFiles=$(git diff --name-only -- "$pattern" 2>/dev/null || true)
          
          if [ -z "$modifiedFiles" ]; then
            echo "✓ No modified templatestrings files found - check passed"
            exit 0
          fi
          
          # Check failed - there are modified files
          # Save error message for PR comment
          {
            echo "error_message<<EOF"
            echo "## ❌ Templatestrings files have been modified"
            echo ""
            echo "The following templatestrings JSON files were modified during the build:"
            echo ""
            echo "$modifiedFiles" | while IFS= read -r file; do
              echo "- \`$file\`"
            done
            echo ""
            echo "These files are localization files and should not be modified by the build."
            echo "The modifications need to be committed to source control before proceeding."
            echo ""
            echo "### To fix this issue:"
            echo ""
            echo "1. Review the changes: \`git diff $pattern\`"
            echo "2. If the changes are correct, commit them: \`git add $pattern && git commit\`"
            echo "3. If the changes are incorrect, revert them: \`git checkout -- $pattern\`"
            echo ""
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          # Also print to console
          echo ""
          echo "================================================================================"
          echo "CHECK FAILED: Templatestrings files have been modified"
          echo "================================================================================"
          echo ""
          echo "The following templatestrings JSON files were modified during the build:"
          echo ""
          echo "$modifiedFiles" | while IFS= read -r file; do
            echo "  - $file"
          done
          echo ""
          echo "These files are localization files and should not be modified by the build."
          echo "The modifications need to be committed to source control before proceeding."
          echo ""
          echo "To fix this issue:"
          echo "  1. Review the changes: git diff $pattern"
          echo "  2. If the changes are correct, commit them: git add $pattern && git commit"
          echo "  3. If the changes are incorrect, revert them: git checkout -- $pattern"
          echo ""
          echo "================================================================================"
          echo ""
          exit 1

      - name: Post PR comment on failure
        if: failure() && steps.check_files.outputs.error_message != ''
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const errorMessage = `${{ steps.check_files.outputs.error_message }}`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: errorMessage
            });

      - name: Upload binlog
        if: always()
        uses: actions/upload-artifact@4cec3d8aa04e39d1a68397de0c4cd6fb9dce8ec1 # v4.6.1
        with:
          name: check-templatestrings-binlog
          path: ${{ github.workspace }}/artifacts/log/Debug/BuildTemplates.binlog
          if-no-files-found: warn

  results:
    if: ${{ always() && github.repository_owner == 'dotnet' }}
    runs-on: ubuntu-latest
    name: Final Test Results
    needs: [
      check_templatestrings,
      endtoend_tests,
      extension_tests_win,
      integrations_test_lin,
      integrations_test_macos,
      integrations_test_win,
      templates_test_lin,
      templates_test_macos,
      templates_test_win
    ]
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          pattern: logs-*-ubuntu-latest
          merge-multiple: true
          path: ${{ github.workspace }}/testresults/ubuntu-latest

      - uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          pattern: logs-*-windows-latest
          merge-multiple: true
          path: ${{ github.workspace }}/testresults/windows-latest

      - uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          pattern: logs-*-macos-latest
          merge-multiple: true
          path: testresults/macos-latest

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@4cec3d8aa04e39d1a68397de0c4cd6fb9dce8ec1 # v4.6.1
        with:
          name: All-TestResults
          path: ${{ github.workspace }}/testresults/**/*.trx

      - name: Generate test results summary
        if: always()
        run: >
          ${{ github.workspace }}/dotnet.sh
          run
          --project ${{ github.workspace }}/tools/GenerateTestSummary/GenerateTestSummary.csproj
          --
          ${{ github.workspace }}/testresults
          --combined

      - name: Fail if any dependency failed
        # 'skipped' can be when a transitive dependency fails and the dependent job gets 'skipped'.
        # For example, one of setup_* jobs failing and the Integration test jobs getting 'skipped'
        if: ${{ always() && (contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled') || contains(needs.*.result, 'skipped')) }}
        run: |
          echo "One or more dependent jobs failed."
          exit 1
