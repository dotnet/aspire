name: Build native CLI archives

on:
  workflow_call:
    inputs:
      versionOverrideArg:
        required: false
        type: string

jobs:

  build_cli_archives:
    name: Build CLI (${{ matrix.targets.os }})
    runs-on: ${{ matrix.targets.os }}
    strategy:
      matrix:
        targets:
          - os: ubuntu-latest
            rids: linux-x64
          - os: windows-latest
            rids: win-x64
          - os: macos-latest
            rids: osx-arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Build CLI packages (Windows)
        env:
          CI: false
        if: ${{ matrix.targets.os == 'windows-latest' }}
        shell: pwsh
        run: >
          .\build.cmd
          -ci
          -build
          -restore
          /bl:${{ github.workspace }}/artifacts/log/Debug/BuildCli.binlog
          /p:ContinuousIntegrationBuild=true
          /p:SkipManagedBuild=true
          /p:TargetRids=${{ matrix.targets.rids }}
          ${{ inputs.versionOverrideArg }}

      - name: Build CLI packages (Unix)
        env:
          CI: false
        if: ${{ matrix.targets.os != 'windows-latest' }}
        shell: bash
        run: >
          ./build.sh
          --ci
          --build
          --restore
          /bl:${{ github.workspace }}/artifacts/log/Debug/BuildCli.binlog
          /p:ContinuousIntegrationBuild=true
          /p:SkipManagedBuild=true
          /p:TargetRids=${{ matrix.targets.rids }}
          ${{ inputs.versionOverrideArg }}

      - name: Check CLI executable size (Windows)
        if: ${{ matrix.targets.os == 'windows-latest' }}
        shell: pwsh
        run: |
          # Find the aspire.exe executable in the build output
          $aspireExe = Get-ChildItem -Path "${{ github.workspace }}/artifacts/bin/Aspire.Cli/Release" -Filter "aspire.exe" -Recurse | Where-Object { $_.FullName -match "native" } | Select-Object -First 1
          if (-not $aspireExe) {
            Write-Error "Could not find aspire.exe executable in artifacts directory"
            exit 1
          }
          
          $sizeBytes = $aspireExe.Length
          $sizeMB = [Math]::Round($sizeBytes / 1024 / 1024, 2)
          $maxSizeMB = 20
          
          Write-Host "aspire.exe size: $sizeMB MB ($sizeBytes bytes)"
          Write-Host "Location: $($aspireExe.FullName)"
          
          if ($sizeMB -gt $maxSizeMB) {
            Write-Error "aspire.exe size ($sizeMB MB) exceeds maximum allowed size of $maxSizeMB MB"
            exit 1
          }
          
          Write-Host "✅ aspire.exe size check passed ($sizeMB MB <= $maxSizeMB MB)"

      - name: Check CLI executable size (Unix)
        if: ${{ matrix.targets.os != 'windows-latest' }}
        shell: bash
        run: |
          # Find the aspire executable in the build output
          aspire_exe=$(find "${{ github.workspace }}/artifacts/bin/Aspire.Cli/Release" -name "aspire" -type f | grep native | head -1)
          if [[ -z "$aspire_exe" ]]; then
            echo "Could not find aspire executable in artifacts directory"
            exit 1
          fi
          
          max_size_mb=25 # Unix is larger than Windows
          max_size_bytes=$((max_size_mb * 1024 * 1024))
          size_bytes=$(stat -c%s "$aspire_exe" 2>/dev/null || stat -f%z "$aspire_exe" 2>/dev/null)
          if [[ -z "$size_bytes" ]] || ! [[ "$size_bytes" =~ ^[0-9]+$ ]]; then
            echo "Failed to retrieve size of aspire executable (stat command failed or returned invalid output)"
            exit 1
          fi
          size_mb=$((size_bytes / 1024 / 1024))
          
          echo "aspire size: ${size_mb} MB (${size_bytes} bytes)"
          echo "Location: $aspire_exe"
          
          if (( size_bytes > max_size_bytes )); then
            echo "aspire size (${size_bytes} bytes) exceeds maximum allowed size of ${max_size_bytes} bytes (${max_size_mb} MB)"
            exit 1
          fi
          
          echo "✅ aspire size check passed (${size_mb} MB <= ${max_size_mb} MB)"

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@4cec3d8aa04e39d1a68397de0c4cd6fb9dce8ec1  # v4.6.1
        with:
          name: cli-native-logs-${{ matrix.targets.rids }}
          path: artifacts/log/**

      - name: Upload CLI archives
        if: success()
        uses: actions/upload-artifact@4cec3d8aa04e39d1a68397de0c4cd6fb9dce8ec1  # v4.6.1
        with:
          name: cli-native-archives-${{ matrix.targets.rids }}
          path: artifacts/packages/**/aspire-cli*
          retention-days: 15
          if-no-files-found: error
