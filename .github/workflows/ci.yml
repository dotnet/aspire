name: CI

on:
  pull_request:
    branches:
      - main
      - 'release/**'

  push:
    branches:
      - main
      - 'release/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:

  check_changes:
    runs-on: ubuntu-latest
    name: Check Changed Files
    if: ${{ github.repository_owner == 'dotnet' }}
    outputs:
      only_docs_changed: ${{ steps.check_docs.outputs.only_changed || 'false' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 0
      - name: Check if only documentation changed
        id: check_docs
        if: ${{ github.event_name == 'pull_request' }}
        uses: ./.github/actions/check-changed-files
        with:
          patterns: |
            \.md$
            \.yml$

  tests:
    uses: ./.github/workflows/tests.yml
    name: Tests
    needs: [check_changes]
    # Skip tests only if this is a PR and only docs changed
    if: ${{ github.repository_owner == 'dotnet' && needs.check_changes.outputs.only_docs_changed != 'true' }}

  build_cli_archives:
    uses: ./.github/workflows/build-cli-native-archives.yml
    name: Build native CLI archives
    needs: [check_changes]
    # Skip CLI build only if this is a PR and only docs changed
    if: ${{ github.repository_owner == 'dotnet' && needs.check_changes.outputs.only_docs_changed != 'true' }}

  # This job is used for branch protection. It ensures all the jobs have passed
  results:
    if: ${{ always() }}
    runs-on: ubuntu-latest
    name: Final Results
    needs: [tests, build_cli_archives]

    steps:
      - name: Fail if any of the dependent jobs failed
        # 'skipped' can be when a transitive dependency fails and the dependent job gets 'skipped'.
        # For example, one of setup_* jobs failing and the Integration test jobs getting 'skipped'
        if: ${{ always() && (contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled') || contains(needs.*.result, 'skipped')) }}
        run: |
          echo "One or more dependent jobs failed."
          exit 1
