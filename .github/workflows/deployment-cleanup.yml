# Cleanup workflow for deployment test resources
#
# Runs hourly to remove orphaned Azure resource groups from deployment tests.
# Resource groups older than 3 hours are deleted.
#
# Resource group naming format: aspire-e2e-{hash}-{YYYYMMDDHHMMSS}-{runId}
# The timestamp is parsed to determine age.
#
name: Deployment Environment Cleanup

on:
  schedule:
    # Run every hour
    - cron: '0 * * * *'

  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (list but do not delete)'
        required: false
        type: boolean
        default: false
      max_age_hours:
        description: 'Delete RGs older than this many hours'
        required: false
        type: number
        default: 3

# OIDC permissions for Azure login
permissions:
  id-token: write
  contents: read
  pull-requests: write  # For posting PR comments

jobs:
  cleanup:
    name: Cleanup Azure Resources
    runs-on: ubuntu-latest
    if: ${{ github.repository_owner == 'dotnet' }}
    environment: deployment-testing

    steps:
      - name: Azure Login (OIDC)
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_DEPLOYMENT_TEST_CLIENT_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_DEPLOYMENT_TEST_TENANT_ID }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_DEPLOYMENT_TEST_SUBSCRIPTION_ID }}
        with:
          script: |
            const token = await core.getIDToken('api://AzureADTokenExchange');
            core.setSecret(token);
            
            // Login directly - token never leaves this step
            await exec.exec('az', [
              'login', '--service-principal',
              '--username', process.env.AZURE_CLIENT_ID,
              '--tenant', process.env.AZURE_TENANT_ID,
              '--federated-token', token,
              '--allow-no-subscriptions'
            ]);
            
            await exec.exec('az', [
              'account', 'set',
              '--subscription', process.env.AZURE_SUBSCRIPTION_ID
            ]);

      - name: Cleanup old resource groups
        id: cleanup
        env:
          DRY_RUN: ${{ inputs.dry_run || 'false' }}
          MAX_AGE_HOURS: ${{ inputs.max_age_hours || '3' }}
        run: |
          echo "## Deployment Environment Cleanup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Max Age:** ${MAX_AGE_HOURS} hours" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run:** ${DRY_RUN}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Get current time in seconds since epoch
          NOW=$(date +%s)
          MAX_AGE_SECONDS=$((MAX_AGE_HOURS * 3600))

          # List all resource groups matching our prefixes (rg-aspire-* from aspire deploy, aspire-e2e-* legacy)
          RG_LIST=$(az group list --query "[?starts_with(name, 'rg-aspire-') || starts_with(name, 'aspire-e2e-')].name" -o tsv || echo "")

          if [ -z "$RG_LIST" ]; then
            echo "No resource groups found matching deployment test prefixes."
            echo "âœ… No resource groups found matching prefixes." >> $GITHUB_STEP_SUMMARY
            echo "deleted_count=0" >> $GITHUB_OUTPUT
            echo "skipped_count=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          DELETED_COUNT=0
          SKIPPED_COUNT=0
          DELETED_LIST=""
          SKIPPED_LIST=""

          echo "### Resource Groups Processed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Group | Age | Action |" >> $GITHUB_STEP_SUMMARY
          echo "|----------------|-----|--------|" >> $GITHUB_STEP_SUMMARY

          for RG in $RG_LIST; do
            echo "Processing: $RG"

            # Get resource group creation time from Azure (tags.createdAt or fall back to managed-by tag timestamp)
            # We use the resource group's properties since name patterns vary
            RG_INFO=$(az group show -n "$RG" --query "{createdAt:tags.createdAt}" -o tsv 2>/dev/null || echo "")
            
            if [ -z "$RG_INFO" ] || [ "$RG_INFO" = "None" ]; then
              # No createdAt tag - check if there's a timestamp in the name (legacy aspire-e2e-* format)
              TIMESTAMP=$(echo "$RG" | grep -oE '[0-9]{14}' | head -1)
              if [ -n "$TIMESTAMP" ]; then
                # Parse timestamp from name (YYYYMMDDHHMMSS)
                YEAR=${TIMESTAMP:0:4}
                MONTH=${TIMESTAMP:4:2}
                DAY=${TIMESTAMP:6:2}
                HOUR=${TIMESTAMP:8:2}
                MIN=${TIMESTAMP:10:2}
                SEC=${TIMESTAMP:12:2}
                RG_EPOCH=$(date -u -d "${YEAR}-${MONTH}-${DAY} ${HOUR}:${MIN}:${SEC}" +%s 2>/dev/null || echo "0")
              else
                # No timestamp available - delete if it matches our prefix (orphaned resource)
                echo "  âš ï¸ No timestamp found, treating as old: $RG"
                RG_EPOCH=0
              fi
            else
              # Parse ISO8601 timestamp from tag
              RG_EPOCH=$(date -u -d "$RG_INFO" +%s 2>/dev/null || echo "0")
            fi

            # Calculate age
            if [ "$RG_EPOCH" = "0" ]; then
              AGE_HOURS="unknown"
              AGE_DISPLAY="unknown"
              # Treat unknown age as old (delete it)
              SHOULD_DELETE=true
            else
              AGE_SECONDS=$((NOW - RG_EPOCH))
              AGE_HOURS=$((AGE_SECONDS / 3600))
              AGE_MINS=$(((AGE_SECONDS % 3600) / 60))
              AGE_DISPLAY="${AGE_HOURS}h ${AGE_MINS}m"
              if [ $AGE_SECONDS -gt $MAX_AGE_SECONDS ]; then
                SHOULD_DELETE=true
              else
                SHOULD_DELETE=false
              fi
            fi

            if [ "$SHOULD_DELETE" = "true" ]; then
              if [ "$DRY_RUN" = "true" ]; then
                echo "  ðŸ” Would delete: $RG (age: $AGE_DISPLAY)"
                echo "| $RG | $AGE_DISPLAY | ðŸ” Would delete (dry run) |" >> $GITHUB_STEP_SUMMARY
              else
                echo "  ðŸ—‘ï¸ Deleting: $RG (age: $AGE_DISPLAY)"
                az group delete --name "$RG" --yes --no-wait || echo "  âš ï¸ Failed to delete $RG"
                echo "| $RG | $AGE_DISPLAY | ðŸ—‘ï¸ Deleted |" >> $GITHUB_STEP_SUMMARY
              fi
              DELETED_COUNT=$((DELETED_COUNT + 1))
              DELETED_LIST="${DELETED_LIST}${RG}\n"
            else
              echo "  âœ… Keeping: $RG (age: $AGE_DISPLAY, under threshold)"
              echo "| $RG | $AGE_DISPLAY | âœ… Kept (recent) |" >> $GITHUB_STEP_SUMMARY
              SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$DRY_RUN" = "true" ]; then
            echo "- **Would delete:** $DELETED_COUNT resource groups" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Deleted:** $DELETED_COUNT resource groups" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Kept/Skipped:** $SKIPPED_COUNT resource groups" >> $GITHUB_STEP_SUMMARY

          echo "deleted_count=$DELETED_COUNT" >> $GITHUB_OUTPUT
          echo "skipped_count=$SKIPPED_COUNT" >> $GITHUB_OUTPUT
          echo "deleted_list<<EOF" >> $GITHUB_OUTPUT
          echo -e "$DELETED_LIST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Find associated PR (if any)
        id: find_pr
        if: ${{ steps.cleanup.outputs.deleted_count != '0' }}
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            // Check if this workflow was triggered by a PR or has associated PRs
            // For scheduled runs, we won't have a PR context
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:deploy-test/initial-infrastructure`,
              per_page: 1
            });

            if (prs.length > 0) {
              core.setOutput('pr_number', prs[0].number);
              core.setOutput('has_pr', 'true');
            } else {
              core.setOutput('has_pr', 'false');
            }

      - name: Post cleanup results to PR
        if: ${{ steps.find_pr.outputs.has_pr == 'true' && steps.cleanup.outputs.deleted_count != '0' }}
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const prNumber = ${{ steps.find_pr.outputs.pr_number }};
            const deletedCount = ${{ steps.cleanup.outputs.deleted_count }};
            const skippedCount = ${{ steps.cleanup.outputs.skipped_count }};
            const deletedList = `${{ steps.cleanup.outputs.deleted_list }}`.trim();

            let body = `## ðŸ§¹ Deployment Environment Cleanup\n\n`;
            body += `**Deleted:** ${deletedCount} resource groups\n`;
            body += `**Kept/Skipped:** ${skippedCount} resource groups\n\n`;

            if (deletedList) {
              body += `### Deleted Resource Groups\n\`\`\`\n${deletedList}\n\`\`\`\n`;
            }

            body += `\n[View workflow run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

            console.log(`Posted cleanup results to PR #${prNumber}`);
