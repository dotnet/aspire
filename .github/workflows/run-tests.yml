name: Run Tests

on:
  workflow_call:
    inputs:
      testProject:
        required: true
        type: string
      testName:
        required: true
        type: string
      testSessionTimeoutMs:
        required: false
        type: string
      testHangTimeout:
        required: false
        type: string
        default: "7m"
      extraArgs:
        required: false
        type: string
      isWorkloadTests:
        required: false
        type: boolean

jobs:

  test:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    name: ${{ inputs.testName }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up .NET Core
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.x
            9.x

      - name: Trust HTTPS development certificate
        run: dotnet dev-certs https --trust

      - name: Verify Docker is running
        run: docker info

      - name: Install Azure Functions Core Tools
        if: inputs.testName == 'Playground' || inputs.testName == 'Azure'
        run: |
          sudo apt-get update
          sudo apt-get install -y azure-functions-core-tools-4

      - name: Download built nugets
        if: ${{ inputs.isWorkloadTests }}
        uses: actions/download-artifact@v4
        with:
          name: built-nugets
          path: artifacts/packages

      - name: Download artifacts for template tests
        if: ${{ inputs.isWorkloadTests }}
        uses: actions/download-artifact@v4
        with:
          name: workload-artifacts
          path: artifacts/bin

      - name: Fix up permissions
        if: ${{ inputs.isWorkloadTests }}
        run: |
          chmod +x artifacts/bin/dotnet-*/dotnet && \
          chmod -R +x artifacts/bin/playwright-deps

      - name: Build test project
        env:
          CI: false
        run: |
          ./build.sh -restore -ci -build -projects ${{ github.workspace }}/${{ inputs.testProject }} /bl

      # Workaround for bug in Azure Functions Worker SDK. See https://github.com/Azure/azure-functions-dotnet-worker/issues/2969.
      - name: Rebuild for Azure Functions project
        if: inputs.testName == 'Playground'
        env:
          CI: false
        run: |
          ./dotnet.sh build ${{ github.workspace }}/playground/AzureFunctionsEndToEnd/AzureFunctionsEndToEnd.Functions/AzureFunctionsEndToEnd.Functions.csproj /p:SkipUnstableEmulators=true

      - name: Run tests
        id: run-tests
        env:
          CI: false
          TEMPLATE_TESTS_ON_GITHUB_ACTIONS: ${{ inputs.testName == 'Workload' }}
          DCP_DIAGNOSTICS_LOG_LEVEL: debug
          DCP_DIAGNOSTICS_LOG_FOLDER: ${{ github.workspace }}/testresults/dcp
        run: |
          ./dotnet.sh test ${{ github.workspace }}/${{ inputs.testProject }} \
            /p:ContinuousIntegrationBuild=true \
            -s eng/testing/.runsettings \
            --logger "console;verbosity=normal" \
            --logger "trx" \
            --logger "GitHubActions;summary.includePassedTests=true;summary.includeSkippedTests=true" \
            --blame \
            --blame-hang-timeout ${{ inputs.testHangTimeout }} \
            --blame-crash \
            --results-directory testresults \
            --no-restore \
            --no-build \
            ${{ inputs.extraArgs }} \
            -- \
            RunConfiguration.CollectSourceInformation=true \
            RunConfiguration.TestSessionTimeout=${{ inputs.testSessionTimeoutMs || 600000 }}

      # Save the result of the previous steps - success or failure
      # in the form of a file result-success/result-failure -{name}.rst
      - name: Store result - success
        if: ${{ success() }}
        run: touch result-success-${{ inputs.testName }}.rst
      - name: Store result - failure
        if: ${{ !success() }}
        run: touch result-failed-${{ inputs.testName }}.rst

      # Upload that result file to artifact named test-job-result-{name}
      - name: Upload test result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-job-result-${{ inputs.testName }}
          path: result-*.rst


      - name: Dump docker info
        if: always()
        run: |
          docker container ls --all
          docker container ls --all --format json
          docker volume ls
          docker network ls

      - name: Upload bin log artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: binlog-${{ inputs.testName }}
          path: "**/*.binlog"

      - name: Upload test results artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: testresults-${{ inputs.testName }}
          path: testresults/**
