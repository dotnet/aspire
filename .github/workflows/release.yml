name: GitHub Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v13.1.0, v13.1.0-preview.1, etc.

permissions:
  contents: write  # Required to create releases

jobs:
  create_release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    if: ${{ github.repository_owner == 'dotnet' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 0  # Fetch full history for release notes generation

      - name: Extract version from tag
        id: get_version
        run: |
          TAG=${GITHUB_REF#refs/tags/v}
          echo "version=$TAG" >> $GITHUB_OUTPUT
          echo "Version: $TAG"

      - name: Build packages for release
        run: ./build.sh -restore -build -build-extension -ci -pack -bl -p:InstallBrowsersForPlaywright=false -p:SkipTestProjects=true -p:SkipPlaygroundProjects=true

      - name: Build native CLI archives
        run: |
          echo "Building native CLI archives for all platforms..."
          # Build Linux x64
          ./build.sh --ci --build --restore /p:SkipManagedBuild=true /p:TargetRids=linux-x64
          # Build Windows x64
          ./build.sh --ci --build /p:SkipManagedBuild=true /p:TargetRids=win-x64
          # Build macOS arm64
          ./build.sh --ci --build /p:SkipManagedBuild=true /p:TargetRids=osx-arm64

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          TAG="v$VERSION"
          
          # Generate release notes
          echo "## .NET Aspire $VERSION" > release_notes.md
          echo "" >> release_notes.md
          echo "### NuGet Packages" >> release_notes.md
          echo "" >> release_notes.md
          echo "The packages for this release are available on [NuGet.org](https://www.nuget.org/packages?q=Aspire):" >> release_notes.md
          echo "" >> release_notes.md
          echo "- [Aspire.Hosting](https://www.nuget.org/packages/Aspire.Hosting/$VERSION)" >> release_notes.md
          echo "- [Aspire.Hosting.AppHost](https://www.nuget.org/packages/Aspire.Hosting.AppHost/$VERSION)" >> release_notes.md
          echo "- [View all Aspire packages](https://www.nuget.org/packages?q=Aspire)" >> release_notes.md
          echo "" >> release_notes.md
          echo "### CLI Installation" >> release_notes.md
          echo "" >> release_notes.md
          echo "Download the native CLI archives below or install via:" >> release_notes.md
          echo '```bash' >> release_notes.md
          echo 'dotnet tool install -g Aspire.Cli' >> release_notes.md
          echo '```' >> release_notes.md
          echo "" >> release_notes.md
          echo "### What's Changed" >> release_notes.md
          echo "" >> release_notes.md
          
          # Get the previous tag for comparison
          PREV_TAG=$(git describe --tags --abbrev=0 $TAG^ 2>/dev/null || echo "")
          
          if [ -n "$PREV_TAG" ]; then
            echo "Changes since $PREV_TAG:" >> release_notes.md
            echo "" >> release_notes.md
            git log --pretty=format:"- %s (%an)" $PREV_TAG..$TAG >> release_notes.md
          else
            echo "Initial release" >> release_notes.md
          fi
          
          # Create the release with CLI archives as assets
          gh release create "$TAG" \
            --title ".NET Aspire $VERSION" \
            --notes-file release_notes.md \
            --draft \
            artifacts/packages/**/aspire-cli*.tar.gz \
            artifacts/packages/**/aspire-cli*.zip || true

      - name: Upload release artifacts
        if: always()
        uses: actions/upload-artifact@4cec3d8aa04e39d1a68397de0c4cd6fb9dce8ec1  # v4.6.1
        with:
          name: release-artifacts
          path: |
            artifacts/packages/**/aspire-cli*
            release_notes.md
          retention-days: 30
