# End-to-end deployment tests that deploy Aspire applications to real Azure infrastructure
#
# Triggers:
# - workflow_dispatch: Manual trigger with scenario selection
# - schedule: Nightly at 03:00 UTC
# - push to deploy-test/* branches: Rapid iteration during development
#
# Security:
# - Uses OIDC (Workload Identity Federation) for Azure authentication
# - No stored Azure secrets
# - deploy-test/* branches protected via branch protection rules
#
name: Deployment E2E Tests

on:
  workflow_dispatch:
    inputs:
      scenario:
        description: 'Test scenario to run (leave empty for all)'
        required: false
        type: string
        default: ''
      pr_number:
        description: 'PR number to test (for testing PR builds)'
        required: false
        type: string
        default: ''

  schedule:
    # Run nightly at 03:00 UTC
    - cron: '0 3 * * *'

  push:
    branches:
      - 'deploy-test/**'

# Limit concurrent runs to avoid Azure quota issues
concurrency:
  group: deployment-e2e-${{ github.ref }}
  cancel-in-progress: true

# OIDC permissions for Azure login
permissions:
  id-token: write
  contents: read
  issues: write  # For creating issues on failure

jobs:
  # Run deployment tests
  deployment_tests:
    name: Deployment Tests
    runs-on: 8-core-ubuntu-latest  # Larger runner for disk space
    if: ${{ github.repository_owner == 'dotnet' }}
    environment: deployment-testing  # GitHub environment with OIDC configuration
    env:
      # Environment-level variables are accessed here within the job that uses the environment
      ASPIRE_DEPLOYMENT_TEST_SUBSCRIPTION: ${{ vars.AZURE_DEPLOYMENT_TEST_SUBSCRIPTION_ID }}
      ASPIRE_DEPLOYMENT_TEST_RG_PREFIX: ${{ vars.ASPIRE_DEPLOYMENT_TEST_RG_PREFIX || 'aspire-e2e' }}

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Get OIDC token
        id: oidc
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const token = await core.getIDToken('api://AzureADTokenExchange');
            core.setOutput('token', token);

      - name: Azure Login (OIDC via CLI)
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_DEPLOYMENT_TEST_CLIENT_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_DEPLOYMENT_TEST_TENANT_ID }}
          AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_DEPLOYMENT_TEST_SUBSCRIPTION_ID }}
        run: |
          az login --service-principal \
            --username "$AZURE_CLIENT_ID" \
            --tenant "$AZURE_TENANT_ID" \
            --federated-token "${{ steps.oidc.outputs.token }}" \
            --allow-no-subscriptions
          az account set --subscription "$AZURE_SUBSCRIPTION_ID"

      - name: Verify Azure authentication
        run: |
          echo "Verifying Azure authentication..."
          az account show --query "{subscriptionId:id, tenantId:tenantId, user:user.name}" -o table
          echo "âœ… Azure authentication successful"

      - name: Setup .NET
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4.3.1
        with:
          global-json-file: global.json

      - name: Restore and build test project only
        run: |
          # Only restore and build the test project (not full solution)
          ./dotnet.sh restore tests/Aspire.Deployment.EndToEnd.Tests/Aspire.Deployment.EndToEnd.Tests.csproj
          ./dotnet.sh build tests/Aspire.Deployment.EndToEnd.Tests/Aspire.Deployment.EndToEnd.Tests.csproj -c Release --no-restore

      - name: Run deployment tests
        id: run_tests
        env:
          GITHUB_PR_NUMBER: ${{ inputs.pr_number || '' }}
          GITHUB_PR_HEAD_SHA: ${{ github.sha }}
          AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_DEPLOYMENT_TEST_SUBSCRIPTION_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_DEPLOYMENT_TEST_TENANT_ID }}
          AZURE_CLIENT_ID: ${{ secrets.AZURE_DEPLOYMENT_TEST_CLIENT_ID }}
          GH_TOKEN: ${{ github.token }}
        run: |
          TEST_FILTER=""
          if [ -n "${{ inputs.scenario }}" ]; then
            TEST_FILTER="--filter-class *.${{ inputs.scenario }}*"
          fi

          ./dotnet.sh test tests/Aspire.Deployment.EndToEnd.Tests/Aspire.Deployment.EndToEnd.Tests.csproj \
            -c Release \
            --no-build \
            --logger "trx;LogFileName=deployment-tests.trx" \
            --results-directory ${{ github.workspace }}/testresults \
            -- \
            --filter-not-trait "quarantined=true" \
            $TEST_FILTER \
            || echo "test_failed=true" >> $GITHUB_OUTPUT

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@4cec3d8aa04e39d1a68397de0c4cd6fb9dce8ec1 # v4.6.1
        with:
          name: deployment-test-results
          path: |
            ${{ github.workspace }}/testresults/
          retention-days: 30

      - name: Upload recordings
        if: always()
        uses: actions/upload-artifact@4cec3d8aa04e39d1a68397de0c4cd6fb9dce8ec1 # v4.6.1
        with:
          name: deployment-test-recordings
          path: |
            ${{ github.workspace }}/testresults/recordings/
          retention-days: 30
          if-no-files-found: ignore

      - name: Check for test failures
        if: steps.run_tests.outputs.test_failed == 'true'
        run: |
          echo "::error::Deployment tests failed. Check the test results artifact for details."
          exit 1

  # Create GitHub issue on nightly failure
  create_issue_on_failure:
    name: Create Issue on Failure
    needs: [deployment_tests]
    runs-on: ubuntu-latest
    if: ${{ failure() && github.event_name == 'schedule' }}
    permissions:
      issues: write
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Create GitHub Issue
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const date = new Date().toISOString().split('T')[0];

            const issueTitle = `[Deployment E2E] Nightly test failure - ${date}`;
            const issueBody = `## Deployment E2E Test Failure

            The nightly deployment E2E tests failed on ${date}.

            **Workflow Run:** ${runUrl}

            ### Next Steps
            1. Check the workflow run for detailed error logs
            2. Download test artifacts for asciinema recordings
            3. Investigate and fix the failing tests

            ### Labels
            This issue was automatically created by the deployment E2E test workflow.

            /cc @dotnet/aspire-team
            `;

            // Check if a similar issue already exists (created today)
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'area-testing,deployment-e2e',
              per_page: 10
            });

            const todayIssue = existingIssues.data.find(issue =>
              issue.title.includes(date) && issue.title.includes('[Deployment E2E]')
            );

            if (todayIssue) {
              console.log(`Issue already exists for today: ${todayIssue.html_url}`);
              // Add a comment instead
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: todayIssue.number,
                body: `Another failure occurred. See: ${runUrl}`
              });
            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['area-testing', 'deployment-e2e']
              });
              console.log(`Created issue: ${issue.data.html_url}`);
            }
