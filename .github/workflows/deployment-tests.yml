# End-to-end deployment tests that deploy Aspire applications to real Azure infrastructure
#
# Triggers:
# - workflow_dispatch: Manual trigger with scenario selection
# - schedule: Nightly at 03:00 UTC
# - /deployment-test command on PRs (via deployment-test-command.yml)
#
# Security:
# - Uses OIDC (Workload Identity Federation) for Azure authentication
# - No stored Azure secrets
# - Only dotnet org members can trigger via PR command
#
name: Deployment E2E Tests

on:
  workflow_dispatch:
    inputs:
      scenario:
        description: 'Test scenario to run (leave empty for all)'
        required: false
        type: string
        default: ''
      pr_number:
        description: 'PR number to test (for testing PR builds)'
        required: false
        type: string
        default: ''

  schedule:
    # Run nightly at 03:00 UTC
    - cron: '0 3 * * *'

# Limit concurrent runs to avoid Azure quota issues
concurrency:
  group: deployment-e2e-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Enumerate test classes to build the matrix
  enumerate:
    name: Enumerate Tests
    runs-on: ubuntu-latest
    if: ${{ github.repository_owner == 'dotnet' }}
    permissions:
      contents: read
    outputs:
      matrix: ${{ steps.enumerate.outputs.deployment_tests_matrix }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: ./.github/actions/enumerate-tests
        id: enumerate
        with:
          includeDeployment: true

      - name: Display test matrix
        run: |
          echo "Deployment test matrix:"
          echo '${{ steps.enumerate.outputs.deployment_tests_matrix }}' | jq .

  # Build solution and CLI once, share via artifacts
  build:
    name: Build
    runs-on: 8-core-ubuntu-latest
    if: ${{ github.repository_owner == 'dotnet' }}
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup .NET
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4.3.1
        with:
          global-json-file: global.json

      - name: Restore solution
        run: ./restore.sh

      - name: Build solution and pack CLI
        run: |
          # Build the full solution and pack CLI for local testing
          ./build.sh --build --pack -c Release
        env:
          # Skip native build to save time - we'll use the non-native CLI
          SkipNativeBuild: true

      - name: Prepare CLI artifacts
        run: |
          # Create a clean artifact directory with CLI and packages
          ARTIFACT_DIR="${{ github.workspace }}/cli-artifacts"
          mkdir -p "$ARTIFACT_DIR/bin"
          mkdir -p "$ARTIFACT_DIR/packages"
          
          # Copy CLI binary and dependencies
          cp -r "${{ github.workspace }}/artifacts/bin/Aspire.Cli/Release/net10.0/"* "$ARTIFACT_DIR/bin/"
          
          # Copy NuGet packages
          PACKAGES_DIR="${{ github.workspace }}/artifacts/packages/Release/Shipping"
          if [ -d "$PACKAGES_DIR" ]; then
            find "$PACKAGES_DIR" -name "*.nupkg" -exec cp {} "$ARTIFACT_DIR/packages/" \;
          fi
          
          echo "CLI artifacts prepared:"
          ls -la "$ARTIFACT_DIR/bin/"
          echo "Package count: $(find "$ARTIFACT_DIR/packages" -name "*.nupkg" | wc -l)"

      - name: Upload CLI artifacts
        uses: actions/upload-artifact@4cec3d8aa04e39d1a68397de0c4cd6fb9dce8ec1 # v4.6.1
        with:
          name: aspire-cli-artifacts
          path: ${{ github.workspace }}/cli-artifacts/
          retention-days: 1

  # Run each test class in parallel
  deploy-test:
    name: Deploy (${{ matrix.shortname }})
    needs: [enumerate, build]
    if: ${{ needs.enumerate.outputs.matrix != '{"shortname":[]}' && needs.enumerate.outputs.matrix != '' }}
    runs-on: 8-core-ubuntu-latest
    environment: deployment-testing
    permissions:
      id-token: write  # For OIDC Azure login
      contents: read
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.enumerate.outputs.matrix) }}
    env:
      ASPIRE_DEPLOYMENT_TEST_SUBSCRIPTION: ${{ secrets.AZURE_DEPLOYMENT_TEST_SUBSCRIPTION_ID }}
      ASPIRE_DEPLOYMENT_TEST_RG_PREFIX: ${{ vars.ASPIRE_DEPLOYMENT_TEST_RG_PREFIX || 'aspire-e2e' }}

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup .NET
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4.3.1
        with:
          global-json-file: global.json

      - name: Restore and build test project
        run: |
          ./restore.sh
          ./build.sh -restore -ci -build -projects ${{ github.workspace }}/tests/Aspire.Deployment.EndToEnd.Tests/Aspire.Deployment.EndToEnd.Tests.csproj -c Release
        env:
          SkipNativeBuild: true

      - name: Download CLI artifacts
        uses: actions/download-artifact@cc203385981b70ca67e1cc392babf9cc229d5806 # v4.1.9
        with:
          name: aspire-cli-artifacts
          path: ${{ github.workspace }}/cli-artifacts

      - name: Install Aspire CLI from artifacts
        run: |
          ASPIRE_HOME="$HOME/.aspire"
          mkdir -p "$ASPIRE_HOME/bin"
          
          # Copy CLI binary and dependencies
          cp -r "${{ github.workspace }}/cli-artifacts/bin/"* "$ASPIRE_HOME/bin/"
          chmod +x "$ASPIRE_HOME/bin/aspire"
          
          # Add to PATH for this job
          echo "$ASPIRE_HOME/bin" >> $GITHUB_PATH
          
          # Set up NuGet hive for local packages
          HIVE_DIR="$ASPIRE_HOME/hives/local/packages"
          mkdir -p "$HIVE_DIR"
          cp "${{ github.workspace }}/cli-artifacts/packages/"*.nupkg "$HIVE_DIR/" 2>/dev/null || true
          
          # Configure CLI to use local channel
          "$ASPIRE_HOME/bin/aspire" config set channel local --global || true
          
          echo "✅ Aspire CLI installed:"
          "$ASPIRE_HOME/bin/aspire" --version

      - name: Azure Login (OIDC)
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_DEPLOYMENT_TEST_CLIENT_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_DEPLOYMENT_TEST_TENANT_ID }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_DEPLOYMENT_TEST_SUBSCRIPTION_ID }}
        with:
          script: |
            const token = await core.getIDToken('api://AzureADTokenExchange');
            core.setSecret(token);
            
            // Login directly - token never leaves this step
            await exec.exec('az', [
              'login', '--service-principal',
              '--username', process.env.AZURE_CLIENT_ID,
              '--tenant', process.env.AZURE_TENANT_ID,
              '--federated-token', token,
              '--allow-no-subscriptions'
            ]);
            
            await exec.exec('az', [
              'account', 'set',
              '--subscription', process.env.AZURE_SUBSCRIPTION_ID
            ]);

      - name: Verify Azure authentication
        run: |
          echo "Verifying Azure authentication..."
          az account show --query "{subscriptionId:id, tenantId:tenantId, user:user.name}" -o table
          echo "✅ Azure authentication successful"

      - name: Verify Docker is running
        run: |
          echo "Verifying Docker daemon..."
          docker version
          docker info | head -20
          echo "✅ Docker is available"

      - name: Run deployment test (${{ matrix.shortname }})
        id: run_tests
        env:
          GITHUB_PR_NUMBER: ${{ inputs.pr_number || '' }}
          GITHUB_PR_HEAD_SHA: ${{ github.sha }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_DEPLOYMENT_TEST_SUBSCRIPTION_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_DEPLOYMENT_TEST_TENANT_ID }}
          AZURE_CLIENT_ID: ${{ secrets.AZURE_DEPLOYMENT_TEST_CLIENT_ID }}
          Azure__SubscriptionId: ${{ secrets.AZURE_DEPLOYMENT_TEST_SUBSCRIPTION_ID }}
          Azure__Location: eastus
          GH_TOKEN: ${{ github.token }}
        run: |
          ./dotnet.sh test tests/Aspire.Deployment.EndToEnd.Tests/Aspire.Deployment.EndToEnd.Tests.csproj \
            -c Release \
            --logger "trx;LogFileName=${{ matrix.shortname }}.trx" \
            --results-directory ${{ github.workspace }}/testresults \
            -- \
            --filter-not-trait "quarantined=true" \
            --filter-class "Aspire.Deployment.EndToEnd.Tests.${{ matrix.shortname }}" \
            || echo "test_failed=true" >> $GITHUB_OUTPUT

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@4cec3d8aa04e39d1a68397de0c4cd6fb9dce8ec1 # v4.6.1
        with:
          name: deployment-test-results-${{ matrix.shortname }}
          path: |
            ${{ github.workspace }}/testresults/
          retention-days: 30

      - name: Upload recordings
        if: always()
        uses: actions/upload-artifact@4cec3d8aa04e39d1a68397de0c4cd6fb9dce8ec1 # v4.6.1
        with:
          name: deployment-test-recordings-${{ matrix.shortname }}
          path: |
            ${{ github.workspace }}/testresults/recordings/
          retention-days: 30
          if-no-files-found: ignore

      - name: Check for test failures
        if: steps.run_tests.outputs.test_failed == 'true'
        run: |
          echo "::error::Deployment test ${{ matrix.shortname }} failed. Check the test results artifact for details."
          exit 1

  # Create GitHub issue on nightly failure
  create_issue_on_failure:
    name: Create Issue on Failure
    needs: [deploy-test]
    runs-on: ubuntu-latest
    if: ${{ failure() && github.event_name == 'schedule' }}
    permissions:
      issues: write
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Create GitHub Issue
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const date = new Date().toISOString().split('T')[0];

            const issueTitle = `[Deployment E2E] Nightly test failure - ${date}`;
            const issueBody = `## Deployment E2E Test Failure

            The nightly deployment E2E tests failed on ${date}.

            **Workflow Run:** ${runUrl}

            ### Next Steps
            1. Check the workflow run for detailed error logs
            2. Download test artifacts for asciinema recordings
            3. Investigate and fix the failing tests

            ### Labels
            This issue was automatically created by the deployment E2E test workflow.

            /cc @dotnet/aspire-team
            `;

            // Check if a similar issue already exists (created today)
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'area-testing,deployment-e2e',
              per_page: 10
            });

            const todayIssue = existingIssues.data.find(issue =>
              issue.title.includes(date) && issue.title.includes('[Deployment E2E]')
            );

            if (todayIssue) {
              console.log(`Issue already exists for today: ${todayIssue.html_url}`);
              // Add a comment instead
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: todayIssue.number,
                body: `Another failure occurred. See: ${runUrl}`
              });
            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['area-testing', 'deployment-e2e']
              });
              console.log(`Created issue: ${issue.data.html_url}`);
            }
