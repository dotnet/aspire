---
name: 'Build CLI archives'
description: 'Build CLI archives'
inputs:
  targetRids:
    description: ':-separated list of target RIDs'
    required: true
    type: string
    default: ''
  extraBuildArgs:
    required: false
    type: string
    default: ''

runs:
  using: "composite"
  steps:
    - name: Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

    - name: Set up .NET Core
      uses: actions/setup-dotnet@3951f0dfe7a07e2313ec93c75700083e2005cbab # v4.3.0
      with:
        global-json-file: global.json

    - name: Build CLI packages (Windows)
      env:
        CI: false
      if: ${{ runner.os == 'Windows' }}
      shell: pwsh
      run: >
        .\build.cmd
        -ci
        -build
        -restore
        /bl:${{ github.workspace }}/artifacts/log/Debug/BuildCli.binlog
        /p:ContinuousIntegrationBuild=true
        /p:SkipManagedBuild=true
        /p:TargetRids=${{ inputs.TargetRids }}
        ${{ inputs.extraBuildArgs }}

    - name: Build CLI packages (Unix)
      env:
        CI: false
      if: ${{ runner.os != 'Windows' }}
      shell: bash
      run: >
        ./build.sh
        --ci
        --build
        --restore
        /bl:${{ github.workspace }}/artifacts/log/Debug/BuildCli.binlog
        /p:ContinuousIntegrationBuild=true
        /p:SkipManagedBuild=true
        /p:TargetRids=${{ inputs.TargetRids }}
        ${{ inputs.extraBuildArgs }}

    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@4cec3d8aa04e39d1a68397de0c4cd6fb9dce8ec1  # v4.6.1
      with:
        name: build-cli-logs-${{ runner.os }}
        path: artifacts/log/**

    - name: Upload CLI archives
      if: always()
      uses: actions/upload-artifact@4cec3d8aa04e39d1a68397de0c4cd6fb9dce8ec1  # v4.6.1
      with:
        name: cli-native-archives-${{ inputs.targetRids }}
        path: artifacts/packages/**/aspire-cli*
