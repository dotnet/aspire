---
import { Code } from '@astrojs/starlight/components';
---

<div class="orbit-section">
    <div class="environment-toggle">
        <div class="toggle-container">
            <button class="active toggle-btn toggle-local">Local</button>
            <button class="toggle-btn toggle-prod">Prod</button>
        </div>
        <div class="subtitle local local-active">
            Local development with containerized services
        </div>
        <div class="subtitle prod">
            Production cloud servicesâ€”zero code changes
        </div>
    </div>

    <div class="orbit-container">
        <div class="orbit-circle orbit-inner"></div>
        <div class="orbit-circle orbit-middle"></div>
        <div class="orbit-circle orbit-outer"></div>
        
        <div class="orbit-center">
            <div class="orbit-host">
                <div class="terminal local-view">
                    <Code code="aspire run" lang="bash" />
                </div>
                <div class="terminal prod-view">
                    <Code code="aspire publish" lang="bash" />
                </div>
            </div>
        </div>

        <div class="orbit-node orbit-service orbit-redis prod-view" 
             data-providers='["AWS ElastiCache", "Azure Cache for Redis", "Google Cloud Memorystore"]'>
            <div class="service-name">Redis</div>
            <div class="service-type">AWS ElastiCache</div>
        </div>
        <div class="orbit-node orbit-service orbit-redis local-view">
            <div class="service-name">Redis</div>
            <div class="service-type">Local Container</div>
        </div>

        <div class="orbit-node orbit-service orbit-postgres prod-view"
             data-providers='["Google Cloud SQL", "Azure Database for PostgreSQL", "AWS RDS"]'>
            <div class="service-name">Postgres</div>
            <div class="service-type">Google Cloud SQL</div>
        </div>
        <div class="orbit-node orbit-service orbit-postgres local-view">
            <div class="service-name">Postgres</div>
            <div class="service-type">Local Container</div>
        </div>

        <div class="orbit-node orbit-service orbit-frontend prod-view"
             data-providers='["Vercel", "Netlify", "Azure Static Web Apps", "AWS Amplify", "Google Firebase Hosting"]'>
            <div class="service-name">Frontend</div>
            <div class="service-type">Vercel</div>
        </div>
        <div class="orbit-node orbit-service orbit-frontend local-view">
            <div class="service-name">Frontend</div>
            <div class="service-type">Local Process</div>
        </div>

        <div class="orbit-node orbit-service orbit-api prod-view"
             data-providers='["Azure Container Apps", "AWS App Runner", "Google Cloud Run"]'>
            <div class="service-name">API</div>
            <div class="service-type">Azure Container Apps</div>
        </div>
        <div class="orbit-node orbit-service orbit-api local-view">
            <div class="service-name">API</div>
            <div class="service-type">Local Process</div>
        </div>
    </div>
</div>

<script is:inline>
    document.addEventListener('DOMContentLoaded', () => {
        const localBtn = document.querySelector('.toggle-local');
        const prodBtn = document.querySelector('.toggle-prod');
        const localSubtitle = document.querySelector('.subtitle.local');
        const prodSubtitle = document.querySelector('.subtitle.prod');
        const container = document.querySelector('.orbit-container');

        const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        if (prefersReducedMotion) {
            container.classList.add('no-motion');
        }

        container.classList.add('local-active');

        const animationIntervals = new Map();
        function startProviderAnimation() {
            if (prefersReducedMotion) return;
            if (isMobileDevice()) return;

            const prodNodes = document.querySelectorAll('.orbit-node.prod-view[data-providers]');
            
            prodNodes.forEach((node, index) => {
                const providers = JSON.parse(node.dataset.providers);
                const serviceTypeElement = node.querySelector('.service-type');
                let currentIndex = 0;

                if (animationIntervals.has(node)) {
                    clearInterval(animationIntervals.get(node));
                }

                // Create staggered timing - each service starts at a different offset
                const baseInterval = 3000;
                const staggerOffset = index * 750; // 750ms stagger between services

                setTimeout(() => {
                    const interval = setInterval(() => {
                        if (container.classList.contains('prod-active')) {
                            currentIndex = (currentIndex + 1) % providers.length;
                            serviceTypeElement.style.opacity = '0';
                            
                            setTimeout(() => {
                                serviceTypeElement.textContent = providers[currentIndex];
                                serviceTypeElement.style.opacity = '1';
                            }, 150);
                        }
                    }, baseInterval);

                    animationIntervals.set(node, interval);
                }, staggerOffset);
            });
        }

        function stopProviderAnimation() {
            animationIntervals.forEach((interval) => {
                clearInterval(interval);
            });
            animationIntervals.clear();
        }

        function isMobileDevice() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;

            const isMobileUA = /Mobi|Android|iPhone/i.test(userAgent);
            const isSmallScreen = window.innerWidth <= 768;
            const hasTouch = 'maxTouchPoints' in navigator && navigator.maxTouchPoints > 1;

            return isMobileUA || (isSmallScreen && hasTouch);
        }

        localBtn.addEventListener('click', () => {
            localBtn.classList.add('active');
            prodBtn.classList.remove('active');
            container.classList.remove('prod-active');
            container.classList.add('local-active');
            localSubtitle.classList.add('local-active');
            prodSubtitle.classList.remove('prod-active');
            stopProviderAnimation();
        });

        prodBtn.addEventListener('click', () => {
            prodBtn.classList.add('active');
            localBtn.classList.remove('active');
            container.classList.remove('local-active');
            container.classList.add('prod-active');
            prodSubtitle.classList.add('prod-active');
            localSubtitle.classList.remove('local-active');
            startProviderAnimation();
        });

        // Clean up intervals when page is unloaded
        window.addEventListener('beforeunload', stopProviderAnimation);
    });
</script>

<style>
    .orbit-section {
        text-align: center;
        border: 1px solid var(--sl-color-gray-5);
        background: var(--sl-color-bg);
        border-radius: 0.5rem;
    }

    .orbit-container {
        position: relative;
        width: 30rem;
        height: 30rem;
        margin: 4rem auto;
    }

    .orbit-circle {
        position: absolute;
        top: 50%;
        left: 50%;
        border-radius: 50%;
        opacity: 0.6;
        margin-top: initial;
        transition: all 0.3s ease-in-out;
    }

    .orbit-inner {
        width: 70%;
        height: 70%;
        transform: translate(-50%, -50%);
        opacity: 0.9;
        border: 0.3rem dashed var(--sl-color-accent);
    }

    .orbit-middle {
        width: 85%;
        height: 85%;
        transform: translate(-50%, -50%);
        opacity: 0.6;
        border: 0.2rem dashed var(--sl-color-accent);
    }

    .orbit-outer {
        width: 100%;
        height: 100%;
        transform: translate(-50%, -50%);
        opacity: 0.3;
        border: 0.1rem dashed var(--sl-color-accent);
    }

    .local-active .orbit-inner,
    .local-active .orbit-middle,
    .local-active .orbit-outer {
        border-color: var(--sl-color-accent);
    }
    .prod-active .orbit-inner,
    .prod-active .orbit-middle,
    .prod-active .orbit-outer {
        border-color: var(--sl-color-green-low);
    }    

    .orbit-center {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 10;
        margin-top: initial;
    }

    .terminal {
        width: 100%;
        display: none;
        min-width: 12rem;
        margin-top: initial;
    }

    .orbit-container.prod-active .prod-view,
    .orbit-container.local-active .local-view {
        display: block;
    }

    .orbit-node {
        padding: 1rem;
        border-radius: 1.25rem;
        min-width: 16rem;
        background: var(--sl-color-accent);
        color: var(--sl-color-white);
        position: absolute;
        display: none;
        text-align: center;
        z-index: 5;
        transition: all 0.3s ease-in-out;
        border: 1px solid var(--sl-color-gray-3);
        box-shadow: var(--sl-shadow-md);
    }

    .prod-view.orbit-node {
        background: var(--sl-color-green-low);
    }

    .local-view.orbit-node {
        background: var(--sl-color-accent-low);
    }

    .service-name {
        font-size: var(--sl-text-xl);
        font-weight: 600;
        white-space: nowrap;
    }

    .service-type {
        font-size: var(--sl-text-sm);
        font-weight: 550;
        margin-top: 0.25rem;
        white-space: nowrap;
        transition: opacity 0.15s ease-in-out;
    }

    .orbit-redis {
        top: 15%;
        left: 15%;
        transform: translate(-50%, -50%);
    }

    .orbit-postgres {
        top: 15%;
        right: 15%;
        transform: translate(50%, -50%);
    }

    .orbit-frontend {
        bottom: 15%;
        right: 15%;
        transform: translate(50%, 50%);
    }

    .orbit-api {
        bottom: 15%;
        left: 15%;
        transform: translate(-50%, 50%);
    }

    .orbit-container:not(.no-motion) .orbit-inner {
        animation: rotate-fast 45s linear infinite;
    }

    .orbit-container:not(.no-motion) .orbit-middle {
        animation: rotate 60s linear infinite;
    }

    .orbit-container:not(.no-motion) .orbit-outer {
        animation: rotate-slow 90s linear infinite;
    }

    @keyframes rotate-fast {
        0% { transform: translate(-50%, -50%) rotate(0deg); }
        100% { transform: translate(-50%, -50%) rotate(360deg); }
    }

    @keyframes rotate {
        0% { transform: translate(-50%, -50%) rotate(360deg); }
        100% { transform: translate(-50%, -50%) rotate(0deg); }
    }

    @keyframes rotate-slow {
        0% { transform: translate(-50%, -50%) rotate(0deg); }
        100% { transform: translate(-50%, -50%) rotate(360deg); }
    }

    .environment-toggle {
        margin: 2rem auto;
        text-align: center;
    }

    .toggle-container {
        display: inline-flex;
        background: var(--sl-color-gray-6);
        padding: 0.5rem;
        border: 1px solid var(--sl-color-gray-4);
        border-radius: 2rem;
        margin-bottom: 0.75rem;
        gap: 1rem;
        justify-content: space-between;
    }

    .toggle-btn { 
        padding: 0.5rem 1.5rem;
        border-radius: 1.5rem;
        border: 1px solid var(--sl-color-gray-6);
        background: transparent;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 1.1rem;        
        color: var(--sl-color-white);
        margin-top: initial;
        min-width: 7rem;
    }

    .toggle-btn:hover:not(.active) {
        background: var(--sl-color-gray-5);
    }

    .toggle-btn.active {
        background: var(--sl-color-accent-low);
    }

    .toggle-prod.active {
        background: var(--sl-color-green-low);
    }

    .subtitle {
        font-size: var(--sl-text-lg);
        color: var(--sl-color-text);
        text-wrap: pretty;
        display: none;;
        margin-top: 0.75rem;
    }

    .subtitle.local-active,
    .subtitle.prod-active {
        display: block;
    }

    @media (max-width: 768px) {
        .orbit-container {
            width: 32rem;
            height: 32rem;
        }
    }

    @media (max-width: 600px) {
        .orbit-container {
            width: 22rem;
            height: 22rem;
        }

        .orbit-node {
            min-width: 7rem;
            padding: 0.6rem 0.75rem;
        }

        .service-name {
            font-size: 1rem;
        }

        .service-type {
            font-size: 0.8rem;
        }
    }
</style>