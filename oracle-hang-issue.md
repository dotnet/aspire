# Oracle EF Core Tests Hang During Container Initialization

## Summary
The `Aspire.Oracle.EntityFrameworkCore.Tests` test suite is experiencing a hang during test collection initialization, specifically when starting the Oracle Docker container. The hang occurs during the wait strategy phase, where the test waits for the Oracle container to log the startup completion message.

## Test Run Information
- **Test Run URL**: https://github.com/dotnet/aspire/actions/runs/18514118920?pr=12019
- **Dump File**: `Aspire.Oracle.EntityFrameworkCore.Tests_2893_hang.dmp`
- **Target Framework**: net9.0
- **Platform**: ubuntu-latest (x64)
- **Hang Duration**: 7 minutes (triggered hang dump timeout)
- **Exit Code**: 7 (test application didn't exit gracefully)

## Root Cause Analysis

### 1. Call Stack Analysis
Using `dotnet dump analyze`, the async state shows the test is stuck in the following call chain:

```text
OracleContainerFixture.InitializeAsync()
  └─> DockerContainer.StartAsync()
      └─> DockerContainer.UnsafeStartAsync()
          └─> DockerContainer.CheckReadinessAsync()
              └─> WaitStrategy.WaitUntilAsync()
                  └─> Task.Delay (3,600,000ms = 1 hour timeout)
                      └─> Waiting for log: "Completed: ALTER DATABASE OPEN"
```

### 2. Thread State
- **Main Thread (0)**: Blocked in `XunitAutoGeneratedEntryPoint.Main()` waiting for test completion
- **Multiple Threadpool Workers**: Idle, waiting for work
- **Socket Async Thread**: Running but waiting for I/O events
- **ResourceReaper Thread**: Maintaining connection to Ryuk (Testcontainers cleanup service)

### 3. Container Configuration
From `OracleContainerFixture.cs`:
```csharp
Container = new OracleBuilder()
    .WithPortBinding(1521, true)
    .WithHostname("localhost")
    .WithImage($"{ComponentTestConstants.AspireTestContainerRegistry}/gvenzl/oracle-xe:21.3.0-slim-faststart")
    .WithWaitStrategy(Wait
        .ForUnixContainer()
        .UntilMessageIsLogged("Completed: ALTER DATABASE OPEN")
    ).Build();
```

### 4. Timer Analysis
The dump shows a `System.Threading.Tasks.Task+DelayPromise` with:
- `_dueTime`: 3,600,000 ms (1 hour)
- `_period`: 4,294,967,295 (UINT32_MAX - no repeat)
- `_startTicks`: 184,954

This indicates the wait strategy has a 1-hour timeout, but the hang dump was triggered after 7 minutes.

## Issue Details

The Oracle container (`gvenzl/oracle-xe:21.3.0-slim-faststart`) is not completing its startup sequence within a reasonable time. The test is waiting for the container to log the message `"Completed: ALTER DATABASE OPEN"`, which never appears.

**Possible causes:**
1. The Oracle container may be failing to start in the CI environment
2. The container may be starting but not logging the expected message
3. Docker resource constraints in the CI environment may be preventing container startup
4. The container image may be inaccessible or corrupted
5. There may be networking issues preventing proper container initialization

## Evidence from Test Logs

The test command was executed with:
```bash
--hangdump --hangdump-timeout 7m --timeout 15m
```

The log shows:
```text
[+22/x0/?0] Aspire.Oracle.EntityFrameworkCore.Tests.dll (net9.0|x64)(7m 03s)
[createdump] Dump successfully written in 2205ms
Test application process didn't exit gracefully, exit code is '7'
```

## Impact
- Tests cannot complete successfully
- CI pipeline is blocked for 7+ minutes before timeout
- All tests in the `Oracle Database collection` are affected

## Affected Files
- `tests/Aspire.Oracle.EntityFrameworkCore.Tests/OracleContainerFixture.cs`
- All test classes using `[Collection("Oracle Database collection")]`

## Recommendations

### Short-term ✅ **IMPLEMENTED**
1. ✅ **Add shorter timeout**: Added a 3-minute timeout to the wait strategy to fail faster
2. ✅ **Add diagnostic logging**: Added logging at key points (start, success, failure) and container log retrieval on timeout
3. ✅ **Improve error messages**: Enhanced exception message with actionable information and root cause guidance

### Medium-term
1. **Consider alternative wait strategy**: Instead of waiting for a specific log message, try:
   - Health check endpoint polling
   - Port connectivity checks
   - Database connection attempts
2. **Add retry logic**: If container fails to start, retry with exponential backoff

### Long-term
1. **Evaluate container image**: Consider if `oracle-xe:21.3.0-slim-faststart` is the optimal choice
2. **Consider quarantining**: If the issue is intermittent, consider quarantining these tests until root cause is resolved
3. **Mock alternative**: For faster CI feedback, consider providing a mock/in-memory alternative for quick validation

## Changes Made

The `OracleContainerFixture.cs` has been updated with the following improvements:

1. **3-minute timeout**: Container startup now has a 3-minute timeout instead of waiting indefinitely
2. **Diagnostic logging**: Added logging messages using `IMessageSink` to track:
   - Container initialization start
   - Container image being used
   - Successful startup
   - Timeout failures
3. **Container log capture**: On timeout, the fixture attempts to retrieve and log container stdout/stderr for debugging
4. **Enhanced error message**: Timeout exceptions now include:
   - Clear description of what failed
   - Expected log message that never appeared
   - Possible root causes
   - Reference to check container logs

## Reproduction Steps
1. Run `Aspire.Oracle.EntityFrameworkCore.Tests` on ubuntu-latest
2. Tests will hang during `OracleContainerFixture.InitializeAsync()`
3. After 7 minutes, hang dump will be triggered
4. Test process exits with code 7

## Additional Context
- This appears to be a Docker container startup issue, not a .NET or test framework issue
- The Testcontainers library is working correctly; it's waiting as expected
- No lock contention or deadlocks detected in the dump
- All async state machines are properly awaiting

## Related Code

### Original Implementation (Problematic)
```csharp
public async ValueTask InitializeAsync()
{
    if (RequiresDockerAttribute.IsSupported)
    {
        Container = new OracleBuilder()
            .WithPortBinding(1521, true)
            .WithHostname("localhost")
            .WithImage($"{ComponentTestConstants.AspireTestContainerRegistry}/gvenzl/oracle-xe:21.3.0-slim-faststart")
            .WithWaitStrategy(Wait
                .ForUnixContainer()
                .UntilMessageIsLogged("Completed: ALTER DATABASE OPEN")
            ).Build();

        await Container.StartAsync(); // No timeout, no error handling
    }
}
```

### Improved Implementation (With Timeout and Diagnostics)
```csharp
public async ValueTask InitializeAsync()
{
    if (RequiresDockerAttribute.IsSupported)
    {
        _diagnosticMessageSink.OnMessage(new DiagnosticMessage("Starting Oracle container initialization..."));

        Container = new OracleBuilder()
            .WithPortBinding(1521, true)
            .WithHostname("localhost")
            .WithImage($"{ComponentTestConstants.AspireTestContainerRegistry}/gvenzl/oracle-xe:21.3.0-slim-faststart")
            .WithWaitStrategy(Wait
                .ForUnixContainer()
                .UntilMessageIsLogged("Completed: ALTER DATABASE OPEN")
            ).Build();

        // Add timeout to fail faster and provide better diagnostics
        using var cts = new CancellationTokenSource(TimeSpan.FromMinutes(3));

        try
        {
            _diagnosticMessageSink.OnMessage(new DiagnosticMessage($"Starting Oracle container with image: {ComponentTestConstants.AspireTestContainerRegistry}/gvenzl/oracle-xe:21.3.0-slim-faststart"));
            await Container.StartAsync(cts.Token);
            _diagnosticMessageSink.OnMessage(new DiagnosticMessage("Oracle container started successfully"));
        }
        catch (OperationCanceledException) when (cts.IsCancellationRequested)
        {
            _diagnosticMessageSink.OnMessage(new DiagnosticMessage("Oracle container failed to start within 3 minutes timeout"));

            // Attempt to get container logs for diagnostics
            try
            {
                var (stdout, stderr) = await Container.GetLogsAsync(ct: CancellationToken.None);
                _diagnosticMessageSink.OnMessage(new DiagnosticMessage($"Container stdout logs:\n{stdout}"));
                if (!string.IsNullOrEmpty(stderr))
                {
                    _diagnosticMessageSink.OnMessage(new DiagnosticMessage($"Container stderr logs:\n{stderr}"));
                }
            }
            catch (Exception logEx)
            {
                _diagnosticMessageSink.OnMessage(new DiagnosticMessage($"Failed to retrieve container logs: {logEx.Message}"));
            }

            throw new InvalidOperationException(
                "Oracle container failed to start within the 3-minute timeout. " +
                "The container did not log the expected startup completion message: 'Completed: ALTER DATABASE OPEN'. " +
                "This may indicate Docker resource constraints, networking issues, or problems with the container image. " +
                "Check the container logs above for more details.",
                new TimeoutException("Container startup timed out after 3 minutes"));
        }
        catch (Exception ex)
        {
            _diagnosticMessageSink.OnMessage(new DiagnosticMessage($"Oracle container failed to start: {ex.Message}"));
            throw;
        }
    }
}
```
