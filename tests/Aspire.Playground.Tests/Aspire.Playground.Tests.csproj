<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>$(NetCurrent)</TargetFramework>

    <IsTestProject>true</IsTestProject>
    <IsHostingTestingProject>true</IsHostingTestingProject>
    <!-- no docker support on helix/windows yet -->
    <RunTestsOnHelix Condition="'$(OS)' != 'Windows_NT'">true</RunTestsOnHelix>
    <SkipTests Condition="'$(OS)' == 'Windows_NT'">true</SkipTests>

    <IsHostingTestingProject>true</IsHostingTestingProject>
    <DeployOutsideOfRepoSupportFilesRelativeDir>staging-archive\</DeployOutsideOfRepoSupportFilesRelativeDir>

    <!-- FIXME: reduce to one property? -->
    <ExtractTestClassNamesForHelix Condition="'$(ContinuousIntegrationBuild)' == 'true' or '$(ArchiveTests)' == 'true'">true</ExtractTestClassNamesForHelix>
    <ExtractTestClassNamesPrefix>Aspire.Playground.Tests</ExtractTestClassNamesPrefix>

    <PlaygroundSourceDir Condition="'$(PlaygroundSourceDir)' == ''">$(MSBuildThisFileDirectory)..\..\playground\</PlaygroundSourceDir>
    <TestArchiveTestsDir>$(TestArchiveTestsDirForHostingTestingTests)</TestArchiveTestsDir>

    <RunSettingsFilePath>$(MSBuildThisFileDirectory).runsettings</RunSettingsFilePath>
  </PropertyGroup>

  <ItemGroup>
    <AspireProjectOrPackageReference Include="Aspire.Hosting.Testing" />
    <AspireProjectOrPackageReference Include="Aspire.Hosting.Azure" />
    <AspireProjectOrPackageReference Include="Aspire.Hosting.AppHost" />
    <AspireProjectOrPackageReference Include="Aspire.Hosting.NodeJs" />

    <!--<ProjectReference Include="$(PlaygroundSourceDir)AspireEventHub/EventHubs.AppHost/EventHubs.AppHost.csproj" />-->
    <ProjectReference Include="$(PlaygroundSourceDir)AzureStorageEndToEnd/AzureStorageEndToEnd.AppHost/AzureStorageEndToEnd.AppHost.csproj" />
    <ProjectReference Include="$(PlaygroundSourceDir)DatabaseMigration/DatabaseMigration.AppHost/DatabaseMigration.AppHost.csproj" />
    <ProjectReference Include="$(PlaygroundSourceDir)ParameterEndToEnd/ParameterEndToEnd.AppHost/ParameterEndToEnd.AppHost.csproj" />
    <ProjectReference Include="$(PlaygroundSourceDir)ProxylessEndToEnd/ProxylessEndToEnd.AppHost/ProxylessEndToEnd.AppHost.csproj" />
    <ProjectReference Include="$(PlaygroundSourceDir)Qdrant/Qdrant.AppHost/Qdrant.AppHost.csproj" />
    <ProjectReference Include="$(PlaygroundSourceDir)SqlServerEndToEnd/SqlServerEndToEnd.AppHost/SqlServerEndToEnd.AppHost.csproj" />
    <ProjectReference Include="$(PlaygroundSourceDir)Stress/Stress.AppHost/Stress.AppHost.csproj" />
    <ProjectReference Include="$(PlaygroundSourceDir)dapr/AppHost/DaprAppHost.csproj" />
    <ProjectReference Include="$(PlaygroundSourceDir)kafka/KafkaBasic.AppHost/KafkaBasic.AppHost.csproj" />
    <ProjectReference Include="$(PlaygroundSourceDir)mongo/Mongo.AppHost/Mongo.AppHost.csproj" />
    <ProjectReference Include="$(PlaygroundSourceDir)nats/Nats.AppHost/Nats.AppHost.csproj" />
    <ProjectReference Include="$(PlaygroundSourceDir)orleans/OrleansAppHost/OrleansAppHost.csproj" />
    <ProjectReference Include="$(PlaygroundSourceDir)seq/Seq.AppHost/Seq.AppHost.csproj" />
    <ProjectReference Include="$(PlaygroundSourceDir)signalr/SignalRAppHost/SignalRAppHost.csproj" />
    <ProjectReference Include="$(PlaygroundSourceDir)webpubsub/WebPubSubAppHost/WebPubSubAppHost.csproj" />
    <ProjectReference Include="$(PlaygroundSourceDir)keycloak/Keycloak.AppHost/Keycloak.AppHost.csproj" />
    <ProjectReference Include="$(PlaygroundSourceDir)Elasticsearch/Elasticsearch.AppHost/Elasticsearch.AppHost.csproj" />

    <!--
      Failed Aspire.Playground.Tests.AppHostTests.AppHostRunsCleanly(appHostPath: "MySqlDb.AppHost.dll") [26 s]
  Error Message:
   System.InvalidOperationException : AppHost 'MySqlDb.AppHost' logged errors:
[MySqlDb.AppHost.Resources.mysql] 4: 2024-07-18T04:31:40.844574245Z 2024-07-18T04:31:40.813701Z 0 [System] [MY-015017] [Server] MySQL Server Initialization - start.
[MySqlDb.AppHost.Resources.mysql] 5: 2024-07-18T04:31:40.844650847Z 2024-07-18T04:31:40.841687Z 0 [System] [MY-013169] [Server] /usr/sbin/mysqld (mysqld 8.3.0) initializing of server in progress as process 79
[MySqlDb.AppHost.Resources.mysql] 7: 2024-07-18T04:31:41.152397617Z 2024-07-18T04:31:41.152212Z 1 [System] [MY-013576] [InnoDB] InnoDB initialization has started.
[MySqlDb.AppHost.Resources.mysql] 8: 2024-07-18T04:31:44.788877483Z 2024-07-18T04:31:44.788699Z 1 [System] [MY-013577] [InnoDB] InnoDB initialization has ended.
  Stack Trace:
     at SamplesIntegrationTests.Infrastructure.LoggerLogStore.EnsureNoErrors() in /datadisks/disk1/work/A91B09AF/w/AE7009F6/e/tests/Aspire.Playground.Tests/Infrastructure/LoggerLogStore.cs:line 33
   at Aspire.Playground.Tests.AppHostTests.AppHostRunsCleanly(String appHostPath) in /datadisks/disk1/work/A91B09AF/w/AE7009F6/e/tests/Aspire.Playground.Tests/AppHostTests.cs:line 30
   at Aspire.Playground.Tests.AppHostTests.AppHostRunsCleanly(String appHostPath) in /datadisks/disk1/work/A91B09AF/w/AE7009F6/e/tests/Aspire.Playground.Tests/AppHostTests.cs:line 33
    -->
    <!--<ProjectReference Include="$(PlaygroundSourceDir)mysql/MySqlDb.AppHost/MySqlDb.AppHost.csproj" />-->

    <!-- failing
      <ProjectReference Include="$(PlaygroundSourceDir)CustomResources/CustomResources.AppHost/CustomResources.AppHost.csproj" />
      <ProjectReference Include="$(PlaygroundSourceDir)PostgresEndToEnd/PostgresEndToEnd.AppHost/PostgresEndToEnd.AppHost.csproj" />
      <ProjectReference Include="$(PlaygroundSourceDir)TestShop/AppHost/AppHost.csproj" />
      <ProjectReference Include="$(PlaygroundSourceDir)milvus/MilvusPlayground.AppHost/MilvusPlayground.AppHost.csproj" />
      <ProjectReference Include="$(PlaygroundSourceDir)withdockerfile/WithDockerfile.AppHost/WithDockerfile.AppHost.csproj" />
      <ProjectReference Include="$(PlaygroundSourceDir)CosmosEndToEnd/CosmosEndToEnd.AppHost/CosmosEndToEnd.AppHost.csproj" />

      - needs .venv to be initialized
     <ProjectReference Include="$(PlaygroundSourceDir)python/Python.AppHost/Python.AppHost.csproj" />
    -->

    <!-- Need azure, aws subscription
      <ProjectReference Include="$(PlaygroundSourceDir)AWS/AWS.AppHost/AWS.AppHost.csproj" />
      <ProjectReference Include="$(PlaygroundSourceDir)AzureSearchEndToEnd/AzureSearch.AppHost/AzureSearch.AppHost.csproj" />
      <ProjectReference Include="$(PlaygroundSourceDir)OpenAIEndToEnd/OpenAIEndToEnd.AppHost/OpenAIEndToEnd.AppHost.csproj" />
      <ProjectReference Include="$(PlaygroundSourceDir)bicep/BicepSample.AppHost/BicepSample.AppHost.csproj" />
      <ProjectReference Include="$(PlaygroundSourceDir)cdk/CdkSample.AppHost/CdkSample.AppHost.csproj" />
    -->

    <PackageReference Include="Microsoft.DotNet.XUnitExtensions" />
    <PackageReference Include="Microsoft.Extensions.Http.Resilience" />

    <Using Include="Aspire.Hosting.Testing" />
  </ItemGroup>

  <ItemGroup Condition="'$(ArchiveTests)' == 'true'">
    <None Include="$(MSBuildProjectDirectory)\**\*" Link="$(DeployOutsideOfRepoSupportFilesRelativeDir)tests\$(MSBuildProjectName)\%(RecursiveDir)%(FileName)%(Extension)" CopyToOutputDirectory="PreserveNewest" />
    <None Include="$(RepoRoot)src\Shared\**\*" Link="$(DeployOutsideOfRepoSupportFilesRelativeDir)src\Shared\%(RecursiveDir)%(FileName)%(Extension)" CopyToOutputDirectory="PreserveNewest" />
    <None Include="$(RepoRoot)playground\**\*" Link="$(DeployOutsideOfRepoSupportFilesRelativeDir)playground\%(RecursiveDir)%(FileName)%(Extension)" CopyToOutputDirectory="PreserveNewest" />
  </ItemGroup>

</Project>
