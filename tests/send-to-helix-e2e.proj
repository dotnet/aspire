<Project>

  <PropertyGroup>
    <WorkItemArchiveWildCardE2E>$(TestArchiveTestsDirForE2E)**/*.zip</WorkItemArchiveWildCardE2E>
  </PropertyGroup>

  <!--

    - tests should be able to run with, and without workload in the same instance
    - compute paths in benv.cs as much as possible
  -->

  <ItemGroup>
    <HelixPreCommand Condition="'$(OS)' == 'Windows_NT'" Include="set PATH=%HELIX_CORRELATION_PAYLOAD%\dotnet-latest;%PATH%" />
    <HelixPreCommand Condition="'$(OS)' != 'Windows_NT'" Include="export PATH=$HELIX_CORRELATION_PAYLOAD/dotnet-latest:$PATH" />

    <!--<HelixPreCommand Condition="'$(OS)' == 'Windows_NT'" Include="set IS_RUNNING_ON_CI=true" />-->
    <!--<HelixPreCommand Condition="'$(OS)' != 'Windows_NT'" Include="export IS_RUNNING_ON_CI=true" />-->

    <HelixPreCommand Condition="'$(OS)' == 'Windows_NT'" Include="set SDK_DIR_NAME=dotnet-latest" />
    <HelixPreCommand Condition="'$(OS)' != 'Windows_NT'" Include="export SDK_DIR_NAME=dotnet-latest" />

    <HelixPreCommand Condition="'$(OS)' == 'Windows_NT'" Include="set SDK_FOR_WORKLOAD_TESTING_PATH=%HELIX_CORRELATION_PAYLOAD%\%SDK_DIR_NAME%" />
    <HelixPreCommand Condition="'$(OS)' != 'Windows_NT'" Include="export SDK_FOR_WORKLOAD_TESTING_PATH=$HELIX_CORRELATION_PAYLOAD/$SDK_DIR_NAME" />

    <HelixPreCommand Condition="'$(OS)' == 'Windows_NT'" Include="set SDK_HAS_WORKLOAD_INSTALLED=true" />
    <HelixPreCommand Condition="'$(OS)' != 'Windows_NT'" Include="export SDK_HAS_WORKLOAD_INSTALLED=true" />

    <HelixPreCommand Condition="'$(OS)' == 'Windows_NT'" Include="set TestsRunningOutOfTree=true" />
    <HelixPreCommand Condition="'$(OS)' != 'Windows_NT'" Include="export TestsRunningOutOfTree=true" />

    <HelixPreCommand Condition="'$(OS)' == 'Windows_NT'" Include="set SHOW_BUILD_OUTPUT=1" />
    <HelixPreCommand Condition="'$(OS)' != 'Windows_NT'" Include="export SHOW_BUILD_OUTPUT=1" />

    <HelixPreCommand Condition="'$(OS)' == 'Windows_NT'" Include="set BUILT_NUGETS_PATH=%HELIX_CORRELATION_PAYLOAD%\built-nugets" />
    <HelixPreCommand Condition="'$(OS)' != 'Windows_NT'" Include="export BUILT_NUGETS_PATH=$HELIX_CORRELATION_PAYLOAD/built-nugets" />

    <!--<HelixPreCommand Condition="'$(OS)' == 'Windows_NT'" Include="set TEST_ASSETS_PATH=%HELIX_CORRELATION_PAYLOAD%\testassets" />-->
    <!--<HelixPreCommand Condition="'$(OS)' != 'Windows_NT'" Include="export TEST_ASSETS_PATH=$HELIX_CORRELATION_PAYLOAD/testassets" />-->

    <HelixPreCommand Include="docker info" />
    <HelixPreCommand Include="docker ps" />
    <HelixPreCommand Include="docker container ls --all" />
    <HelixPreCommand Include="docker container prune -f" />
  </ItemGroup>

  <Target Name="BuildHelixWorkItemsForEnd2EndTests">
    <!--<Error Condition="'$(RepoTestResultsPath)' == ''" Text="%24(RepoTestResultsPath) is unset" />-->

    <PropertyGroup>
      <_workItemTimeout>00:20:00</_workItemTimeout>

      <HelixPreCommands>$(HelixPreCommands);@(HelixPreCommand)</HelixPreCommands>
      <!--<HelixResultsDestinationDir>$(RepoTestResultsPath)</HelixResultsDestinationDir>-->

      <_TestRunCommand Condition="'$(RunWithCodeCoverage)' == 'true'">@(_TestCoverageCommand, ' ') &quot;@(_TestRunCommandArguments, ' ')&quot;</_TestRunCommand>
      <_TestRunCommand Condition="'$(RunWithCodeCoverage)' != 'true'">@(_TestRunCommandArguments, ' ')</_TestRunCommand>
    </PropertyGroup>

    <Error Condition="'$(_DotNetCoverageToolPath)' == '' or !Exists($(_DotNetCoverageToolPath))"
           Text="Could not find dotnet-coverage tool. %24(_DotNetCoverageToolPath)=$(_DotNetCoverageToolPath)" />

    <ItemGroup>
      <HelixCorrelationPayload Include="$(ArtifactsBinDir)dotnet-latest" Destination="dotnet-latest" />
      <HelixCorrelationPayload Include="$(ArtifactsShippingPackagesDir)" Destination="built-nugets" />
      <!--<HelixCorrelationPayload Include="$(RepoRoot)tests\testproject" Destination="testassets\testproject" />-->

      <_DefaultWorkItemsE2E Include="$(WorkItemArchiveWildCardE2E)" />

      <HelixWorkItem Include="@(_DefaultWorkItemsE2E -> '%(FileName)')">
        <PayloadArchive>%(Identity)</PayloadArchive>
        <PreCommands Condition="'$(OS)' == 'Windows_NT'">set &quot;TEST_NAME=%(FileName)&quot;</PreCommands>
        <PreCommands Condition="'$(OS)' != 'Windows_NT'">export &quot;TEST_NAME=%(FileName)&quot;</PreCommands>
        <Command>$(_TestRunCommand)</Command>
        <Timeout>$(_workItemTimeout)</Timeout>

        <!-- Download results file so coverage files can be extracted -->
        <DownloadFilesFromResults>logs/%(FileName).cobertura.xml</DownloadFilesFromResults>
      </HelixWorkItem>
    </ItemGroup>
  </Target>
</Project>
