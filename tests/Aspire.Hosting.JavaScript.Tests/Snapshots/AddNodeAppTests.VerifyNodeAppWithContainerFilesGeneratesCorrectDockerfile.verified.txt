ARG SOURCE_IMAGENAME=source:source-tag

FROM node:22-alpine AS build

WORKDIR /app
COPY package*.json ./
RUN --mount=type=cache,target=/root/.npm npm install --production
COPY . .

FROM ${SOURCE_IMAGENAME} AS source_stage

FROM node:22-alpine AS runtime

WORKDIR /app
COPY --from=build /app/node_modules ./node_modules
COPY --from=build /app/app.js ./app.js
COPY --from=source_stage /app/dist /app/./static


ENV NODE_ENV=production

USER node

ENTRYPOINT ["node","app.js"]
