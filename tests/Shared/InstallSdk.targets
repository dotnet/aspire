<Project InitialTargets="ValidateInputs">

  <PropertyGroup>
    <_DotNetInstallScriptName Condition="!$([MSBuild]::IsOSPlatform('windows'))">dotnet-install.sh</_DotNetInstallScriptName>
    <_DotNetInstallScriptName Condition=" $([MSBuild]::IsOSPlatform('windows'))">dotnet-install.ps1</_DotNetInstallScriptName>

    <_DotNetInstallScriptPath>$(ArtifactsObjDir)$(_DotNetInstallScriptName)</_DotNetInstallScriptPath>

    <SdkStampPath>$(SdkTargetDir)\.version-$(SdkVersionToInstall).stamp</SdkStampPath>
  </PropertyGroup>

  <!--
    Inputs:
      $(SdkVersionToInstall)
      $(SdkTargetDir)
      $(SdkStampPath)

      $(ArtifactsObjDir)
  -->

  <Target Name="ValidateInputs">
    <Error Text="%24(SdkTargetDir) is not set" Condition="'$(SdkTargetDir)' == ''" />
    <Error Text="%24(SdkVersionToInstall) is not set" Condition="'$(SdkVersionToInstall)' == ''" />
    <Error Text="%24(ArtifactsObjDir) is not set" Condition="'$(ArtifactsObjDir)' == ''" />
  </Target>

  <!-- FIXME: null check for stamp path-->
  <Target Name="ProvisionSdk" Condition="!Exists($(SdkStampPath))">
    <!--<Message Text="SdkVersionForWorkloadTesting: $(SdkVersionForWorkloadTesting)" Importance="High" />-->

    <PropertyGroup>
      <_DotNetInstallCommand Condition="!$([MSBuild]::IsOSPlatform('windows'))"
              >$(_DotNetInstallScriptPath) -i $(SdkTargetDir) -v $(SdkVersionToInstall)</_DotNetInstallCommand>
      <_DotNetInstallCommand Condition="$([MSBuild]::IsOSPlatform('windows'))"
              >$(_DotNetInstallScriptPath) -InstallDir $(SdkTargetDir) -Version $(SdkVersionToInstall)</_DotNetInstallCommand>
    </PropertyGroup>

    <Message Text="** Installing sdk $(SdkVersionToInstall) for template tests into $(SdkTargetDir)"
             Condition="'$(SdkVersionToInstall)' != ''"
             Importance="High" />
    <Message Text="** Installing latest sdk for template tests into $(SdkTargetDir)"
             Condition="'$(SdkVersionToInstall)' == ''"
             Importance="High" />

    <DownloadFile SourceUrl="https://dot.net/v1/$(_DotNetInstallScriptName)"
                  DestinationFolder="$(ArtifactsObjDir)"
                  Retries="3"
                  Condition="!Exists($(_DotNetInstallScriptPath))"/>

    <RemoveDir Directories="$(SdkTargetDir)" />
    <MakeDir Directories="$(SdkTargetDir)" />

    <Exec Condition="!$([MSBuild]::IsOSPlatform('windows'))"
          IgnoreStandardErrorWarningFormat="true"
          Command="chmod +x $(_DotNetInstallScriptPath); $(_DotNetInstallCommand)" />

    <Exec Condition="$([MSBuild]::IsOSPlatform('windows'))"
          IgnoreStandardErrorWarningFormat="true"
          Command='powershell -ExecutionPolicy ByPass -NoProfile -command "&amp; $(_DotNetInstallCommand)"' />

    <Touch Files="$(SdkStampPath)" AlwaysCreate="true" />
  </Target>
</Project>
