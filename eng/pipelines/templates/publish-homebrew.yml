# Reusable template for submitting a Homebrew cask PR to Homebrew/homebrew-cask.
# Used by the release flow (release-publish-nuget.yml).
# Analogous to publish-winget.yml for WinGet manifests.

parameters:
  - name: caskArtifactPath
    type: string
    displayName: 'Path to the directory containing the generated .rb cask file'
  - name: version
    type: string
    displayName: 'Package version (used in PR title)'
  - name: channel
    type: string
    default: 'stable'
    values:
      - stable
      - prerelease
  - name: dryRun
    type: boolean
    default: false
    displayName: 'Skip actual submit (for testing)'

steps:
  - bash: |
      set -euo pipefail
      caskDir='${{ parameters.caskArtifactPath }}'
      channel='${{ parameters.channel }}'

      if [ "$channel" = "prerelease" ]; then
        caskFile="aspire@prerelease.rb"
      else
        caskFile="aspire.rb"
      fi

      caskPath="$caskDir/$caskFile"

      echo "=== Homebrew Cask ==="
      echo "Channel: $channel"
      echo "Cask file: $caskPath"
      echo "====================="

      if [ ! -f "$caskPath" ]; then
        echo "##[error]Cask file not found: $caskPath"
        ls -la "$caskDir" || true
        exit 1
      fi

      echo ""
      echo "=== Cask Contents ==="
      cat "$caskPath"
      echo "====================="

      echo "##vso[task.setvariable variable=HomebrewCaskFile]$caskFile"
      echo "##vso[task.setvariable variable=HomebrewCaskPath]$caskPath"
    displayName: 'ðŸŸ£Locate Homebrew cask file'

  - bash: |
      set -euo pipefail
      caskPath="$(HomebrewCaskPath)"

      echo "Validating download URLs from cask file..."

      # Extract url lines from the cask file (handles both `url "..."` and heredoc-style)
      urls=()
      while IFS= read -r line; do
        # Match: url "https://..." â€” extract the URL portion
        if [[ "$line" =~ url\ +\"([^\"]+)\" ]]; then
          urls+=("${BASH_REMATCH[1]}")
        fi
      done < "$caskPath"

      if [ ${#urls[@]} -eq 0 ]; then
        echo "##[error]No URLs found in cask file: $caskPath"
        exit 1
      fi

      # Expand #{version} and #{arch} placeholders for both architectures
      expandedUrls=()
      version='${{ parameters.version }}'
      for rawUrl in "${urls[@]}"; do
        for arch in arm64 x64; do
          expanded="${rawUrl//\#\{version\}/$version}"
          expanded="${expanded//\#\{arch\}/$arch}"
          expandedUrls+=("$expanded")
        done
      done

      failed=0
      for checkUrl in "${expandedUrls[@]}"; do
        httpCode=$(curl -s -o /dev/null -w '%{http_code}' --head --max-time 15 "$checkUrl" || true)
        if [[ "$httpCode" =~ ^2 ]] || [[ "$httpCode" =~ ^3 ]]; then
          echo "  OK ($httpCode): $checkUrl"
        else
          echo "##[error]FAILED ($httpCode): $checkUrl"
          failed=1
        fi
      done

      if [ "$failed" -ne 0 ]; then
        echo "##[error]One or more download URLs are not accessible. Aborting before PR submission."
        exit 1
      fi
      echo "All download URLs are accessible."
    displayName: 'ðŸŸ£Validate download URLs from cask'

  - bash: |
      set -euo pipefail
      caskPath="$(HomebrewCaskPath)"
      caskFile="$(HomebrewCaskFile)"

      echo "Validating Ruby syntax..."
      ruby -c "$caskPath"
      echo "Ruby syntax OK"

      echo ""
      echo "Auditing cask via local tap..."
      brew tap-new --no-git local/aspire
      mkdir -p "$(brew --repository)/Library/Taps/local/homebrew-aspire/Casks"
      cp "$caskPath" "$(brew --repository)/Library/Taps/local/homebrew-aspire/Casks/$caskFile"

      auditCode=0
      brew audit --cask "local/aspire/${caskFile%.rb}" || auditCode=$?

      brew untap local/aspire

      if [ $auditCode -ne 0 ]; then
        echo "##[error]brew audit failed"
        exit $auditCode
      fi
      echo "brew audit passed"
    displayName: 'ðŸŸ£Validate cask before publish'

  - bash: |
      set -euo pipefail
      version='${{ parameters.version }}'
      channel='${{ parameters.channel }}'
      caskFile="$(HomebrewCaskFile)"
      caskPath="$(HomebrewCaskPath)"
      caskName="${caskFile%.rb}"

      if [ -z "$HOMEBREW_CASK_GITHUB_TOKEN" ]; then
        echo "##[error]GitHub token for Homebrew cask PR is not set. Ensure the variable group is configured."
        exit 1
      fi

      echo "Submitting cask PR to Homebrew/homebrew-cask"

      # Configure gh CLI
      echo "$HOMEBREW_CASK_GITHUB_TOKEN" | gh auth login --with-token

      # Resolve the authenticated GitHub username once
      botUser="$(gh api user --jq .login)"
      echo "Authenticated as: $botUser"

      # Fork and clone (idempotent â€” reuses existing fork)
      repoDir="$(Build.StagingDirectory)/homebrew-cask-repo"
      gh repo fork Homebrew/homebrew-cask --clone --default-branch-only -- "$repoDir" 2>/dev/null \
        || git clone "https://github.com/${botUser}/homebrew-cask.git" "$repoDir"

      cd "$repoDir"
      git remote add upstream https://github.com/Homebrew/homebrew-cask.git 2>/dev/null || true
      git fetch upstream master
      git checkout -B "aspire-${version}" upstream/master

      # Casks are organized by first letter: Casks/a/aspire.rb
      firstLetter="${caskName:0:1}"
      targetDir="Casks/$firstLetter"
      mkdir -p "$targetDir"
      cp "$caskPath" "$targetDir/$caskFile"

      git config user.name "dotnet-bot"
      git config user.email "dotnet-bot@microsoft.com"
      git add "$targetDir/$caskFile"
      git commit -m "$caskName $version"
      git push --force origin "aspire-${version}"

      # Create PR (or update existing)
      existingPR=$(gh pr list --repo Homebrew/homebrew-cask --head "${botUser}:aspire-${version}" --json number --jq '.[0].number' 2>/dev/null || true)
      if [ -n "$existingPR" ]; then
        echo "PR #$existingPR already exists â€” updated branch"
      else
        gh pr create \
          --repo Homebrew/homebrew-cask \
          --title "$caskName $version" \
          --body "Update $caskName to version $version." \
          --head "${botUser}:aspire-${version}"
        echo "PR created successfully"
      fi
    displayName: 'ðŸŸ£Submit PR to Homebrew/homebrew-cask'
    condition: and(succeeded(), eq('${{ parameters.dryRun }}', 'false'))
    env:
      HOMEBREW_CASK_GITHUB_TOKEN: $(aspire-homebrew-bot-pat)
