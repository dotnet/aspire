# Reusable template for submitting a Homebrew cask PR to Homebrew/homebrew-cask.
# Used by the release flow (release-publish-nuget.yml).
# Analogous to publish-winget.yml for WinGet manifests.
#
# NOTE: Cask syntax validation and brew audit are performed during build
# in prepare-homebrew-cask.yml. This template only handles submission.

parameters:
  - name: caskArtifactPath
    type: string
    displayName: 'Path to the directory containing the generated .rb cask file'
  - name: version
    type: string
    default: ''
    displayName: 'Package version (used in PR title). If empty, extracted from cask file.'
  - name: channel
    type: string
    default: 'stable'
    values:
      - stable
      - prerelease
  - name: dryRun
    type: boolean
    default: false
    displayName: 'Skip actual submit (for testing)'

steps:
  - powershell: |
      $ErrorActionPreference = 'Stop'
      $caskDir = '${{ parameters.caskArtifactPath }}'
      $channel = '${{ parameters.channel }}'

      if ($channel -eq 'prerelease') {
        $caskFile = 'aspire@prerelease.rb'
      } else {
        $caskFile = 'aspire.rb'
      }

      $caskPath = Join-Path $caskDir $caskFile

      Write-Host "=== Homebrew Cask ==="
      Write-Host "Channel: $channel"
      Write-Host "Cask file: $caskPath"
      Write-Host "====================="

      if (!(Test-Path $caskPath)) {
        Write-Host "##[error]Cask file not found: $caskPath"
        Get-ChildItem -Path $caskDir -ErrorAction SilentlyContinue | Format-Table Name
        exit 1
      }

      Write-Host ""
      Write-Host "=== Cask Contents ==="
      Get-Content $caskPath
      Write-Host "====================="

      # Extract version from cask file content
      $version = '${{ parameters.version }}'
      if ([string]::IsNullOrWhiteSpace($version)) {
        $match = Select-String -Path $caskPath -Pattern '^\s*version\s+"([^"]+)"' | Select-Object -First 1
        if ($match) {
          $version = $match.Matches[0].Groups[1].Value
          Write-Host "Extracted version from cask: $version"
        } else {
          Write-Error "Could not extract version from cask file"
          exit 1
        }
      } else {
        Write-Host "Using provided version: $version"
      }

      Write-Host "##vso[task.setvariable variable=HomebrewCaskFile]$caskFile"
      Write-Host "##vso[task.setvariable variable=HomebrewCaskPath]$caskPath"
      Write-Host "##vso[task.setvariable variable=HomebrewVersion]$version"
    displayName: 'ðŸŸ£Locate Homebrew cask file'

  - powershell: |
      $ErrorActionPreference = 'Stop'
      $caskPath = '$(HomebrewCaskPath)'
      $version = '$(HomebrewVersion)'

      Write-Host "Validating download URLs from cask file..."

      # Extract url lines from the cask file
      $urls = @()
      Get-Content $caskPath | ForEach-Object {
        if ($_ -match 'url\s+"([^"]+)"') {
          $urls += $Matches[1]
        }
      }

      if ($urls.Count -eq 0) {
        Write-Host "##[error]No URLs found in cask file: $caskPath"
        exit 1
      }

      # Expand #{version} and #{arch} placeholders for both architectures
      $failed = $false
      foreach ($rawUrl in $urls) {
        foreach ($arch in @('arm64', 'x64')) {
          $expanded = $rawUrl -replace '#\{version\}', $version
          $expanded = $expanded -replace '#\{arch\}', $arch

          try {
            $response = Invoke-WebRequest -Uri $expanded -Method Head -MaximumRedirection 5 -TimeoutSec 15 -UseBasicParsing
            Write-Host "  OK ($($response.StatusCode)): $expanded"
          } catch {
            $code = 'ERR'
            if ($_.Exception.Response) { $code = $_.Exception.Response.StatusCode.value__ }
            Write-Host "##[error]FAILED ($code): $expanded â€” $($_.Exception.Message)"
            $failed = $true
          }
        }
      }

      if ($failed) {
        Write-Error "One or more download URLs are not accessible. Aborting before PR submission."
        exit 1
      }
      Write-Host "All download URLs are accessible."
    displayName: 'ðŸŸ£Validate download URLs from cask'

  - powershell: |
      $ErrorActionPreference = 'Stop'
      $version = '$(HomebrewVersion)'
      $channel = '${{ parameters.channel }}'
      $caskFile = '$(HomebrewCaskFile)'
      $caskPath = '$(HomebrewCaskPath)'
      $caskName = $caskFile -replace '\.rb$', ''
      $token = $env:HOMEBREW_CASK_GITHUB_TOKEN

      if ([string]::IsNullOrWhiteSpace($token)) {
        Write-Error "GitHub token for Homebrew cask PR is not set. Ensure the variable group is configured."
        exit 1
      }

      Write-Host "Submitting cask PR to Homebrew/homebrew-cask"

      # Configure gh CLI
      $token | gh auth login --with-token

      $botUser = gh api user --jq '.login'
      Write-Host "Authenticated as: $botUser"

      # Fork and clone (idempotent â€” reuses existing fork)
      $repoDir = "$(Build.StagingDirectory)/homebrew-cask-repo"
      gh repo fork Homebrew/homebrew-cask --clone --default-branch-only -- $repoDir 2>$null
      if ($LASTEXITCODE -ne 0) {
        git clone "https://github.com/${botUser}/homebrew-cask.git" $repoDir
      }

      Push-Location $repoDir
      try {
        git remote add upstream https://github.com/Homebrew/homebrew-cask.git 2>$null
        git fetch upstream master
        git checkout -B "aspire-${version}" upstream/master

        # Casks are organized by first letter: Casks/a/aspire.rb
        $firstLetter = $caskName.Substring(0, 1)
        $targetDir = "Casks/$firstLetter"
        New-Item -ItemType Directory -Path $targetDir -Force | Out-Null
        Copy-Item $caskPath "$targetDir/$caskFile"

        git config user.name "dotnet-bot"
        git config user.email "dotnet-bot@microsoft.com"
        git add "$targetDir/$caskFile"
        git commit -m "$caskName $version"
        git push --force origin "aspire-${version}"

        # Create PR (or update existing)
        $existingPR = gh pr list --repo Homebrew/homebrew-cask --head "${botUser}:aspire-${version}" --json number --jq '.[0].number' 2>$null
        if ($existingPR) {
          Write-Host "PR #$existingPR already exists â€” updated branch"
        } else {
          gh pr create `
            --repo Homebrew/homebrew-cask `
            --title "$caskName $version" `
            --body "Update $caskName to version $version." `
            --head "${botUser}:aspire-${version}"
          Write-Host "PR created successfully"
        }
      } finally {
        Pop-Location
      }
    displayName: 'ðŸŸ£Submit PR to Homebrew/homebrew-cask'
    condition: and(succeeded(), eq('${{ parameters.dryRun }}', 'false'))
    env:
      HOMEBREW_CASK_GITHUB_TOKEN: $(aspire-homebrew-bot-pat)
