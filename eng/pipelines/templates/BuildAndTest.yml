parameters:
  - name: runAsPublic
    type: boolean
    default: false
  - name: buildScript
    type: string
  - name: buildConfig
    type: string
  - name: repoLogPath
    type: string
  - name: repoTestResultsPath
    type: string
  - name: isWindows
    type: string
  - name: dotnetScript
    type: string
  - name: skipTests
    type: boolean
    default: false
  - name: defaultToRunningTestsOnHelix
    type: boolean
    default: true

steps:
  - script: ${{ parameters.buildScript }}
            -restore -build
            -configuration ${{ parameters.buildConfig }}
            /p:ArchiveTests=true
            /p:DefaultToRunningTestsOnHelix=${{ parameters.defaultToRunningTestsOnHelix }}
            /bl:${{ parameters.repoLogPath }}/build.binlog
            $(_OfficialBuildIdArgs)
    displayName: Build

  - ${{ if ne(parameters.skipTests, 'true') }}:
    - script: ${{ parameters.dotnetScript }} dotnet-coverage collect
              --settings $(Build.SourcesDirectory)/eng/CodeCoverage.config
              --output ${{ parameters.repoTestResultsPath }}/NonHelixTests.cobertura.xml
              "${{ parameters.buildScript }} -testnobuild -test -configuration ${{ parameters.buildConfig }} /bl:${{ parameters.repoLogPath }}/tests.binlog /p:DefaultToRunningTestsOnHelix=${{ parameters.defaultToRunningTestsOnHelix }} $(_OfficialBuildIdArgs)"
      displayName: Run non-helix tests

    - template: /eng/pipelines/templates/send-to-helix.yml
      parameters:
        HelixProjectPath: '$(Build.SourcesDirectory)/tests/send-to-helix.proj'
        HelixProjectArguments: /p:RunWithCodeCoverage=true /p:RepoTestResultsPath=${{ parameters.repoTestResultsPath }}

        ${{ if eq(parameters.isWindows, 'true') }}:
          HelixTargetQueues: Windows.11.Amd64.Client.Open
        ${{ if ne(parameters.isWindows, 'true') }}:
          HelixTargetQueues: Ubuntu.2204.Amd64.Open

        IsWindows: ${{ parameters.isWindows }}
        Creator: $(Build.DefinitionName)
        HelixBuild: $(Build.BuildNumber)
        HelixAccessToken: $(HelixApiAccessToken)

    - ${{ if eq(parameters.isWindows, 'true') }}:
      - pwsh: |
            $_cov_filelist=$((Get-ChildItem -Path ${{ parameters.repoTestResultsPath }} -Recurse -Filter *.cobertura.xml -File | % { $_.FullName }) -join ' ')
            echo "${{ parameters.dotnetScript }} dotnet-coverage merge $_cov_filelist -f cobertura -o ${{ parameters.repoTestResultsPath }}/$(Agent.Os)_$(Agent.JobName).cobertura.xml" > merge-cov.cmd
            cmd /c merge-cov.cmd
            rm merge-cov.cmd
        displayName: Merge code coverage results

    - ${{ if ne(parameters.isWindows, 'true') }}:
      - script: ${{ parameters.dotnetScript }} dotnet-coverage
                merge
                `find ${{ parameters.repoTestResultsPath }} -name '*.cobertura.xml' -print0 | xargs -0`
                -f cobertura
                -o '${{ parameters.repoTestResultsPath }}/$(Agent.Os)_$(Agent.JobName).cobertura.xml'
        displayName: Merge code coverage results

    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '${{ parameters.repoTestResultsPath }}/$(Agent.Os)_$(Agent.JobName).cobertura.xml'
        PublishLocation: Container
        ArtifactName: CodeCoverageResults
      displayName: Publish coverage results (cobertura.xml)

  - ${{ if eq(parameters.isWindows, 'true') }}:
    - script: ${{ parameters.buildScript }}
              -pack
              -sign $(_SignArgs)
              -publish $(_PublishArgs)
              -configuration ${{ parameters.buildConfig }}
              /bl:${{ parameters.repoLogPath }}/pack.binlog
              /p:Restore=false /p:Build=false
              $(_OfficialBuildIdArgs)
      displayName: Pack, Sign, and Publish

    - script: ${{ parameters.buildScript }}
        -restore -build
        -pack
        -sign $(_SignArgs)
        -publish $(_PublishArgs)
        -configuration $(_BuildConfig)
        /bl:${{ parameters.repoLogPath }}/build-workloads.binlog
        -projects eng\workloads\workloads.csproj
        $(_InternalBuildArgs)
      displayName: Build Workloads

    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: '$(Build.SourcesDirectory)/artifacts/packages'
        artifactName: PackageArtifacts
        artifactType: container
      displayName: Publish Package Artifacts

    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: '$(Build.SourcesDirectory)/artifacts/VSSetup/$(_BuildConfig)'
        artifactName: VSDropInsertion
        artifactType: container
      displayName: Publish VSDrop MSIs
