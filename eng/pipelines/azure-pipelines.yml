# Runtime parameters for VS Code extension publishing (shown in "Run pipeline" UI)
parameters:
  - name: publishVSCodeExtension
    displayName: 'Publish VS Code Extension to Marketplace'
    type: boolean
    default: false
  - name: vscePublishPreRelease
    displayName: 'Publish as Pre-Release'
    type: boolean
    default: false

trigger:
  batch: true
  branches:
    include:
    - main*
    - release/*
    - internal/release/*
  paths:
    include:
      - '*'
    exclude:
      - '**.md'
      - eng/Version.Details.xml
      - .github/*
      - docs/*
      - LICENSE.TXT
      - PATENTS.TXT
      - THIRD-PARTY-NOTICES.TXT

pr:
  branches:
    include:
    - main*
    - release/*
    - feature/*
    - internal/release/*
  paths:
    include:
      - '*'
    exclude:
      - '**.md'
      - eng/Version.Details.xml
      - .github/*
      - docs/*
      - LICENSE.TXT
      - PATENTS.TXT
      - THIRD-PARTY-NOTICES.TXT

variables:
  - template: /eng/pipelines/common-variables.yml@self
  - template: /eng/common/templates-official/variables/pool-providers.yml@self

  # Variable group containing VscePublishToken for VS Code Marketplace publishing
  - ${{ if eq(parameters.publishVSCodeExtension, true) }}:
    - group: Aspire-Release-Secrets

  - name: _BuildConfig
    value: Release
  - name: Build.Arcade.ArtifactsPath
    value: $(Build.SourcesDirectory)/artifacts/
  - name: Build.Arcade.LogsPath
    value: $(Build.Arcade.ArtifactsPath)log/$(_BuildConfig)/
  - name: Build.Arcade.TestResultsPath
    value: $(Build.Arcade.ArtifactsPath)TestResults/$(_BuildConfig)/

  # Produce test-signed build for PR and Public builds
  - ${{ if or(eq(variables['_RunAsPublic'], 'true'), eq(variables['Build.Reason'], 'PullRequest')) }}:
    # needed for darc (dependency flow) publishing
    - name: _PublishArgs
      value: ''
    - name: _OfficialBuildIdArgs
      value: ''
    # needed for signing
    - name: _SignType
      value: test
    - name: _SignArgs
      value: ''
    - name: _Sign
      value: false

  # Set up non-PR build from internal project
  - ${{ if and(ne(variables['_RunAsPublic'], 'true'), ne(variables['Build.Reason'], 'PullRequest')) }}:
    # needed for darc (dependency flow) publishing
    - name: _PublishArgs
      value: >-
            /p:DotNetPublishUsingPipelines=true
    - name: _OfficialBuildIdArgs
      value: /p:OfficialBuildId=$(BUILD.BUILDNUMBER)
    # needed for signing
    - name: _SignType
      value: real
    - name: _SignArgs
      value: /p:DotNetSignType=$(_SignType) /p:TeamName=$(_TeamName) /p:Sign=$(_Sign) /p:DotNetPublishUsingPipelines=true
    - name: _Sign
      value: true

resources:
  repositories:
  - repository: 1ESPipelineTemplates
    type: git
    name: 1ESPipelineTemplates/1ESPipelineTemplates
    ref: refs/tags/release

extends:
  template: v1/1ES.Official.PipelineTemplate.yml@1ESPipelineTemplates
  parameters:
    settings:
      networkIsolationPolicy: Permissive,CFSClean2
    featureFlags:
      autoEnablePREfastWithNewRuleset: false
      autoEnableRoslynWithNewRuleset: false
    sdl:
      componentgovernance:
        # Exclude .packages folder from CG scanning. This folder contains older versions of our own
        # packages restored for API compatibility validation, which may have since-fixed vulnerabilities.
        ignoreDirectories: $(Build.SourcesDirectory)/.packages
      policheck:
        enabled: true
        exclusionsFile: $(Build.SourcesDirectory)\.config\PoliCheckExclusions.xml
      eslint:
        enabled: false
        justificationForDisabling: 'see https://portal.microsofticm.com/imp/v3/incidents/incident/482258316/summary'
      sourceAnalysisPool:
        name: NetCore1ESPool-Internal
        image: windows.vs2026preview.scout.amd64
        os: windows
      tsa:
        enabled: true
    customBuildTags:
    - ES365AIMigrationTooling
    containers:
      linux_x64:
        image: mcr.microsoft.com/dotnet-buildtools/prereqs:azurelinux-3.0-net10.0-cross-amd64
        env:
          SysRoot: /crossrootfs/x64
          LinkerFlavor: lld
      linux_arm64:
        image: mcr.microsoft.com/dotnet-buildtools/prereqs:azurelinux-3.0-net10.0-cross-arm64
        env:
          SysRoot: /crossrootfs/arm64
          LinkerFlavor: lld
      linux_musl_x64:
        image: mcr.microsoft.com/dotnet-buildtools/prereqs:azurelinux-3.0-net10.0-cross-amd64-musl
        env:
          SysRoot: /crossrootfs/x64
          LinkerFlavor: lld

    stages:

    - stage: build_sign_native
      displayName: Build+Sign native packages

      jobs:
      - template: /eng/pipelines/templates/build_sign_native.yml@self
        parameters:
          agentOs: macos
          targetRidsForSameOS:
            - osx-arm64
            - osx-x64
          codeSign: true
          teamName: $(_TeamName)
          extraBuildArgs: >-
            /p:Configuration=$(_BuildConfig)
            $(_SignArgs)
            $(_OfficialBuildIdArgs)

      - template: /eng/pipelines/templates/build_sign_native.yml@self
        parameters:
          agentOs: linux
          targetRidsForSameOS:
            - linux-x64
            - linux-arm64
            - linux-musl-x64
          # no need to sign ELF binaries on linux
          codeSign: false
          teamName: $(_TeamName)
          extraBuildArgs: >-
            /p:Configuration=$(_BuildConfig)
            $(_SignArgs)
            $(_OfficialBuildIdArgs)

    # ----------------------------------------------------------------
    # This stage performs build, test, packaging
    # ----------------------------------------------------------------
    - stage: build
      displayName: Build
      dependsOn:
      - build_sign_native
      jobs:
      - template: /eng/common/templates-official/jobs/jobs.yml@self
        parameters:
          enableMicrobuild: true
          # Publish NuGet packages using v3
          # https://github.com/dotnet/arcade/blob/main/Documentation/CorePackages/Publishing.md#basic-onboarding-scenario-for-new-repositories-to-the-current-publishing-version-v3
          enablePublishUsingPipelines: true
          enablePublishBuildAssets: true
          enableTelemetry: true
          enableSourceIndex: ${{ eq(variables['Build.SourceBranch'], 'refs/heads/main') }}
          publishAssetsImmediately: true
          # Publish build logs
          enablePublishBuildArtifacts: true
          # Publish test logs
          enablePublishTestResults: true
          workspace:
            clean: all

          jobs:

          - job: Windows
            ${{ if or(startswith(variables['Build.SourceBranch'], 'refs/heads/release/'), startswith(variables['Build.SourceBranch'], 'refs/heads/internal/release/'), eq(variables['Build.Reason'], 'Manual')) }}:
              # If the build is getting signed, then the timeout should be increased.
              timeoutInMinutes: 120
            ${{ else }}:
              # timeout accounts for wait times for helix agents up to 30mins
              timeoutInMinutes: 90

            pool:
              name: NetCore1ESPool-Internal
              image: windows.vs2026preview.scout.amd64
              os: windows

            variables:
              - name: _buildScript
                value: $(Build.SourcesDirectory)/build.cmd -ci

            preSteps:
              - checkout: self
                fetchDepth: 1

            steps:
              - task: DownloadPipelineArtifact@2
                displayName: ðŸŸ£Download All Native Archives
                inputs:
                  itemPattern: |
                    **/aspire-cli-*.zip
                    **/aspire-cli-*.tar.gz
                  targetPath: '$(Build.SourcesDirectory)/artifacts/packages/$(_BuildConfig)'

              - task: PowerShell@2
                displayName: ðŸŸ£List artifacts packages contents
                inputs:
                  targetType: 'inline'
                  script: |
                    Get-ChildItem -Path "$(Build.SourcesDirectory)\artifacts\packages" -File -Recurse | Select-Object FullName, @{Name="Size(MB)";Expression={[math]::Round($_.Length/1MB,2)}} | Format-Table -AutoSize

              - task: NodeTool@0
                displayName: ðŸŸ£Install node.js
                inputs:
                  versionSpec: '20.x'

              - task: npmAuthenticate@0
                displayName: ðŸŸ£NPM authenticate
                inputs:
                  workingFile: $(Build.SourcesDirectory)\.npmrc

              - task: PowerShell@2
                displayName: ðŸŸ£Set .npmrc environment
                inputs:
                  targetType: 'inline'
                  script: Write-Host "##vso[task.setvariable variable=NPM_CONFIG_USERCONFIG]$(Build.SourcesDirectory)\.npmrc"

              - task: PowerShell@2
                displayName: ðŸŸ£Install yarn
                inputs:
                  targetType: 'inline'
                  script: |
                    npm install -g yarn@1.22.22
                    yarn --version
                  workingDirectory: '$(Build.SourcesDirectory)'

              - task: PowerShell@2
                displayName: ðŸŸ£Install vsce
                inputs:
                  targetType: 'inline'
                  script: |
                    npm install -g @vscode/vsce@3.7.1
                    vsce --version
                  workingDirectory: '$(Build.SourcesDirectory)'

              - template: /eng/pipelines/templates/BuildAndTest.yml
                parameters:
                  dotnetScript: $(Build.SourcesDirectory)/dotnet.cmd
                  buildScript: $(_buildScript)
                  buildConfig: $(_BuildConfig)
                  repoArtifactsPath: $(Build.Arcade.ArtifactsPath)
                  repoLogPath: $(Build.Arcade.LogsPath)
                  repoTestResultsPath: $(Build.Arcade.TestResultsPath)
                  isWindows: true
                  targetRids:
                    - win-x64
                    - win-arm64
                  publishVSCodeExtension: ${{ parameters.publishVSCodeExtension }}
                  vscePublishToken: $(VscePublishToken)
                  vscePublishPreRelease: ${{ parameters.vscePublishPreRelease }}

              # Extract the Aspire version from a generated nupkg filename so downstream
              # stages (e.g. publish_winget) can use it. We use Aspire.Hosting.Docker
              # because it has no RID in its filename, so stripping the prefix cleanly
              # yields just the version (e.g. "13.2.0-preview.1.26074.3").
              - pwsh: |
                  $ErrorActionPreference = 'Stop'
                  $shippingDir = "$(Build.SourcesDirectory)/artifacts/packages/$(_BuildConfig)/Shipping"
                  $nupkg = Get-ChildItem -Path $shippingDir -Filter "Aspire.Hosting.Docker.*.nupkg" -ErrorAction SilentlyContinue |
                    Where-Object { $_.Name -notmatch '\.symbols\.' } |
                    Select-Object -First 1

                  if (-not $nupkg) {
                    Write-Error "Could not find Aspire.Hosting.Docker nupkg in $shippingDir"
                    exit 1
                  }

                  # Extract version: strip the known prefix and .nupkg suffix
                  $version = $nupkg.Name -replace '^Aspire\.Hosting\.Docker\.', '' -replace '\.nupkg$', ''

                  if ($version -notmatch '^\d+\.\d+\.\d+') {
                    Write-Error "Extracted version '$version' does not look like a valid semver. Check the nupkg name."
                    exit 1
                  }

                  Write-Host "Detected Aspire version: $version (from $($nupkg.Name))"
                  Write-Host "##vso[task.setvariable variable=aspireVersion;isOutput=true]$version"
                name: computeVersion
                displayName: ðŸŸ£Compute Aspire version from nupkg

              # Determine stable vs prerelease for installer pipelines (WinGet, Homebrew).
              # DotNetFinalVersionKind is 'release' for stable builds, empty otherwise.
              - pwsh: |
                  $ErrorActionPreference = 'Stop'
                  $versionKind = dotnet msbuild "$(Build.SourcesDirectory)/eng/Versions.props" -getProperty:DotNetFinalVersionKind
                  $versionKind = $versionKind.Trim()
                  Write-Host "DotNetFinalVersionKind: '$versionKind'"

                  if ($versionKind -eq 'release') {
                    $channel = 'stable'
                  } else {
                    $channel = 'prerelease'
                  }

                  Write-Host "Installer channel: $channel"
                  Write-Host "##vso[task.setvariable variable=installerChannel;isOutput=true]$channel"
                name: computeChannel
                displayName: ðŸŸ£Determine installer channel

      - ${{ if and(notin(variables['Build.Reason'], 'PullRequest'), eq(variables['Build.SourceBranch'], 'refs/heads/main')) }}:
        - template: /eng/common/templates-official/job/onelocbuild.yml@self
          parameters:
            LclSource: lclFilesfromPackage
            LclPackageId: 'LCL-JUNO-PROD-ASPIRE'
            MirrorRepo: aspire
            MirrorBranch: main

    # ----------------------------------------------------------------
    # Generate and test installer packages (WinGet + Homebrew).
    # Channel (stable/prerelease) is determined by the build stage.
    # Artifacts are consumed by release-publish-nuget.yml for stable
    # publishing. No publishing happens from this pipeline.
    # ----------------------------------------------------------------
    - stage: prepare_installers
      displayName: Prepare Installers
      dependsOn:
        - build
      variables:
        aspireVersion: $[ stageDependencies.build.Windows.outputs['computeVersion.aspireVersion'] ]
        installerChannel: $[ stageDependencies.build.Windows.outputs['computeChannel.installerChannel'] ]
      condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))
      jobs:
      - template: /eng/common/templates-official/jobs/jobs.yml@self
        parameters:
          enableMicrobuild: false
          enablePublishUsingPipelines: false
          enablePublishBuildAssets: false
          enablePublishBuildArtifacts: true
          enableTelemetry: true
          workspace:
            clean: all
          jobs:
          - job: WinGet
            displayName: WinGet Manifest
            timeoutInMinutes: 30
            pool:
              name: NetCore1ESPool-Internal
              image: 1es-windows-2022
              os: windows
            steps:
            - checkout: self
              fetchDepth: 1
            - template: /eng/pipelines/templates/prepare-winget-manifest.yml@self
              parameters:
                version: $(aspireVersion)
                channel: $(installerChannel)

          - job: Homebrew
            displayName: Homebrew Cask
            timeoutInMinutes: 30
            pool:
              name: Azure Pipelines
              vmImage: macOS-latest-internal
              os: macOS
            steps:
            - checkout: self
              fetchDepth: 1
            - template: /eng/pipelines/templates/prepare-homebrew-cask.yml@self
              parameters:
                version: $(aspireVersion)
                channel: $(installerChannel)
